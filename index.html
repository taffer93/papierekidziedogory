<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Koszulki – panel (pełna wersja + finanse + rozmiary)</title>

  <style>
    :root {
      --bg:#141c26;
      --card:#1a2635;
      --muted:#9fb2c7;
      --text:#f1f6ff;
      --accent:#4cc9f0;
      --line:#2d4056;
      --st-new:    rgba(90,245,140,.70);
      --st-prog:   rgba(255,210,90,.78);
      --st-ready:  rgba(120,235,255,.72);
      --st-sent:   rgba(130,170,255,.72);
      --st-return: rgba(255,110,110,.82);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text)}
    header{padding:16px 20px;border-bottom:1px solid #243344;display:flex;justify-content:space-between;align-items:center;gap:10px}
    h1{font-size:18px;margin:0} .muted{color:var(--muted)}
    .wrap{max-width:1200px;margin:0 auto;padding:16px}
    .card{background:var(--card);border:1px solid #203145;border-radius:12px;padding:14px;margin-bottom:14px}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .row.center{align-items:center}
    .col{flex:1 1 220px;min-width:220px}
    input,select,button,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid #2a3a4d;background:#0f1823;color:var(--text)}
    button{cursor:pointer;background:#19344b;border-color:#274d6a}
    button.primary{background:linear-gradient(180deg,#2a87b9,#1b5f86);border-color:#1b5f86;font-weight:600}
    button.ghost{background:#0f1823;border-color:#2a3a4d}
    .mini-btn{padding:6px 10px;border-radius:8px}
    nav.tabs{display:flex;gap:8px;margin:10px 0 14px 0;flex-wrap:wrap}
    nav.tabs button{flex:0 0 auto;padding:8px 12px;border-radius:10px}
    nav.tabs button.active{outline:2px solid var(--accent)}
    table{width:100%;border-collapse:separate;border-spacing:0;font-size:14px}
    th,td{border-bottom:1px solid #233244;padding:8px 6px;text-align:left;vertical-align:middle;border-right:1px solid var(--line)}
    th:last-child, td:last-child{border-right:none}
    th{background:#1d2a3a}
    tr:hover td{filter:brightness(1.03)}
    th.statusCol, td.statusCol { min-width:200px; width:200px; white-space:nowrap; }
    @media (max-width:900px){ th.statusCol,td.statusCol{min-width:180px;width:180px} td.statusCol select{min-width:180px} }
    tr.st-new   td{background-color:var(--st-new)}
    tr.st-prog  td{background-color:var(--st-prog)}
    tr.st-ready td{background-color:var(--st-ready)}
    tr.st-sent  td{background-color:var(--st-sent)}
    tr.st-ret   td{background-color:var(--st-return)}
    tr.toneA td{background-image:linear-gradient(rgba(255,255,255,.03),rgba(255,255,255,.03))}
    tr.toneB td{background-image:linear-gradient(rgba(0,0,0,.03),rgba(0,0,0,.03))}
    .toolbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:10px}
    .right{margin-left:auto}
    .hint{font-size:12px;color:var(--muted)}
    .pill{padding:6px 10px;border-radius:99px;background:#0f1823;border:1px solid #2a3a4d}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:10px}
    .design-card{border:1px solid #2a3a4d;border-radius:12px;padding:10px;cursor:pointer;background:#0f1823;text-align:center}
    .design-img{width:100%;height:110px;object-fit:cover;border-radius:10px;border:1px solid #2a3a4d;background:#0b1118}
    .design-name{margin-top:8px;font-weight:600}
    .add-header{display:flex;align-items:center;gap:10px;margin-bottom:10px}
    .add-header .right{display:flex;gap:10px;margin-left:auto}
    .rows-wrap{overflow:auto}
    .rows-table thead th{position:sticky;top:0;background:#1d2a4a;z-index:1}
    .rows-table td .thumb{width:48px;height:48px;object-fit:cover;border-radius:6px;border:1px solid #2a3a4d;background:#0b1118}
    .rows-actions{display:flex;gap:6px}
    .date-compact{display:flex;gap:8px;align-items:center}
    .date-compact .small{max-width:90px;padding:8px}
    .date-compact .month{max-width:180px;padding:8px}
    input[type=number]::-webkit-outer-spin-button,
    input[type=number]::-webkit-inner-spin-button{ -webkit-appearance:none; margin:0;}
    input[type=number]{ -moz-appearance:textfield;}
    input[type="file"]{padding:8px;background:#0f1823;border:1px solid #2a3a4d;color:var(--muted)}
    input[type="file"]::file-selector-button{margin-right:10px;border:1px solid #274d6a;background:#19344b;color:#fff;padding:6px 10px;border-radius:8px;cursor:pointer}
    .designCell{display:flex;align-items:center;gap:8px}
    .designThumb{width:48px;height:48px;object-fit:cover;border-radius:6px;border:1px solid #2a3a4d;background:#0b1118}
    .colorTag{display:inline-flex;align-items:center;gap:6px;border:1px solid #2a3a4d;border-radius:999px;padding:2px 8px;background:#0f1823}
    .dot{width:12px;height:12px;border-radius:50%;border:1px solid #2a3a4d;background:#fff}
    .dot.black{background:#000}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:1000}
    .modal .panel{background:var(--card);border:1px solid #203145;border-radius:12px;width:min(1000px,94vw);max-height:88vh;padding:14px;display:flex;flex-direction:column}
    .modal .panel .head{display:flex;gap:10px;align-items:center;margin-bottom:10px}
    .modal .panel .head .right{margin-left:auto}
    .scroll{overflow:auto;flex:1 1 auto;min-height:0}
    .danger{color:#ff6b6b}
    .neg{color:#ff9e9e}
    .bold{font-weight:700}
    .small{font-size:12px}
    .controls{display:flex;gap:8px;align-items:center}

    /* charts layout: prevent overlap and set uniform heights */
    .chart-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    .chart-card{background:var(--card);border:1px solid #203145;border-radius:12px;padding:12px;display:flex;flex-direction:column}
    .chart-card h4{margin:0 0 8px 0}
    .chart-canvas{flex:1;min-height:240px;max-height:380px;width:100%}
    @media (max-width:900px){ .chart-grid{grid-template-columns:1fr} .chart-canvas{min-height:220px} }

    /* ensure adv detail table appears lower (not overlapping charts) */
    #advDetailWrap{margin-top:16px}

    /* small helpers */
    .kpi{display:inline-block;padding:8px 12px;border-radius:10px;background:#0f1823;border:1px solid #213145;margin-right:8px}
  </style>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>

<body>
  <header>
    <h1>Koszulki – panel (pełna wersja + finanse + rozmiary)</h1>
  </header>

  <div class="wrap">
    <!-- LOGIN -->
    <div id="loginCard" class="card" style="max-width:520px;">
      <h3>Zaloguj się</h3>
      <div class="row center">
        <div class="col"><input id="email" type="email" placeholder="Email" /></div>
        <div class="col"><input id="password" type="password" placeholder="Hasło" /></div>
      </div>
      <div class="row center" style="margin-top:8px">
        <div class="col"><button id="loginBtn" class="primary">Zaloguj</button></div>
        <div class="col"><div id="loginMsg" class="hint"></div></div>
      </div>
    </div>

    <!-- APP -->
    <div id="app" style="display:none">
      <nav class="tabs">
        <button data-tab="orders" class="active">Zamówienia</button>
        <button data-tab="add">Dodaj zamówienie</button>
        <button data-tab="designs">Wzory</button>
        <button data-tab="expenses">Koszty</button>
        <button data-tab="stats">Statystyki</button>
        <button data-tab="advstats">Zaawansowane statystyki</button>
      </nav>

      <!-- ORDERS TAB -->
      <div id="tab-orders" class="card">
        <div class="toolbar">
          <div>
            <label class="mini">Miesiąc i rok</label>
            <div class="row center" style="gap:6px">
              <select id="ordersMonth" class="month" style="max-width:180px"></select>
              <select id="ordersYear" style="max-width:120px"></select>
            </div>
          </div>
          <div>
            <label class="mini">Status (widok)</label>
            <select id="filterStatus">
              <option value="ALL">Wszystkie</option>
              <option value="ZAMÓWIENIE PRZYJĘTE">ZAMÓWIENIE PRZYJĘTE</option>
              <option value="W TRAKCIE REALIZACJI">W TRAKCIE REALIZACJI</option>
              <option value="GOTOWE DO WYSYŁKI">GOTOWE DO WYSYŁKI</option>
              <option value="WYSŁANE">WYSŁANE</option>
              <option value="ZWROT">ZWROT</option>
            </select>
          </div>
          <div class="row center" style="gap:6px">
            <button id="exportItemsBtn" class="ghost mini-btn">Eksport CSV (pozycje)</button>
            <button id="exportGroupsBtn" class="ghost mini-btn">Eksport CSV (zamówienia)</button>
          </div>
          <div class="right pill">
            Zamówienia: <b id="ordersCount">0</b> •
            Przychody: <b id="sumRevenue">0.00</b> zł •
            Koszty: <b id="sumExpenses">0.00</b> zł •
            Wynik: <b id="sumNet">0.00</b> zł
          </div>
        </div>

        <div style="overflow:auto">
          <table>
            <thead>
              <tr>
                <th>Data</th>
                <th class="statusCol">Status</th>
                <th>Rozmiar</th>
                <th>Kolor</th>
                <th>Wzór</th>
                <th>Zamawiający</th>
                <th>Uwagi</th>
                <th>Cena (łącznie)</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="ordersTbody"></tbody>
          </table>
        </div>
        <div class="hint">Status i klient tylko raz na zamówienie (pierwszy wiersz). ZWROT nie liczy się do przychodów.</div>
      </div>

      <!-- ADD ORDER TAB -->
      <div id="tab-add" class="card" style="display:none">
        <div class="add-header">
          <h3 style="margin:0">Dodaj zamówienie</h3>
          <div class="right">
            <button id="addRowBtn" class="ghost">+ Dodaj pozycję</button>
            <button id="clearOrderBtn" class="ghost">Wyczyść</button>
            <button id="saveOrderBtn" class="primary">Zapisz wszystkie pozycje</button>
          </div>
        </div>

        <div class="card" style="margin:0 0 10px 0">
          <h4 style="margin:0 0 8px 0">Dane zamówienia</h4>
          <div class="row center">
            <div class="date-compact">
              <div class="col" style="min-width:auto;flex:0 0 auto">
                <label class="mini">Dzień</label>
                <input id="addDay" class="small" type="number" min="1" max="31" />
              </div>
              <div class="col" style="min-width:auto;flex:0 0 auto">
                <label class="mini">Miesiąc</label>
                <select id="addMonth" class="month"></select>
              </div>
              <div class="col" style="min-width:auto;flex:0 0 auto">
                <label class="mini">Rok</label>
                <select id="addYear" class="small"></select>
              </div>
            </div>

            <div class="col">
              <label class="mini">Zamawiający (login/imię)</label>
              <input id="orderCustomer" type="text" />
            </div>
            <div class="col">
              <label class="mini">Cena łączna zamówienia (PLN)</label>
              <input id="orderTotalPrice" type="number" step="0.01" placeholder="np. 210" />
            </div>
          </div>
        </div>

        <div class="card" style="margin:0">
          <h4 style="margin:0 0 8px 0">Pozycje</h4>
          <div class="rows-wrap">
            <table class="rows-table" style="width:100%">
              <thead>
                <tr>
                  <th style="width:35%">Wzór</th>
                  <th style="width:10%">Rozmiar</th>
                  <th style="width:12%">Kolor</th>
                  <th>Uwagi</th>
                  <th style="width:120px"></th>
                </tr>
              </thead>
              <tbody id="rowsTbody"></tbody>
            </table>
          </div>
        </div>

        <div id="saveMsg" class="hint" style="margin-top:8px"></div>
      </div>

      <!-- DESIGNS TAB -->
      <div id="tab-designs" class="card" style="display:none">
        <h3>Wzory (z podglądem)</h3>
        <div class="row center">
          <div class="col"><input id="designName" placeholder="Nazwa wzoru, np. kitty red bull blue" /></div>
          <div class="col"><input id="designFile" type="file" accept="image/*" /></div>
          <div class="col" style="max-width:220px"><button id="addDesignBtn" class="primary">Dodaj wzór</button></div>
        </div>
        <div id="designMsg" class="hint" style="margin:6px 0 10px 0"></div>
        <div id="designsList" class="grid" style="margin-top:10px"></div>
      </div>

      <!-- EXPENSES TAB -->
      <div id="tab-expenses" class="card" style="display:none">
        <div class="toolbar">
          <div>
            <label class="mini">Miesiąc i rok</label>
            <div class="row center" style="gap:6px">
              <select id="expMonth" class="month" style="max-width:180px"></select>
              <select id="expYear" style="max-width:120px"></select>
            </div>
          </div>
          <div class="row center" style="gap:6px">
            <button id="exportExpBtn" class="ghost mini-btn">Eksport CSV</button>
          </div>
          <div class="right pill">Koszty (m-c): <b id="sumExpensesTop">0.00</b> zł</div>
        </div>

        <div class="card" style="margin:0 0 10px 0">
          <h4 style="margin:0 0 8px 0">Dodaj koszt</h4>
          <div class="row center">
            <div class="col"><input id="expName" placeholder="Nazwa kosztu, np. zakup koszulek S/M" /></div>
            <div class="col" style="max-width:220px"><input id="expAmount" type="number" step="0.01" placeholder="Kwota, np. 150.00" /></div>
            <div class="col" style="max-width:120px"><input id="expDay" type="number" min="1" max="31" placeholder="Dzień" /></div>
            <div class="col"><input id="expNote" placeholder="Uwagi (opcjonalnie)" /></div>
            <div class="col" style="max-width:220px"><button id="addExpenseBtn" class="primary">Dodaj</button></div>
          </div>
          <div id="expMsg" class="hint" style="margin-top:6px"></div>
        </div>

        <div style="overflow:auto">
          <table>
            <thead>
              <tr>
                <th>Data</th>
                <th>Nazwa</th>
                <th>Uwagi</th>
                <th>Kwota</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="expTbody"></tbody>
          </table>
        </div>
      </div>

      <!-- STATS TAB -->
      <div id="tab-stats" class="card" style="display:none">
        <div class="toolbar">
          <div>
            <label class="mini">Miesiąc i rok</label>
            <div class="row center" style="gap:6px">
              <select id="statsMonth" class="month" style="max-width:180px"></select>
              <select id="statsYear" style="max-width:120px"></select>
            </div>
          </div>
          <div class="right pill">Ranking wzorów (liczba pozycji; bez ZWROT)</div>
        </div>
        <div style="overflow:auto">
          <table>
            <thead><tr><th>#</th><th>Wzór</th><th>Ilość zamówień</th></tr></thead>
            <tbody id="statsTbody"></tbody>
          </table>
        </div>
      </div>

      <!-- ADVANCED STATS TAB (rozszerzona) -->
      <div id="tab-advstats" class="card" style="display:none">
        <div class="toolbar">
          <div>
            <label class="mini">Zakres</label>
            <div class="controls">
              <select id="advPeriod" class="small">
                <option value="week">Tydzień</option>
                <option value="month" selected>Miesiąc</option>
                <option value="year">Rok</option>
                <option value="all">Całość</option>
              </select>
              <select id="advAnchorMonth" class="month" style="max-width:180px"></select>
              <select id="advAnchorYear" class="year" style="max-width:120px"></select>
            </div>
          </div>
          <div style="display:flex;gap:8px;align-items:center">
            <label class="mini">Uwzględniaj zwroty</label>
            <input id="advIncludeReturns" type="checkbox" style="width:auto;margin-left:6px" />
          </div>
          <div class="right pill">Przychody: <b id="advRevenue">0.00</b> zł • Koszty: <b id="advCosts">0.00</b> zł • Zysk: <b id="advNet">0.00</b> zł</div>
        </div>

        <!-- top KPIs -->
        <div class="card" style="padding:10px;margin-bottom:12px">
          <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap">
            <div class="kpi">AOV: <b id="advAOV">0.00</b> zł</div>
            <div class="kpi">Zwroty (%): <b id="advReturnsPct">0%</b></div>
            <div class="kpi">Marża (śr): <b id="advAvgMargin">0%</b></div>
          </div>
        </div>

        <!-- charts grid -->
        <div class="chart-grid">
          <div class="chart-card">
            <h4>Przychody / Koszty / Zysk (wg czasu)</h4>
            <canvas id="chartFinances" class="chart-canvas"></canvas>
          </div>

          <div class="chart-card">
            <h4>Struktura kosztów (%)</h4>
            <canvas id="chartCostBreakdown" class="chart-canvas"></canvas>
          </div>

          <div class="chart-card">
            <h4>Marża netto (%)</h4>
            <canvas id="chartMargin" class="chart-canvas"></canvas>
          </div>

          <div class="chart-card">
            <h4>Zysk netto skumulowany</h4>
            <canvas id="chartCumNet" class="chart-canvas"></canvas>
          </div>

          <div class="chart-card">
            <h4>Udział zwrotów (%)</h4>
            <canvas id="chartReturnsPct" class="chart-canvas"></canvas>
          </div>

          <div class="chart-card">
            <h4>Top wzorów (sprzedaż)</h4>
            <canvas id="chartTopDesigns" class="chart-canvas"></canvas>
          </div>
        </div>

        <!-- Rozmiary: tabelarycznie + wykres -->
        <div style="margin-top:14px" class="card">
          <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
            <h4 style="margin:0">Rozmiary — spis</h4>
            <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
              <label class="mini">Zakres</label>
              <select id="sizePeriod" class="small">
                <option value="day">Dzień</option>
                <option value="week" selected>Tydzień</option>
                <option value="month">Miesiąc</option>
                <option value="year">Rok</option>
                <option value="all">Całość</option>
              </select>
              <label class="mini">Uwzględniaj zwroty</label><input id="sizeIncludeReturns" type="checkbox" />
            </div>
          </div>

          <div class="chart-grid" style="margin-top:10px">
            <div class="chart-card">
              <h4>Wykres rozmiarów</h4>
              <canvas id="chartSizes" class="chart-canvas"></canvas>
            </div>
            <div class="chart-card">
              <h4>Top wzorów (tabela)</h4>
              <div style="overflow:auto;max-height:340px">
                <table><thead><tr><th>Wzór</th><th>Ilość</th></tr></thead><tbody id="advTopDesignsTbody"></tbody></table>
              </div>
            </div>
          </div>

          <div style="margin-top:12px">
            <h4>Spis rozmiarów (tabela)</h4>
            <div style="overflow:auto;max-height:260px">
              <table><thead><tr><th>Okres</th><th>Rozmiar</th><th>Ilość</th></tr></thead><tbody id="advSizeTbody"></tbody></table>
            </div>
          </div>
        </div>

        <!-- financial details — moved lower so it doesn't overlap -->
        <div id="advDetailWrap" class="card">
          <h4>Tablica (szczegóły finansowe)</h4>
          <div style="overflow:auto;max-height:240px">
            <table><thead><tr><th>Typ</th><th>Klucz</th><th>Wartość</th></tr></thead><tbody id="advDetailTbody"></tbody></table>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- modals (picker, edit) kept as before -->
  <div id="designPicker" class="modal">
    <div class="panel">
      <div class="head">
        <strong>Wybierz wzór</strong>
        <div class="right"><button id="pickerClose" class="ghost mini-btn">Zamknij</button></div>
      </div>
      <div class="row center">
        <div class="col"><input id="pickerSearch" placeholder="Szukaj wzoru po nazwie..." /></div>
        <div class="col">
          <label class="mini">Albo wgraj CUSTOM dla tej pozycji</label>
          <input id="pickerCustomFile" type="file" accept="image/*" />
        </div>
      </div>
      <div id="pickerGridWrap" class="scroll" style="margin-top:10px">
        <div id="pickerGrid" class="grid"></div>
      </div>
      <div class="hint">Kliknij kafelek, aby przypisać wzór do tej pozycji. Wgranie pliku ustawi tę pozycję jako CUSTOM.</div>
    </div>
  </div>

  <div id="orderEdit" class="modal">
    <div class="panel">
      <div class="head">
        <strong>Edytuj zamówienie</strong>
        <div class="right">
          <button id="editAddRowBtn" class="ghost mini-btn">+ Pozycja</button>
          <button id="editCloseBtn" class="ghost mini-btn">Zamknij</button>
        </div>
      </div>
      <div class="card" style="margin:0 0 10px 0">
        <div class="row center">
          <div class="date-compact">
            <div class="col" style="min-width:auto;flex:0 0 auto">
              <label class="mini">Dzień</label>
              <input id="editDay" class="small" type="number" min="1" max="31" />
            </div>
            <div class="col" style="min-width:auto;flex:0 0 auto">
              <label class="mini">Miesiąc</label>
              <select id="editMonth" class="month"></select>
            </div>
            <div class="col" style="min-width:auto;flex:0 0 auto">
              <label class="mini">Rok</label>
              <select id="editYear" class="small"></select>
            </div>
          </div>
          <div class="col">
            <label class="mini">Zamawiający</label>
            <input id="editCustomer" type="text" />
          </div>
          <div class="col">
            <label class="mini">Cena łączna zamówienia (PLN)</label>
            <input id="editTotal" type="number" step="0.01" />
          </div>
        </div>
      </div>
      <div id="editRowsWrap" class="scroll">
        <table class="rows-table" style="width:100%">
          <thead><tr><th style="width:35%">Wzór</th><th style="width:10%">Rozmiar</th><th style="width:12%">Kolor</th><th>Uwagi</th><th style="width:120px"></th></tr></thead>
          <tbody id="editRowsTbody"></tbody>
        </table>
      </div>
      <div class="row" style="margin-top:8px">
        <div class="col"><div id="editMsg" class="hint"></div></div>
        <div class="col" style="max-width:220px"><button id="editSaveBtn" class="primary">Zapisz zmiany</button></div>
      </div>
    </div>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import {
    getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut,
    setPersistence, browserLocalPersistence
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import {
    getFirestore, collection, addDoc, doc, setDoc, updateDoc, deleteDoc,
    getDocs, query, where, onSnapshot, serverTimestamp, Timestamp, writeBatch
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  // === Firebase config (te same co wcześniej) ===
  const firebaseConfig = {
    apiKey: "AIzaSyCGNcCqcQdLoOnWFEI1a7XhAsQtj6ECvfg",
    authDomain: "papierek-idzie-do-gory.firebaseapp.com",
    projectId: "papierek-idzie-do-gory",
    storageBucket: "papierek-idzie-do-gory.firebasestorage.app",
    messagingSenderId: "1063966015801",
    appId: "1:1063966015801:web:72f412aa200a705276a8e8"
  };
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // helpers
  const $ = id => document.getElementById(id);
  const fmt2 = n => (Number(n||0)).toFixed(2);
  const numPL = n => fmt2(n).replace('.', ',');
  const monthsPL = ["styczeń","luty","marzec","kwiecień","maj","czerwiec","lipiec","sierpień","wrzesień","październik","listopad","grudzień"];
  const monthKey = (y,mIndex) => `${y}-${String(mIndex+1).padStart(2,"0")}`;
  const rowCls = s => s==="ZWROT"?"st-ret":s==="WYSŁANE"?"st-sent":s==="GOTOWE DO WYSYŁKI"?"st-ready":s==="W TRAKCIE REALIZACJI"?"st-prog":"st-new";
  const dShort = d => { const dt=d?.toDate?d.toDate():new Date(d); const dd=String(dt.getDate()).padStart(2,"0"); const mm=String(dt.getMonth()+1).padStart(2,"0"); const yy=dt.getFullYear(); return `${dd}.${mm}.${yy}`; };

  // UI refs
  const loginCard=$("loginCard"), appWrap=$("app"), loginBtn=$("loginBtn"), loginMsg=$("loginMsg"), logoutBtn=null;

  // state
  let designMap = new Map();
  let orderRows = [];
  let ordersGroupsAll = [];
  let expensesList = [];
  let revenueSumAll = 0;
  let expensesSumAll = 0;

  let unsubOrders=null, unsubExp=null, unsubStats=null, unsubDesigns=null;

  // charts
  let chartOrders=null, chartSizes=null, chartDesigns=null, chFinances=null, chCostBreakdown=null, chMargin=null, chCumNet=null, chReturns=null, chTopDesigns=null;

  // utility: create element for table row
  function trRow(k,v){ const tr=document.createElement('tr'); tr.innerHTML=`<td>Finanse</td><td>${k}</td><td>${v}</td>`; return tr; }

  // ===== AUTH =====
  loginBtn.onclick = async () => {
    loginMsg.textContent = "Logowanie…";
    try {
      await setPersistence(auth, browserLocalPersistence);
      await signInWithEmailAndPassword(auth, $("email").value, $("password").value);
      loginMsg.textContent = "";
    } catch (e) {
      console.error(e);
      loginMsg.textContent = "Błąd: " + (e.code || e.message);
    }
  };

  onAuthStateChanged(auth, u => {
    if (u) {
      loginCard.style.display = "none";
      appWrap.style.display = "";
      initApp();
    } else {
      loginCard.style.display = "";
      appWrap.style.display = "none";
    }
  });

  // ===== INIT APP (populate selects, handlers) =====
  async function initApp(){
    const now = new Date();
    const years = Array.from({length:9},(_,k)=>now.getFullYear()-4+k);
    const monthsHTML = monthsPL.map((m,i)=>`<option value="${i}">${m}</option>`).join("");
    const yearsHTML  = years.map(y=>`<option ${y===now.getFullYear()?"selected":""}>${y}</option>`).join("");

    $("ordersMonth").innerHTML = monthsHTML; $("ordersYear").innerHTML = yearsHTML; $("ordersMonth").value = String(now.getMonth());
    $("addMonth").innerHTML = monthsHTML; $("addYear").innerHTML = yearsHTML; $("addMonth").value=String(now.getMonth()); $("addYear").value=String(now.getFullYear()); $("addDay").value=String(now.getDate());
    $("expMonth").innerHTML = monthsHTML; $("expYear").innerHTML = yearsHTML; $("expMonth").value=String(now.getMonth()); $("expYear").value=String(now.getFullYear()); $("expDay").value=String(now.getDate());
    $("statsMonth").innerHTML = monthsHTML; $("statsYear").innerHTML = yearsHTML; $("statsMonth").value=String(now.getMonth()); $("statsYear").value=String(now.getFullYear());
    $("editMonth").innerHTML = monthsHTML; $("editYear").innerHTML = yearsHTML;

    $("advAnchorMonth").innerHTML = monthsHTML; $("advAnchorYear").innerHTML = yearsHTML; $("advAnchorMonth").value=String(now.getMonth()); $("advAnchorYear").value=String(now.getFullYear());

    // sizes period default
    $("sizePeriod").value = "week";

    // listeners and actions
    $("addDesignBtn").addEventListener("click", onAddDesign);
    $("addRowBtn").addEventListener("click", ()=>addRow());
    $("clearOrderBtn").addEventListener("click", clearOrderForm);
    $("saveOrderBtn").addEventListener("click", saveOrder);
    $("pickerClose").addEventListener("click", ()=>{ document.getElementById("designPicker").style.display="none"; });
    $("pickerSearch").addEventListener("input", renderPickerGrid);
    $("pickerCustomFile").addEventListener("change", onPickerCustom);
    $("addExpenseBtn").addEventListener("click", addExpense);
    $("editAddRowBtn").addEventListener("click", ()=>editAddRow());
    $("editCloseBtn").addEventListener("click", ()=>{ document.getElementById("orderEdit").style.display="none"; });

    $("exportItemsBtn").addEventListener("click", exportOrdersItemsCSV);
    $("exportGroupsBtn").addEventListener("click", exportOrdersGroupsCSV);
    $("exportExpBtn").addEventListener("click", exportExpensesCSV);

    document.querySelectorAll("nav.tabs button").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        document.querySelectorAll("nav.tabs button").forEach(b=>b.classList.remove("active"));
        btn.classList.add("active");
        document.querySelectorAll('[id^="tab-"]').forEach(t=>t.style.display="none");
        document.getElementById("tab-" + btn.dataset.tab).style.display = "";
        if(btn.dataset.tab==="advstats") renderAdvancedStats();
      });
    });

    // advanced stats controls
    $("advPeriod").addEventListener('change', renderAdvancedStats);
    $("advAnchorMonth").addEventListener('change', renderAdvancedStats);
    $("advAnchorYear").addEventListener('change', renderAdvancedStats);
    $("advIncludeReturns").addEventListener('change', renderAdvancedStats);
    $("sizePeriod").addEventListener('change', ()=>{ renderAdvancedStats(); renderSizeTable(); });
    $("sizeIncludeReturns").addEventListener('change', ()=>{ renderAdvancedStats(); renderSizeTable(); });

    // create charts placeholders
    createEmptyCharts();

    // start listeners to Firestore
    subscribeDesigns();
    subscribeOrders();
    subscribeExpenses();
    subscribeStats();
  }

  // ===== Designs =====
  async function subscribeDesigns(){
    if(unsubDesigns){unsubDesigns();}
    unsubDesigns = onSnapshot(query(collection(db,"designs")), snap=>{
      designMap.clear();
      snap.forEach(d=> designMap.set(d.id,{id:d.id,...d.data()}));
      renderDesignsList(); renderPickerGrid();
    }, err=>console.error(err));
  }

  function renderDesignsList(){
    const box=$("designsList"); box.innerHTML="";
    for(const d of Array.from(designMap.values()).sort((a,b)=>a.name.localeCompare(b.name,"pl"))){
      const card=document.createElement("div");
      card.className="design-card";
      card.innerHTML=`
        ${d.previewUrl?`<img class="design-img" src="${d.previewUrl}" alt="">`:`<div class="design-img" style="display:flex;align-items:center;justify-content:center;color:#6d8096">brak podglądu</div>`}
        <div class="design-name">${(d.name||"").replace(/</g,"&lt;")}</div>
        <div class="row center" style="margin-top:8px">
          <button class="ghost mini-btn" data-act="edit">Edytuj</button>
          <button class="ghost mini-btn danger" data-act="del">Usuń</button>
        </div>`;
      box.appendChild(card);
      card.querySelector('[data-act="edit"]').onclick=()=>openEditDesign(card,d);
      card.querySelector('[data-act="del"]').onclick=async()=>{ if(!confirm("Usunąć wzór?"))return; await deleteDoc(doc(db,"designs",d.id)); };
    }
  }

  function openEditDesign(card,d){
    card.innerHTML=`
      <div class="row center">
        <div class="col"><input value="${(d.name||"").replace(/"/g,'&quot;')}" data-role="name"/></div>
        <div class="col"><input type="file" accept="image/*" data-role="file"/></div>
      </div>
      <div class="row center" style="margin-top:8px">
        <button class="primary mini-btn" data-act="save">Zapisz</button>
        <button class="ghost mini-btn" data-act="cancel">Anuluj</button>
      </div>
      <div class="hint mini" data-role="msg"></div>`;
    card.querySelector('[data-act="cancel"]').onclick=renderDesignsList;
    card.querySelector('[data-act="save"]').onclick=async()=>{
      const name=card.querySelector('[data-role="name"]').value.trim();
      const file=card.querySelector('[data-role="file"]').files[0]||null;
      const msg=card.querySelector('[data-role="msg"]');
      if(!name){msg.textContent="Podaj nazwę.";return;}
      try{
        let previewUrl=d.previewUrl||null;
        if(file) previewUrl=await fileToDataUrl(file);
        await setDoc(doc(db,"designs",d.id),{name,previewUrl,updatedAt:serverTimestamp()},{merge:true});
        await subscribeDesigns(); // reload
      }catch(e){ msg.textContent="Błąd: "+(e.message||e.code); }
    };
  }

  async function onAddDesign(){
    const name=$("designName").value.trim();
    const file=$("designFile").files[0]||null;
    const out=$("designMsg");
    if(!name){out.textContent="Podaj nazwę wzoru.";return;}
    const id=name.toLowerCase().replace(/\s+/g,"-").replace(/[^a-z0-9\-]/g,"");
    try{
      let previewUrl=null; if(file) previewUrl=await fileToDataUrl(file);
      await setDoc(doc(db,"designs",id),{name,active:true,previewUrl,createdAt:serverTimestamp(),updatedAt:serverTimestamp()},{merge:true});
      $("designName").value=""; $("designFile").value=""; out.textContent="Dodano wzór ✅";
      await subscribeDesigns(); setTimeout(()=>out.textContent="",1200);
    }catch(e){ out.textContent="Błąd: "+(e.message||e.code); }
  }

  // ===== Picker =====
  let pickerContext="add", pickerRowIndex=null;
  function openPicker(i,ctx="add"){ pickerContext=ctx; pickerRowIndex=i; $("pickerCustomFile").value=""; $("pickerSearch").value=""; renderPickerGrid(); document.getElementById("designPicker").style.display="flex"; }
  function renderPickerGrid(){
    const grid=$("pickerGrid"); grid.innerHTML="";
    const term=($("pickerSearch").value||"").toLowerCase();
    const list=Array.from(designMap.values()).filter(d=>d.active!==false).filter(d=>term?d.name.toLowerCase().includes(term):true).sort((a,b)=>a.name.localeCompare(b.name,"pl"));
    for(const d of list){
      const card=document.createElement("div"); card.className="design-card";
      card.innerHTML=`
        ${d.previewUrl?`<img class="design-img" src="${d.previewUrl}" alt="">`:`<div class="design-img" style="display:flex;align-items:center;justify-content:center;color:#6d8096">brak podglądu</div>`}
        <div class="design-name">${(d.name||"").replace(/</g,"&lt;")}</div>`;
      card.onclick=()=>{
        const arr=(pickerContext==="edit")?editRows:orderRows;
        const r=arr[pickerRowIndex];
        r.designId=d.id; r.designName=d.name; r.previewUrl=d.previewUrl||null; r.customFile=null; r.customLocalUrl=null;
        (pickerContext==="edit")?renderEditRows():renderOrderRows();
        document.getElementById("designPicker").style.display="none"; pickerRowIndex=null;
      };
      grid.appendChild(card);
    }
  }
  async function onPickerCustom(e){
    const file=e.target.files[0]; if(!file||pickerRowIndex==null)return;
    const arr=(pickerContext==="edit")?editRows:orderRows; const r=arr[pickerRowIndex];
    r.designId="custom"; r.designName="CUSTOM"; r.customFile=file; r.customLocalUrl=URL.createObjectURL(file); r.previewUrl=r.customLocalUrl;
    (pickerContext==="edit")?renderEditRows():renderOrderRows();
    document.getElementById("designPicker").style.display="none"; pickerRowIndex=null;
  }

  // ===== Orders add/edit =====
  function defaultRow(){ return { size:"M", color:"BIAŁA", note:"", designId:null, designName:"", previewUrl:null, customFile:null, customLocalUrl:null }; }
  function addRow(){ orderRows.push(defaultRow()); renderOrderRows(); }
  function removeRow(i){ orderRows.splice(i,1); renderOrderRows(); if(orderRows.length===0) addRow(); }
  function renderOrderRows(){
    const tb=$("rowsTbody"); tb.innerHTML="";
    orderRows.forEach((r,i)=>{
      const tr=document.createElement("tr");
      tr.innerHTML=`
        <td>
          <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
            ${r.previewUrl?`<img class="thumb" src="${r.previewUrl}" alt="">`:`<div class="thumb" style="display:flex;align-items:center;justify-content:center;color:#6d8096">?</div>`}
            <div style="min-width:180px"><b>${(r.designName||"Nie wybrano").replace(/</g,"&lt;")}</b></div>
            <div class="rows-actions">
              <button class="ghost mini-btn" data-act="pick">Wybierz wzór</button>
              <label class="ghost mini-btn" style="display:inline-flex;align-items:center;gap:6px;cursor:pointer">
                <input data-act="custom" type="file" accept="image/*" style="display:none"> Upload CUSTOM
              </label>
            </div>
          </div>
        </td>
        <td><select data-act="size">${["S","M","L","XL","XXL","3XL"].map(s=>`<option ${r.size===s?"selected":""}>${s}</option>`).join("")}</select></td>
        <td><select data-act="color">${["BIAŁA","CZARNA"].map(c=>`<option ${r.color===c?"selected":""}>${c}</option>`).join("")}</select></td>
        <td><input data-act="note" type="text" value="${(r.note||"").replace(/"/g,'&quot;')}" placeholder="Uwagi do tej pozycji"></td>
        <td class="rows-actions"><button class="ghost mini-btn danger" data-act="remove">Usuń</button></td>`;
      tr.querySelector('[data-act="pick"]').onclick=()=>openPicker(i,"add");
      tr.querySelector('[data-act="remove"]').onclick=()=>removeRow(i);
      tr.querySelector('[data-act="size"]').onchange=e=>r.size=e.target.value;
      tr.querySelector('[data-act="color"]').onchange=e=>r.color=e.target.value;
      tr.querySelector('[data-act="note"]').oninput=e=>r.note=e.target.value;
      tr.querySelector('[data-act="custom"]').onchange=e=>{ const f=e.target.files[0]; if(!f)return; r.designId="custom"; r.designName="CUSTOM"; r.customFile=f; r.customLocalUrl=URL.createObjectURL(f); r.previewUrl=r.customLocalUrl; renderOrderRows(); };
      tb.appendChild(tr);
    });
  }
  function clearOrderForm(){ orderRows=[]; addRow(); $("orderCustomer").value=""; $("orderTotalPrice").value=""; $("saveMsg").textContent=""; }

  function buildDate(daySel,monthSel,yearSel){
    const d=Number($(daySel).value||1), m=Number($(monthSel).value||0), y=Number($(yearSel).value||new Date().getFullYear());
    return new Date(y,m,d,12,0,0);
  }
  function genGroupId(date, customer){
    const y=date.getFullYear(), m=String(date.getMonth()+1).padStart(2,"0"), d=String(date.getDate()).padStart(2,"0");
    const rnd=Math.random().toString(36).slice(2,6), cust=(customer||"order").toLowerCase().replace(/[^a-z0-9]/g,"").slice(0,8);
    return `${y}-${m}-${d}-${cust||"order"}-${rnd}`;
  }
  async function saveOrder(){
    const msg=$("saveMsg");
    if(orderRows.length===0) return msg.textContent="Dodaj przynajmniej jedną pozycję.";
    if(orderRows.some(r=>!r.designId&&!r.customFile)) return msg.textContent="Każda pozycja musi mieć wybrany wzór/CUSTOM.";
    const total=Number($("orderTotalPrice").value||0); if(!total) return msg.textContent="Podaj cenę łączną.";
    const date=buildDate("addDay","addMonth","addYear");
    const customer=$("orderCustomer").value.trim();
    const groupId=genGroupId(date, customer);
    msg.textContent="Zapisywanie…";
    try{
      const processed=await Promise.all(orderRows.map(async r=>{
        let previewUrl=r.previewUrl||null;
        if(r.customFile) previewUrl=await fileToDataUrl(r.customFile); else if(r.designId) previewUrl=designMap.get(r.designId)?.previewUrl||null;
        return {...r, previewUrl};
      }));
      for(const r of processed){
        await addDoc(collection(db,"orderItems"),{
          date:Timestamp.fromDate(date), monthKey:monthKey(date.getFullYear(),date.getMonth()),
          createdAt:serverTimestamp(), updatedAt:serverTimestamp(),
          status:"ZAMÓWIENIE PRZYJĘTE",
          size:r.size, color:r.color, designId:r.designId||"custom", designText:r.designName||"CUSTOM",
          previewUrl:r.previewUrl||null, customer, note:r.note||"",
          orderTotalGross: total, priceGross:0, orderGroupId: groupId
        });
      }
      msg.textContent=`Zapisano ${processed.length} pozycji ✅`; clearOrderForm();
    }catch(e){ msg.textContent="Błąd: "+(e.message||e.code); }
    setTimeout(()=>msg.textContent="",2000);
  }

  // ===== Orders subscription & rendering (grouping) =====
  function ordersMonthKey(){ return monthKey(Number($("ordersYear").value), Number($("ordersMonth").value)); }
  function subscribeOrders(){
    if(unsubOrders){unsubOrders();unsubOrders=null;}
    const q1 = query(collection(db,"orderItems"));
    unsubOrders = onSnapshot(q1,(snap)=>{
      const docs=[]; snap.forEach(d=>docs.push({id:d.id,...d.data()}));
      const groups=new Map();
      for(const d of docs){
        const gid=d.orderGroupId||d.id;
        if(!groups.has(gid)) groups.set(gid,{id:gid,items:[],date:d.date,customer:d.customer||"",status:d.status||"ZAMÓWIENIE PRZYJĘTE",total:Number(d.orderTotalGross||0),createdMax:d.createdAt?.toDate?d.createdAt.toDate().getTime():0});
        const g=groups.get(gid); g.items.push(d);
        if(d.orderTotalGross!=null) g.total=Number(d.orderTotalGross);
        if(d.status) g.status=d.status; if(d.customer) g.customer=d.customer; if(d.date) g.date=d.date;
        const ct=d.createdAt?.toDate?d.createdAt.toDate().getTime():0; if(ct>g.createdMax) g.createdMax=ct;
      }
      ordersGroupsAll=Array.from(groups.values()).sort((a,b)=>b.createdMax-a.createdMax);
      revenueSumAll=ordersGroupsAll.reduce((acc,g)=>acc+(g.status==="ZWROT"?0:Number(g.total||0)),0);
      renderOrdersFiltered(); updateTopSummary();
    },err=>console.error("Błąd odczytu zamówień:", err));
  }

  function renderOrdersFiltered(){
    const statusFilter=$("filterStatus").value;
    const tbody=$("ordersTbody"); tbody.innerHTML="";
    const groups=statusFilter==="ALL"?ordersGroupsAll:ordersGroupsAll.filter(g=>(g.status||"ZAMÓWIENIE PRZYJĘTE")===statusFilter);
    groups.forEach((g,gi)=>{
      g.items.sort((a,b)=>(a.size||"").localeCompare(b.size||""));
      const cls=rowCls(g.status), tone=gi%2===0?"toneA":"toneB";
      g.items.forEach((it,idx)=>{
        const tr=document.createElement("tr"); tr.className=`${cls} ${tone}`;
        const dt=it.date?.toDate?it.date.toDate():new Date(it.date);
        const dstr=`${String(dt.getDate()).padStart(2,"0")}.${String(dt.getMonth()+1).padStart(2,"0")}.${dt.getFullYear()}`;
        tr.innerHTML=`
          <td>${idx===0?`<span class="bold">${dstr}</span>`:""}</td>
          <td class="statusCol" data-status></td>
          <td class="bold">${it.size||""}</td>
          <td>
            <span class="colorTag"><span class="dot ${it.color==="CZARNA"?"black":""}"></span>${it.color||""}</span>
          </td>
          <td>
            <div class="designCell">
              ${it.previewUrl?`<img class="designThumb" src="${it.previewUrl}" alt="">`:""}
              <span>${(it.designText||"").replace(/</g,"&lt;")}</span>
            </div>
          </td>
          <td>${idx===0?(g.customer||"").replace(/</g,"&lt;"):""}</td>
          <td>${(it.note||"").replace(/</g,"&lt;")}</td>
          <td>${idx===0?`${fmt2(g.total)} zł`:"—"}</td>
          <td>${idx===0?`<button class="ghost mini-btn" data-edit="${g.id}">Edytuj</button> <button class="ghost mini-btn danger" data-del="${g.id}">Usuń</button>`:""}</td>`;
        if(idx===0){
          const sel=document.createElement("select");
          const ST=["ZAMÓWIENIE PRZYJĘTE","W TRAKCIE REALIZACJI","GOTOWE DO WYSYŁKI","WYSŁANE","ZWROT"];
          sel.innerHTML=ST.map(s=>`<option ${s===g.status?"selected":""}>${s}</option>`).join("");
          sel.onchange=async e=>{ await updateGroupStatus(g.id,e.target.value); };
          tr.querySelector('[data-status]').appendChild(sel);
          tr.querySelector(`[data-del="${g.id}"]`).onclick=()=>deleteGroup(g.id);
          tr.querySelector(`[data-edit="${g.id}"]`).onclick=()=>openEditModal(g.id);
        }
        tbody.appendChild(tr);
      });
    });
  }

  async function updateGroupStatus(groupId,newStatus){
    const qSnap=await getDocs(query(collection(db,"orderItems"), where("orderGroupId","==",groupId)));
    const batch=writeBatch(db); qSnap.forEach(d=>batch.update(doc(db,"orderItems",d.id),{status:newStatus,updatedAt:serverTimestamp()}));
    await batch.commit();
  }
  async function deleteGroup(groupId){
    if(!confirm("Usunąć CAŁE zamówienie (wszystkie pozycje)?")) return;
    const qSnap=await getDocs(query(collection(db,"orderItems"), where("orderGroupId","==",groupId)));
    const batch=writeBatch(db); qSnap.forEach(d=>batch.delete(doc(db,"orderItems",d.id))); await batch.commit();
  }

  // ===== Edit modal logic =====
  let editRows = [];
  let editingGroupId = null;
  function editDefaultRow(){ return { id:null, size:"M", color:"BIAŁA", note:"", designId:null, designName:"", previewUrl:null, customFile:null, customLocalUrl:null }; }
  async function openEditModal(groupId){
    editingGroupId=groupId; $("editMsg").textContent="";
    const qSnap=await getDocs(query(collection(db,"orderItems"), where("orderGroupId","==",groupId)));
    const docs=[]; qSnap.forEach(d=>docs.push({id:d.id,...d.data()}));
    if(docs.length===0){ alert("Nie znaleziono pozycji."); return; }
    const any=docs[0];
    const dt=any.date?.toDate?any.date.toDate():new Date(any.date);
    $("editDay").value=dt.getDate(); $("editMonth").value=String(dt.getMonth()); $("editYear").value=String(dt.getFullYear());
    $("editCustomer").value=any.customer||""; $("editTotal").value=any.orderTotalGross||0;
    editRows = docs.map(d=>({ id:d.id, size:d.size, color:d.color, note:d.note||"", designId:d.designId||"custom", designName:d.designText||"CUSTOM", previewUrl:d.previewUrl||null, customFile:null, customLocalUrl:null }));
    renderEditRows();
    document.getElementById("orderEdit").style.display="flex";
  }
  function renderEditRows(){
    const tb=$("editRowsTbody"); tb.innerHTML="";
    editRows.forEach((r,i)=>{
      const tr=document.createElement("tr");
      tr.innerHTML=`
        <td>
          <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
            ${r.previewUrl?`<img class="thumb" src="${r.previewUrl}" alt="">`:`<div class="thumb" style="display:flex;align-items:center;justify-content:center;color:#6d8096">?</div>`}
            <div style="min-width:180px"><b>${(r.designName||"Nie wybrano").replace(/</g,"&lt;")}</b></div>
            <div class="rows-actions">
              <button class="ghost mini-btn" data-act="pick">Wybierz wzór</button>
              <label class="ghost mini-btn" style="display:inline-flex;align-items:center;gap:6px;cursor:pointer">
                <input data-act="custom" type="file" accept="image/*" style="display:none"> Upload CUSTOM
              </label>
            </div>
          </div>
        </td>
        <td><select data-act="size">${["S","M","L","XL","XXL","3XL"].map(s=>`<option ${r.size===s?"selected":""}>${s}</option>`).join("")}</select></td>
        <td><select data-act="color">${["BIAŁA","CZARNA"].map(c=>`<option ${r.color===c?"selected":""}>${c}</option>`).join("")}</select></td>
        <td><input data-act="note" type="text" value="${(r.note||"").replace(/"/g,'&quot;')}" placeholder="Uwagi do tej pozycji"></td>
        <td class="rows-actions"><button class="ghost mini-btn danger" data-act="remove">Usuń</button></td>`;
      tr.querySelector('[data-act="pick"]').onclick=()=>openPicker(i,"edit");
      tr.querySelector('[data-act="remove"]').onclick=()=>{ editRows.splice(i,1); renderEditRows(); if(editRows.length===0) editRows.push(editDefaultRow()); };
      tr.querySelector('[data-act="size"]').onchange=e=>r.size=e.target.value;
      tr.querySelector('[data-act="color"]').onchange=e=>r.color=e.target.value;
      tr.querySelector('[data-act="note"]').oninput=e=>r.note=e.target.value;
      tr.querySelector('[data-act="custom"]').onchange=e=>{ const f=e.target.files[0]; if(!f)return; r.designId="custom"; r.designName="CUSTOM"; r.customFile=f; r.customLocalUrl=URL.createObjectURL(f); r.previewUrl=r.customLocalUrl; renderEditRows(); };
      tb.appendChild(tr);
    });
  }
  async function editAddRow(){ editRows.push(editDefaultRow()); renderEditRows(); }
  async function saveEditOrder(){
    const msg=$("editMsg");
    if(editRows.length===0){ msg.textContent="Dodaj przynajmniej jedną pozycję."; return; }
    if(editRows.some(r=>!r.designId&&!r.customFile)){ msg.textContent="Każda pozycja musi mieć wzór/CUSTOM."; return; }
    const total=Number($("editTotal").value||0); if(!total){ msg.textContent="Podaj cenę łączną."; return; }
    msg.textContent="Zapisywanie zmian…";
    try{
      const date=buildDate("editDay","editMonth","editYear");
      const customer=$("editCustomer").value.trim();
      const processed=await Promise.all(editRows.map(async r=>{
        let previewUrl=r.previewUrl||null;
        if(r.customFile) previewUrl=await fileToDataUrl(r.customFile); else if(r.designId) previewUrl=designMap.get(r.designId)?.previewUrl||r.previewUrl||null;
        return {...r, previewUrl};
      }));
      const qSnap=await getDocs(query(collection(db,"orderItems"), where("orderGroupId","==",editingGroupId)));
      const existingIds=new Set(); qSnap.forEach(d=>existingIds.add(d.id));
      const keepIds=new Set(processed.filter(r=>r.id).map(r=>r.id));
      const batch=writeBatch(db);
      for(const r of processed){
        const payload={ date:Timestamp.fromDate(date), monthKey:monthKey(date.getFullYear(),date.getMonth()), updatedAt:serverTimestamp(),
          size:r.size, color:r.color, designId:r.designId||"custom", designText:r.designName||"CUSTOM",
          previewUrl:r.previewUrl||null, customer, note:r.note||"", orderTotalGross: total };
        if(r.id){ batch.update(doc(db,"orderItems",r.id), payload); }
        else { const ref=doc(collection(db,"orderItems")); batch.set(ref,{...payload, createdAt:serverTimestamp(), status:"ZAMÓWIENIE PRZYJĘTE", orderGroupId:editingGroupId, priceGross:0}); }
      }
      existingIds.forEach(id=>{ if(!keepIds.has(id)) batch.delete(doc(db,"orderItems",id)); });
      await batch.commit();
      msg.textContent="Zapisano zmiany ✅"; setTimeout(()=>{ msg.textContent=""; document.getElementById("orderEdit").style.display="none"; editingGroupId=null; editRows=[]; },800);
    }catch(e){ msg.textContent="Błąd: "+(e.message||e.code); }
  }

  // ===== Expenses =====
  function expMonthKey(){ return monthKey(Number($("expYear").value), Number($("expMonth").value)); }
  async function addExpense(){
    const msg=$("expMsg"), name=$("expName").value.trim(), amount=Number($("expAmount").value||0), note=$("expNote").value.trim();
    const day=Number($("expDay").value||1), y=Number($("expYear").value), m=Number($("expMonth").value);
    if(!name){msg.textContent="Podaj nazwę kosztu.";return;} if(!amount){msg.textContent="Podaj kwotę.";return;}
    const date=new Date(y,m,Math.min(Math.max(day,1),31),12,0,0);
    try{
      await addDoc(collection(db,"expenses"),{name,amount,note,date:Timestamp.fromDate(date),monthKey:expMonthKey(),createdAt:serverTimestamp()});
      $("expName").value=""; $("expAmount").value=""; $("expNote").value=""; msg.textContent="Dodano koszt ✅"; setTimeout(()=>msg.textContent="",1200);
    }catch(e){ msg.textContent="Błąd: "+(e.message||e.code); }
  }
  function subscribeExpenses(){
    if(unsubExp){unsubExp();unsubExp=null;}
    const q1=query(collection(db,"expenses"));
    unsubExp=onSnapshot(q1,(snap)=>{
      expensesList=[]; snap.forEach(d=>expensesList.push({id:d.id,...d.data()}));
      expensesList.sort((a,b)=> (b.date?.toDate?b.date.toDate().getTime():0)-(a.date?.toDate?a.date.toDate().getTime():0));
      expensesSumAll=expensesList.reduce((acc,x)=>acc+Number(x.amount||0),0);
      renderExpenses(); updateTopSummary();
    },err=>console.error("Błąd odczytu kosztów:",err));
  }
  function renderExpenses(){
    $("sumExpensesTop").textContent=fmt2(expensesSumAll);
    const tb=$("expTbody"); tb.innerHTML="";
    for(const e of expensesList){
      const dt=e.date?.toDate?e.date.toDate():new Date(e.date);
      const dstr=`${String(dt.getDate()).padStart(2,"0")}.${String(dt.getMonth()+1).padStart(2,"0")}.${dt.getFullYear()}`;
      const tr=document.createElement("tr");
      tr.innerHTML=`
        <td>${dstr}</td>
        <td>${(e.name||"").replace(/</g,"&lt;")}</td>
        <td>${(e.note||"").replace(/</g,"&lt;")}</td>
        <td>${fmt2(e.amount)} zł</td>
        <td><button class="ghost mini-btn" data-del="${e.id}">usuń</button></td>`;
      const delBtn = tr.querySelector('[data-del]'); delBtn.onclick = async()=>{ if(!confirm("Usunąć koszt?"))return; await deleteDoc(doc(db,"expenses",e.id)); };
      const editBtn = document.createElement('button'); editBtn.className='ghost mini-btn'; editBtn.textContent='Edytuj'; editBtn.style.marginRight='6px';
      editBtn.onclick = ()=>openExpenseEditor(e,tr);
      tr.querySelector('td:last-child').insertBefore(editBtn, delBtn);
      tb.appendChild(tr);
    }
  }
  function openExpenseEditor(exp, tr){
    const nameEl = tr.querySelector('td:nth-child(2)'); const noteEl = tr.querySelector('td:nth-child(3)'); const amountEl = tr.querySelector('td:nth-child(4)');
    const origName=nameEl.textContent, origNote=noteEl.textContent, origAmount=String(exp.amount||'0');
    tr.innerHTML = `
      <td><input type="number" class="small" data-edit-day value="${new Date(exp.date?.toDate?exp.date.toDate():exp.date).getDate()}"></td>
      <td><input data-edit-name value="${origName.replace(/\"/g,'&quot;')}"></td>
      <td><input data-edit-note value="${origNote.replace(/\"/g,'&quot;')}"></td>
      <td><input type="number" step="0.01" data-edit-amount value="${origAmount}"></td>
      <td>
        <div class="rows-actions">
          <button class="primary mini-btn" data-save>Save</button>
          <button class="ghost mini-btn" data-cancel>Cancel</button>
        </div>
      </td>`;
    tr.querySelector('[data-cancel]').onclick = ()=>renderExpenses();
    tr.querySelector('[data-save]').onclick = async ()=>{
      const newName = tr.querySelector('[data-edit-name]').value.trim();
      const newNote = tr.querySelector('[data-edit-note]').value.trim();
      const newAmount = Number(tr.querySelector('[data-edit-amount]').value||0);
      const day = Number(tr.querySelector('[data-edit-day]').value||1);
      if(!newName||!newAmount){ alert('Nazwa i kwota są wymagane'); return; }
      const dt = new Date(Number($("expYear").value), Number($("expMonth").value), Math.min(Math.max(day,1),31),12,0,0);
      await updateDoc(doc(db,'expenses',exp.id), { name:newName, note:newNote, amount:newAmount, date:Timestamp.fromDate(dt), monthKey:expMonthKey(), updatedAt:serverTimestamp() });
      renderExpenses();
    };
  }

  // ===== Stats subscription (wzory) =====
  function statsMonthKey(){ return monthKey(Number($("statsYear").value), Number($("statsMonth").value)); }
  function subscribeStats(){
    if(unsubStats){unsubStats();unsubStats=null;}
    const q1=query(collection(db,"orderItems"));
    unsubStats=onSnapshot(q1,(snap)=>{
      const counts = new Map();
      snap.forEach(docu=>{
        const it=docu.data();
        if (it.status === "ZWROT") return;
        const id = it.designId || "custom";
        const prev = counts.get(id) || { count:0, name:"", preview:null };
        prev.count += 1;
        prev.name = it.designText || prev.name || (designMap.get(id)?.name || (id==="custom"?"CUSTOM":id));
        prev.preview = it.previewUrl || prev.preview || (designMap.get(id)?.previewUrl || null);
        counts.set(id, prev);
      });
      for (const d of designMap.values()){
        if (!counts.has(d.id)) counts.set(d.id, { count:0, name:d.name||d.id, preview:d.previewUrl||null });
      }
      const list = Array.from(counts.entries()).map(([id,info])=>({
        id, name: info.name || (id==="custom"?"CUSTOM":id),
        preview: info.preview || null,
        count: info.count
      })).sort((a,b)=> b.count - a.count || (a.name||"").localeCompare(b.name||"","pl"));
      renderStats(list);
    },err=>console.error("Błąd statystyk:",err));
  }
  function renderStats(list){
    const tb=$("statsTbody"); tb.innerHTML="";
    list.forEach((row,i)=>{
      const tr=document.createElement("tr");
      tr.innerHTML=`
        <td>${i+1}</td>
        <td>
          <div class="designCell">
            ${row.preview?`<img class="designThumb" src="${row.preview}" alt="">`:""}
            <span>${(row.name||"").replace(/</g,"&lt;")}</span>
          </div>
        </td>
        <td>${row.count}</td>`;
      tb.appendChild(tr);
    });
  }

  // ===== Export helpers =====
  function downloadCSV(filename, rows) {
    const BOM = '\uFEFF';
    const blob = new Blob([BOM + rows.join('\r\n')], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = filename; document.body.appendChild(a); a.click();
    document.body.removeChild(a); URL.revokeObjectURL(url);
  }
  function exportOrdersItemsCSV() {
    const header = ['DATA','STATUS ZAMÓWIENIA','ROZMIAR','KOLOR','WZÓR','DANE ZAMAWIAJĄCEGO','UWAGI','CENA'];
    const rows = [header.join(';')];
    const groups = ordersGroupsAll.slice();
    for (const g of groups) {
      const items = g.items.slice().sort((a,b)=>(a.size||"").localeCompare(b.size||""));
      items.forEach((it, idx) => {
        rows.push([
          dShort(g.date),
          g.status || 'ZAMÓWIENIE PRZYJĘTE',
          (it.size || ''),
          (it.color || ''),
          (it.designText || '').replace(/;/g, ','),
          idx===0 ? (g.customer || '') : '',
          (it.note || '').replace(/;/g, ','),
          (idx===0 && g.status!=='ZWROT') ? numPL(g.total) : ''
        ].map(v => `"${String(v).replace(/"/g,'""')}"`).join(';'));
      });
    }
    const y = $('ordersYear').value, m = String(Number($('ordersMonth').value)+1).padStart(2,'0');
    downloadCSV(`zamowienia_pozycje_${y}-${m}.csv`, rows);
  }
  function exportOrdersGroupsCSV() {
    const header = ['DATA','STATUS','KLIENT','LICZBA POZYCJI','POZYCJE','CENA'];
    const rows = [header.join(';')];
    for (const g of ordersGroupsAll) {
      const items = g.items.slice().sort((a,b)=>(a.size||"").localeCompare(b.size||""));
      const details = items.map(it => `${it.size||''}/${it.color||''} – ${(it.designText||'').replace(/;/g,',')}`).join(' | ');
      rows.push([
        dShort(g.date),
        g.status || 'ZAMÓWIENIE PRZYJĘTE',
        g.customer || '',
        String(items.length),
        details,
        (g.status!=='ZWROT') ? numPL(g.total) : ''
      ].map(v => `"${String(v).replace(/"/g,'""')}"`).join(';'));
    }
    const y = $('ordersYear').value, m = String(Number($('ordersMonth').value)+1).padStart(2,'0');
    downloadCSV(`zamowienia_zamowienia_${y}-${m}.csv`, rows);
  }
  function exportExpensesCSV() {
    const header = ['DATA','NAZWA','UWAGI','KWOTA'];
    const rows = [header.join(';')];
    for (const e of expensesList) {
      rows.push([
        dShort(e.date),
        (e.name||'').replace(/;/g, ','),
        (e.note||'').replace(/;/g, ','),
        numPL(e.amount || 0)
      ].map(v => `"${String(v).replace(/"/g,'""')}"`).join(';'));
    }
    const y = $('expYear').value, m = String(Number($('expMonth').value)+1).padStart(2,'0');
    downloadCSV(`koszty_${y}-${m}.csv`, rows);
  }

  // ===== Advanced stats: charts setup =====
  function createEmptyCharts(){
    const commonOpts = {
      responsive: true,
      maintainAspectRatio: false,
      aspectRatio: 2,
      scales: { y: { beginAtZero: true } }
    };

    // small helper to safe-get context
    function ctx(id){ const el=$(id); if(!el) return null; return el.getContext('2d'); }

    const ctxO = ctx('chartOrders');
    const ctxS = ctx('chartSizes');
    const ctxD = ctx('chartDesigns');

    // existing charts (if element exists)
    try {
      if(ctx('chartOrders')) chartOrders = new Chart(ctx('chartOrders'), { type: 'bar', data: { labels: [], datasets: [{ label: 'Zamówienia', data: [] }] }, options: commonOpts });
      if(ctx('chartSizes')) chartSizes = new Chart(ctx('chartSizes'), { type: 'bar', data: { labels: [], datasets: [{ label: 'Ilość', data: [] }] }, options: commonOpts });
      if(ctx('chartDesigns')) chartDesigns = new Chart(ctx('chartDesigns'), { type: 'bar', data: { labels: [], datasets: [{ label: 'Ilość', data: [] }] }, options: commonOpts });
    } catch(e){ console.warn("Chart init error", e); }

    // new finance charts
    const common = { responsive:true, maintainAspectRatio:false, aspectRatio:2, scales:{ y:{ beginAtZero:true } } };
    if($( 'chartFinances' )){
      chFinances = new Chart($('chartFinances').getContext('2d'), { type:'line', data:{labels:[], datasets:[
        { label:'Przychód', data:[], borderColor:'#4cc9f0', backgroundColor:'rgba(76,201,240,.06)', fill:true, tension:0.2 },
        { label:'Koszty', data:[], borderColor:'#ff8a65', backgroundColor:'rgba(255,138,101,.04)', fill:true, tension:0.2 },
        { label:'Zysk', data:[], borderColor:'#a3e635', backgroundColor:'rgba(163,230,53,.04)', fill:true, tension:0.2 }
      ] }, options:{...common, plugins:{legend:{position:'bottom'}}} });
    }
    if($('chartCostBreakdown')){
      chCostBreakdown = new Chart($('chartCostBreakdown').getContext('2d'), { type:'pie', data:{labels:[], datasets:[{data:[], backgroundColor:['#4cc9f0','#ff8a65','#ffd166','#a3e635','#a78bfa']}]}, options:{ responsive:true, maintainAspectRatio:false, aspectRatio:1.2 } });
    }
    if($('chartMargin')){
      chMargin = new Chart($('chartMargin').getContext('2d'), { type:'line', data:{labels:[], datasets:[{label:'Marża %', data:[], borderColor:'#ffd166', backgroundColor:'rgba(255,209,102,.06)', fill:true, tension:0.3}]}, options:{...common, scales:{ y:{ beginAtZero:true, max:100 }}} });
    }
    if($('chartCumNet')){
      chCumNet = new Chart($('chartCumNet').getContext('2d'), { type:'line', data:{labels:[], datasets:[{label:'Zysk skumulowany', data:[], borderColor:'#a3e635', backgroundColor:'rgba(163,230,53,.06)', fill:true, tension:0.2}]}, options:{...common} });
    }
    if($('chartReturnsPct')){
      chReturns = new Chart($('chartReturnsPct').getContext('2d'), { type:'doughnut', data:{labels:['Zwroty','Pozostałe'], datasets:[{data:[0,100], backgroundColor:['#ff6b6b','#4cc9f0']}]}, options:{ responsive:true, maintainAspectRatio:false, aspectRatio:1.2 } });
    }
    if($('chartTopDesigns')){
      chTopDesigns = new Chart($('chartTopDesigns').getContext('2d'), { type:'bar', data:{labels:[], datasets:[{label:'Sprzedaż', data:[], backgroundColor:'#4cc9f0'}]}, options:{ responsive:true, maintainAspectRatio:false, aspectRatio:2 } });
    }
  }

  // helper date ranges
  function startOfWeek(dt){ const d=new Date(dt); const day=d.getDay(); const diff=d.getDate()-(day||7)+1; return new Date(d.getFullYear(),d.getMonth(),diff,0,0,0); }
  function endOfWeek(dt){ const s=startOfWeek(dt); return new Date(s.getFullYear(),s.getMonth(),s.getDate()+6,23,59,59); }

  // fetchers for adv stats
  async function fetchAllOrderItems(){ const snap = await getDocs(query(collection(db,"orderItems"))); const docs=[]; snap.forEach(d=>docs.push({id:d.id,...d.data()})); return docs; }
  async function fetchExpensesForRange(startDate, endDate){ const snap = await getDocs(query(collection(db,'expenses'))); const arr=[]; snap.forEach(d=>arr.push({id:d.id,...d.data()})); return arr.filter(e=>{ const dt = e.date?.toDate?e.date.toDate():new Date(e.date); return dt>=startDate && dt<=endDate; }); }

  // render advanced stats
  async function renderAdvancedStats(){
    // get period and anchor
    const period=$("advPeriod").value;
    const anchorMonth=Number($("advAnchorMonth").value); const anchorYear=Number($("advAnchorYear").value);
    let startDate, endDate;
    if(period==='week'){
      const today=new Date(anchorYear, anchorMonth, new Date().getDate());
      startDate=startOfWeek(today); endDate=endOfWeek(today);
    } else if(period==='month'){
      startDate=new Date(anchorYear, anchorMonth,1,0,0,0);
      endDate=new Date(anchorYear, anchorMonth+1,0,23,59,59);
    } else if(period==='year'){
      startDate=new Date(anchorYear,0,1,0,0,0);
      endDate=new Date(anchorYear,11,31,23,59,59);
    } else {
      startDate=new Date(1970,0,1); endDate=new Date(2099,11,31,23,59,59);
    }

    // fetch data (we have cached groups/orders from subscription)
    // compute group map for revenue (avoid double counting)
    const groupMap = new Map();
    for(const g of ordersGroupsAll){
      const d = g.date?.toDate?g.date.toDate():new Date(g.date);
      if(d < startDate || d > endDate) continue;
      groupMap.set(g.id, g);
    }

    const includeReturns = $("advIncludeReturns").checked;

    // revenue/costs by label
    const byLabel = new Map();
    function labelForDate(dt){
      if(period==='week' || period==='month') return `${String(dt.getDate()).padStart(2,'0')}.${String(dt.getMonth()+1).padStart(2,'0')}`;
      if(period==='year') return `${String(dt.getMonth()+1).padStart(2,'0')}`;
      return `${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,'0')}`;
    }
    // revenue (by groups)
    for(const [gid,g] of groupMap){
      if(!includeReturns && g.status==='ZWROT') continue;
      const dt = g.date?.toDate?g.date.toDate():new Date(g.date);
      const lb = labelForDate(dt);
      if(!byLabel.has(lb)) byLabel.set(lb,{revenue:0,costs:0,net:0});
      byLabel.get(lb).revenue += Number(g.total||0);
    }

    // expenses in range
    const expensesInRange = await fetchExpensesForRange(startDate,endDate);
    for(const e of expensesInRange){
      const dt = e.date?.toDate?e.date.toDate():new Date(e.date);
      const lb = labelForDate(dt);
      if(!byLabel.has(lb)) byLabel.set(lb,{revenue:0,costs:0,net:0});
      byLabel.get(lb).costs += Number(e.amount||0);
    }

    // prepare arrays sorted
    const labels = Array.from(byLabel.keys()).sort((a,b)=>{
      const na = a.replace(/\D/g,''), nb = b.replace(/\D/g,''); return (Number(na) - Number(nb)) || a.localeCompare(b,'pl');
    });
    const revArr = labels.map(l=>byLabel.get(l).revenue || 0);
    const costArr = labels.map(l=>byLabel.get(l).costs || 0);
    const netArr = labels.map((l,i)=> revArr[i] - costArr[i]);

    // update KPI and charts (finance)
    const totalRevenue = revArr.reduce((s,v)=>s+v,0);
    const totalCosts = costArr.reduce((s,v)=>s+v,0);
    const totalNet = totalRevenue - totalCosts;
    $("advRevenue").textContent = fmt2(totalRevenue);
    $("advCosts").textContent = fmt2(totalCosts);
    $("advNet").textContent = fmt2(totalNet);

    // AOV
    const ordersCount = Array.from(groupMap.values()).filter(g=> includeReturns ? true : g.status !== 'ZWROT' ).length || 1;
    const AOV = totalRevenue / ordersCount;
    $("advAOV").textContent = fmt2(AOV);

    // returns %
    const totalOrdersAll = ordersGroupsAll.filter(g=>{
      const d = g.date?.toDate?g.date.toDate():new Date(g.date);
      return d>=startDate && d<=endDate;
    }).length || 1;
    const returnsCount = ordersGroupsAll.filter(g=>{
      const d = g.date?.toDate?g.date.toDate():new Date(g.date);
      return d>=startDate && d<=endDate && g.status==='ZWROT';
    }).length;
    const returnsPct = Math.round((returnsCount / totalOrdersAll) * 100);
    $("advReturnsPct").textContent = returnsPct + '%';

    // marża %
    const marginPctArr = labels.map((l,i)=> {
      const rev = revArr[i] || 0; const c = costArr[i] || 0;
      return rev === 0 ? 0 : Math.max(0, ( (rev - c) / rev ) * 100 );
    });
    const avgMargin = marginPctArr.length ? (marginPctArr.reduce((s,v)=>s+v,0)/marginPctArr.length) : 0;
    $("advAvgMargin").textContent = Math.round(avgMargin) + '%';

    // cumulative net
    const cumArr = []; let acc=0; for(const v of netArr){ acc += v; cumArr.push(acc); }

    // cost buckets for pie (simple heuristics)
    const buckets = {};
    for(const e of expensesInRange){
      const name = (e.name||'').toLowerCase();
      let cat = 'Inne';
      if(/koszulk|t-shirt|shirt|materi|materiał/.test(name)) cat = 'Materiały';
      else if(/druk|sitodruk|drukarnia|drukowanie/.test(name)) cat = 'Druk';
      else if(/wysył|paczka|kurier/.test(name)) cat = 'Wysyłka';
      else if(/reklam|ads|facebook|google|marketing/.test(name)) cat = 'Marketing';
      buckets[cat] = (buckets[cat]||0) + Number(e.amount||0);
    }
    const bucketLabels = Object.keys(buckets);
    const bucketVals = bucketLabels.map(l=>buckets[l]);

    // top designs in range
    const designCounts = {};
    const allItems = await fetchAllOrderItems();
    const filteredItems = allItems.filter(it=>{
      const dt = it.date?.toDate?it.date.toDate():new Date(it.date);
      if(!(dt>=startDate && dt<=endDate)) return false;
      if(!includeReturns && it.status==='ZWROT') return false;
      return true;
    });
    filteredItems.forEach(it=>{
      const id = it.designId || 'custom'; designCounts[id] = (designCounts[id]||0)+1;
    });
    const topDesignArr = Object.entries(designCounts).map(([id,c])=>({id,name: designMap.get(id)?.name || (id==='custom'?'CUSTOM':id), count:c})).sort((a,b)=>b.count-a.count).slice(0,10);

    // sizes counts for selected sizePeriod
    const sizePeriod = $("sizePeriod").value;
    const sizeIncludeReturns = $("sizeIncludeReturns").checked;
    // build map key->size->count
    const sizeMap = {}; // key -> { size:count }
    filteredItems.forEach(it=>{
      const dt = it.date?.toDate?it.date.toDate():new Date(it.date);
      // compute period key
      let key;
      if(sizePeriod==='day') key = `${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,'0')}-${String(dt.getDate()).padStart(2,'0')}`;
      else if(sizePeriod==='week'){ const s = startOfWeek(dt); key = `${s.getFullYear()}-${String(s.getMonth()+1).padStart(2,'0')}-w${String(s.getDate()).padStart(2,'0')}`; }
      else if(sizePeriod==='month') key = `${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,'0')}`;
      else if(sizePeriod==='year') key = `${dt.getFullYear()}`;
      else key = 'all';
      if(!sizeMap[key]) sizeMap[key] = {};
      const sz = it.size || 'UNKNOWN';
      sizeMap[key][sz] = (sizeMap[key][sz]||0) + 1;
    });

    // update charts
    if(chFinances){ chFinances.data.labels = labels; chFinances.data.datasets[0].data = revArr; chFinances.data.datasets[1].data = costArr; chFinances.data.datasets[2].data = netArr; chFinances.update(); }
    if(chCostBreakdown){ chCostBreakdown.data.labels = bucketLabels; chCostBreakdown.data.datasets[0].data = bucketVals; chCostBreakdown.update(); }
    if(chMargin){ chMargin.data.labels = labels; chMargin.data.datasets[0].data = marginPctArr; chMargin.update(); }
    if(chCumNet){ chCumNet.data.labels = labels; chCumNet.data.datasets[0].data = cumArr; chCumNet.update(); }
    if(chReturns){ chReturns.data.datasets[0].data = [returnsCount, Math.max(0, totalOrdersAll - returnsCount)]; chReturns.update(); }
    if(chTopDesigns){ chTopDesigns.data.labels = topDesignArr.map(t=>t.name); chTopDesigns.data.datasets[0].data = topDesignArr.map(t=>t.count); chTopDesigns.update(); }

    // sizes chart (aggregate across all keys for simplicity: total per size)
    const sizesAgg = {};
    Object.values(sizeMap).forEach(map=>{ for(const [s,c] of Object.entries(map)){ sizesAgg[s] = (sizesAgg[s]||0)+c; }});
    const sizeLabels = Object.keys(sizesAgg).sort((a,b)=>a.localeCompare(b,'pl'));
    const sizeData = sizeLabels.map(l=>sizesAgg[l]||0);
    if(chartSizes){ chartSizes.data.labels = sizeLabels; chartSizes.data.datasets[0].data = sizeData; chartSizes.update(); }

    // populate advTopDesignsTbody
    const td = $("advTopDesignsTbody"); td.innerHTML = "";
    for(const d of topDesignArr){ const tr=document.createElement('tr'); tr.innerHTML=`<td>${(d.name||"").replace(/</g,"&lt;")}</td><td>${d.count}</td>`; td.appendChild(tr); }

    // populate size table
    renderSizeTable(sizeMap);

    // populate adv detail table (moved lower)
    const tbody = $("advDetailTbody"); tbody.innerHTML='';
    tbody.appendChild(trRow('Przychód (sumarycznie)', fmt2(totalRevenue)+' zł'));
    tbody.appendChild(trRow('Koszty (sumarycznie)', fmt2(totalCosts)+' zł'));
    tbody.appendChild(trRow('Zysk netto', fmt2(totalNet)+' zł'));
    tbody.appendChild(trRow('AOV (średni przychód na zamówienie)', fmt2(AOV)+' zł'));
    tbody.appendChild(trRow('Udział zwrotów', returnsPct+' %'));
    for(const l of bucketLabels) tbody.appendChild(trRow('Koszt: '+l, fmt2(buckets[l])+' zł'));
  }

  // render size table given sizeMap (if not provided, compute from current selection again)
  function renderSizeTable(sizeMapInput){
    // if none, compute quickly from chartSizes data (less granular)
    const sizePeriod = $("sizePeriod").value;
    const tbody = $("advSizeTbody"); tbody.innerHTML = "";
    if(!sizeMapInput){
      tbody.innerHTML = `<tr><td colspan="3" class="hint">Brak danych</td></tr>`;
      return;
    }
    // create rows: for each period (key) and each size
    const keys = Object.keys(sizeMapInput).sort();
    if(keys.length===0){ tbody.innerHTML = `<tr><td colspan="3" class="hint">Brak danych</td></tr>`; return; }
    for(const k of keys){
      const sizes = sizeMapInput[k];
      const sizeKeys = Object.keys(sizes).sort((a,b)=>a.localeCompare(b,'pl'));
      for(const s of sizeKeys){
        const tr=document.createElement('tr');
        tr.innerHTML = `<td>${k}</td><td>${s}</td><td>${sizes[s]}</td>`;
        tbody.appendChild(tr);
      }
    }
  }

  // ===== Subscriptions to Firestore (orders, expenses, designs) used earlier =====
  function subscribeOrders(){
    // reuse earlier unsub if exists
    if(unsubOrders){unsubOrders();unsubOrders=null;}
    const q1 = query(collection(db,"orderItems"));
    unsubOrders = onSnapshot(q1,(snap)=>{
      const docs=[]; snap.forEach(d=>docs.push({id:d.id,...d.data()}));
      const groups=new Map();
      for(const d of docs){
        const gid=d.orderGroupId||d.id;
        if(!groups.has(gid)) groups.set(gid,{id:gid,items:[],date:d.date,customer:d.customer||"",status:d.status||"ZAMÓWIENIE PRZYJĘTE",total:Number(d.orderTotalGross||0),createdMax:d.createdAt?.toDate?d.createdAt.toDate().getTime():0});
        const g=groups.get(gid); g.items.push(d);
        if(d.orderTotalGross!=null) g.total=Number(d.orderTotalGross);
        if(d.status) g.status=d.status; if(d.customer) g.customer=d.customer; if(d.date) g.date=d.date;
        const ct=d.createdAt?.toDate?d.createdAt.toDate().getTime():0; if(ct>g.createdMax) g.createdMax=ct;
      }
      ordersGroupsAll=Array.from(groups.values()).sort((a,b)=>b.createdMax-a.createdMax);
      revenueSumAll=ordersGroupsAll.reduce((acc,g)=>acc+(g.status==="ZWROT"?0:Number(g.total||0)),0);
      renderOrdersFiltered(); updateTopSummary();
    },err=>console.error("subscribeOrders error",err));
  }

  // ===== Utilities =====
  function updateTopSummary(){
    $("ordersCount").textContent = String(ordersGroupsAll.length);
    $("sumRevenue").textContent  = fmt2(revenueSumAll);
    $("sumExpenses").textContent = fmt2(expensesSumAll);
    const net = revenueSumAll - expensesSumAll;
    const el  = $("sumNet");
    el.textContent = fmt2(net);
    el.classList.toggle("neg", net < 0);
  }

  // file to data url
  function fileToDataUrl(file){ return new Promise((res,rej)=>{ const rdr=new FileReader(); rdr.onload=()=>res(rdr.result); rdr.onerror=rej; rdr.readAsDataURL(file); }); }

  // minimal subscribe wrapper for expenses and designs already defined above
  // ensure subscribeExpenses and subscribeDesigns exist (they do above)

  // ===== bootstrap: create other charts and listeners =====
  createEmptyCharts();
  subscribeDesigns();
  subscribeOrders();
  subscribeExpenses();
  subscribeStats();

  // expose renderAdvancedStats to global for tab click
  window.renderAdvancedStats = renderAdvancedStats;
  // expose other helpers if needed
  window.createEmptyCharts = createEmptyCharts;

</script>

</body>
</html>
