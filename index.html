<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Koszulki – panel</title>
  <style>
    :root {
      --bg:#0b0f14; --card:#121820; --muted:#8aa0b6; --text:#e8f1ff; --accent:#4cc9f0;
      --green:#2ec27e; --red:#ff6b6b; --amber:#f9a825; --blue:#64b5f6;
    }
    *{box-sizing:border-box} body{margin:0;font-family:system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text)}
    header{padding:16px 20px;border-bottom:1px solid #243344;display:flex;justify-content:space-between;align-items:center;gap:10px}
    h1{font-size:18px;margin:0} .muted{color:var(--muted)}
    .wrap{max-width:1200px;margin:0 auto;padding:16px}
    .card{background:var(--card);border:1px solid #1e2a39;border-radius:12px;padding:14px;margin-bottom:14px}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .col{flex:1 1 220px;min-width:220px}
    input,select,button,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid #2a3a4d;background:#0d131b;color:var(--text)}
    button{cursor:pointer;background:#19344b;border-color:#274d6a}
    button.primary{background:linear-gradient(180deg,#2a87b9,#1b5f86);border-color:#1b5f86;font-weight:600}
    button.ghost{background:#0d131b;border-color:#2a3a4d}
    nav.tabs{display:flex;gap:8px;margin:10px 0 14px 0;flex-wrap:wrap}
    nav.tabs button{flex:0 0 auto;padding:8px 12px;border-radius:10px}
    nav.tabs button.active{outline:2px solid var(--accent)}
    table{width:100%;border-collapse:collapse;font-size:14px}
    th,td{border-bottom:1px solid #233244;padding:8px 6px;text-align:left}
    tr:hover{background:#0e1620}
    .status{padding:3px 8px;border-radius:999px;font-weight:600;font-size:12px;display:inline-block}
    .s-new{background:rgba(100,181,246,.15);color:var(--blue)}
    .s-wpr{background:rgba(249,168,37,.15);color:var(--amber)}
    .s-wys{background:rgba(46,194,126,.15);color:var(--green)}
    .s-zw{background:rgba(255,107,107,.15);color:var(--red)}
    .toolbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:10px}
    .right{margin-left:auto}
    .hint{font-size:12px;color:var(--muted)}
    .pill{padding:6px 10px;border-radius:99px;background:#0d131b;border:1px solid #2a3a4d}
    .mini{font-size:12px}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:10px}
    .design-card{border:1px solid #2a3a4d;border-radius:12px;padding:10px;cursor:pointer;background:#0d131b;text-align:center}
    .design-card:hover{border-color:#3c5875}
    .design-card.selected{outline:2px solid var(--accent);background:#11202c}
    .design-img{width:100%;height:110px;object-fit:cover;border-radius:10px;border:1px solid #2a3a4d;background:#0b1118}
    .design-name{margin-top:8px;font-weight:600}
    .add-header{display:flex;align-items:center;gap:10px;margin-bottom:10px}
    .add-header .right{display:flex;gap:10px;margin-left:auto}
    .two-col{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:800px){.two-col{grid-template-columns:1fr}}
    /* kompaktowa data */
    .date-compact{display:flex;gap:8px;align-items:center}
    .date-compact .small{max-width:100px;padding:8px}
    .date-compact .month{max-width:140px;padding:8px}
    input[type=number]::-webkit-outer-spin-button,
    input[type=number]::-webkit-inner-spin-button{ -webkit-appearance: none; margin: 0;}
    input[type=number]{ -moz-appearance:textfield;}
    /* wzór w tabeli */
    .designCell{display:flex;align-items:center;gap:8px}
    .designThumb{width:40px;height:40px;object-fit:cover;border-radius:6px;border:1px solid #2a3a4d;background:#0b1118}
  </style>
</head>
<body>
<header>
  <h1>Koszulki – panel</h1>
  <div>
    <span id="userEmail" class="muted"></span>
    <button id="logoutBtn" class="ghost" style="display:none">Wyloguj</button>
  </div>
</header>

<div class="wrap">

  <!-- LOGIN -->
  <div id="loginCard" class="card" style="max-width:460px;">
    <h3>Zaloguj się</h3>
    <div class="row">
      <div class="col"><input id="email" type="email" placeholder="Email" /></div>
      <div class="col"><input id="password" type="password" placeholder="Hasło" /></div>
    </div>
    <div class="row">
      <div class="col"><button id="loginBtn" class="primary">Zaloguj</button></div>
      <div class="col"><div id="loginMsg" class="hint"></div></div>
    </div>
  </div>

  <!-- APP -->
  <div id="app" style="display:none">
    <nav class="tabs">
      <button data-tab="orders" class="active">Zamówienia (miesiąc)</button>
      <button data-tab="add">Dodaj pozycję</button>
      <button data-tab="designs">Wzory</button>
    </nav>

    <!-- ORDERS TAB -->
    <div id="tab-orders" class="card">
      <div class="toolbar">
        <div>
          <label class="mini">Miesiąc</label>
          <input id="monthPicker" type="month" />
        </div>
        <div>
          <label class="mini">Status</label>
          <select id="filterStatus">
            <option value="ALL">Wszystkie</option>
            <option value="ZAMÓWIENIE PRZYJĘTE">ZAMÓWIENIE PRZYJĘTE</option>
            <option value="W PRODUKCJI">W PRODUKCJI</option>
            <option value="WYSŁANE">WYSŁANE</option>
            <option value="ZWROT">ZWROT</option>
          </select>
        </div>
        <div class="right pill">Suma (m‑c): <b id="sumCena">0.00</b> zł</div>
      </div>

      <div style="overflow:auto">
        <table>
          <thead>
            <tr>
              <th>Data</th>
              <th>Status</th>
              <th>Rozmiar</th>
              <th>Kolor</th>
              <th>Wzór</th>
              <th>Zamawiający</th>
              <th>Uwagi</th>
              <th>Cena</th>
              <th>ID zamówienia</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="ordersTbody"></tbody>
        </table>
      </div>
      <div class="hint">Jeśli pojawi się link “Create index”, kliknij – to indeks monthKey + date.</div>
    </div>

    <!-- ADD TAB -->
    <div id="tab-add" class="card" style="display:none">
      <div class="add-header">
        <h3 style="margin:0">Dodaj pozycję</h3>
        <div class="right">
          <button id="clearBtn" class="ghost">Wyczyść</button>
          <button id="saveItemBtn" class="primary">Zapisz</button>
        </div>
      </div>

      <div class="two-col">
        <!-- LEWA: DANE -->
        <div class="card" style="margin:0">
          <h4 style="margin:0 0 8px 0">Dane pozycji</h4>

          <div class="date-compact" style="margin-bottom:10px">
            <div class="col" style="min-width:auto;flex:0 0 auto">
              <label class="mini">Dzień</label>
              <input id="addDay" class="small" type="number" min="1" max="31" />
            </div>
            <div class="col" style="min-width:auto;flex:0 0 auto">
              <label class="mini">Miesiąc</label>
              <select id="addMonth" class="month"></select>
            </div>
            <div class="col" style="min-width:auto;flex:0 0 auto">
              <label class="mini">Rok</label>
              <input id="addYear" class="small" type="number" min="2020" max="2100" />
            </div>
          </div>

          <div class="row">
            <div class="col">
              <label class="mini">Rozmiar</label>
              <select id="addSize">
                <option>S</option><option>M</option><option>L</option>
                <option>XL</option><option>XXL</option><option>3XL</option>
              </select>
            </div>
            <div class="col">
              <label class="mini">Kolor</label>
              <select id="addColor"><option>BIAŁA</option><option>CZARNA</option></select>
            </div>
            <div class="col">
              <label class="mini">Cena (brutto, PLN)</label>
              <input id="addPrice" type="number" step="0.01" placeholder="np. 70" />
            </div>
          </div>

          <div class="row">
            <div class="col">
              <label class="mini">Zamawiający (login/imię)</label>
              <input id="addCustomer" type="text" />
            </div>
            <div class="col">
              <label class="mini">Uwagi</label>
              <input id="addNote" type="text" placeholder="np. mały druk na środku" />
            </div>
            <div class="col">
              <label class="mini">ID zamówienia (grupowanie pozycji)</label>
              <input id="addOrderGroup" type="text" placeholder="np. 2025-10-03-iva766" />
            </div>
          </div>

          <div class="hint">Po zapisaniu status = “ZAMÓWIENIE PRZYJĘTE”. Zmienisz go później na liście.</div>
        </div>

        <!-- PRAWA: WZÓR -->
        <div class="card" style="margin:0">
          <h4 style="margin:0 0 8px 0">Wybierz wzór lub dodaj CUSTOM</h4>
          <div class="row">
            <div class="col"><input id="designSearch" placeholder="Szukaj wzoru po nazwie..." /></div>
            <div class="col">
              <label class="mini">Własna grafika (CUSTOM) – podgląd</label>
              <input id="customFile" type="file" accept="image/*,.svg,.pdf" />
            </div>
          </div>
          <div id="designGridAdd" class="grid" style="margin-top:10px"></div>
          <div class="hint">Kliknij kafelek, żeby wybrać wzór. Jeśli wgrasz plik CUSTOM – to on zostanie użyty.</div>
        </div>
      </div>

      <div id="saveMsg" class="hint" style="margin-top:8px"></div>
    </div>

    <!-- DESIGNS TAB -->
    <div id="tab-designs" class="card" style="display:none">
      <h3>Wzory (tekst + podgląd)</h3>
      <div class="row">
        <div class="col"><input id="designName" placeholder="Nazwa wzoru, np. kitty red bull blue" /></div>
        <div class="col"><input id="designFile" type="file" accept="image/*,.svg,.pdf" /></div>
        <div class="col" style="max-width:220px"><button id="addDesignBtn" class="primary">Dodaj wzór</button></div>
      </div>
      <div id="designsList" class="grid" style="margin-top:10px"></div>
      <div class="hint">Miniatura jest tylko podglądem (np. PNG/JPG/SVG). Wzór usuniesz przyciskiem na kafelku.</div>
    </div>
  </div>
</div>

<script type="module">
  // Firebase SDK (CDN)
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
  import {
    getFirestore, collection, addDoc, doc, setDoc, updateDoc, deleteDoc,
    getDocs, query, where, orderBy, onSnapshot, serverTimestamp, Timestamp
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
  import {
    getStorage, ref as sRef, uploadBytes, getDownloadURL, deleteObject
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-storage.js";

  // Twój firebaseConfig
  const firebaseConfig = {
    apiKey: "AIzaSyCGNcCqcQdLoOnWFEI1a7XhAsQtj6ECvfg",
    authDomain: "papierek-idzie-do-gory.firebaseapp.com",
    projectId: "papierek-idzie-do-gory",
    storageBucket: "papierek-idzie-do-gory.firebasestorage.app",
    messagingSenderId: "1063966015801",
    appId: "1:1063966015801:web:72f412aa200a705276a8e8"
  };

  // Init
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const storage = getStorage(app);

  // Helpers
  const $ = (id) => document.getElementById(id);
  const fmt2 = (n) => (Number(n || 0)).toFixed(2);
  const monthsPL = ["styczeń","luty","marzec","kwiecień","maj","czerwiec","lipiec","sierpień","wrzesień","październik","listopad","grudzień"];
  const monthsPLGen = ["stycznia","lutego","marca","kwietnia","maja","czerwca","lipca","sierpnia","września","października","listopada","grudnia"];
  const fmtDatePLLong = (d)=>{ const dt=d instanceof Date?d:(d?.toDate?d.toDate():new Date(d)); return `${dt.getDate()} ${monthsPLGen[dt.getMonth()]} ${dt.getFullYear()}`;};
  const toMonthKey = (d)=>{ const dt=d instanceof Date?d:(d?.toDate?d.toDate():new Date(d)); return `${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,"0")}`;};
  const statusClass = (s)=> s==="WYSŁANE"?"s-wys":s==="ZWROT"?"s-zw":s==="W PRODUKCJI"?"s-wpr":"s-new";
  const esc = (s)=> (s||"").replace(/</g,"&lt;");

  // UI refs
  const loginCard=$("loginCard"), appWrap=$("app"), userEmail=$("userEmail"), loginBtn=$("loginBtn"), logoutBtn=$("logoutBtn"), loginMsg=$("loginMsg");

  // Tabs
  const tabsBtns = document.querySelectorAll("nav.tabs button");
  const tabs = { orders:$("tab-orders"), add:$("tab-add"), designs:$("tab-designs") };
  tabsBtns.forEach(btn=>btn.addEventListener("click",()=>{
    tabsBtns.forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    Object.values(tabs).forEach(el=>el.style.display="none");
    tabs[btn.dataset.tab].style.display="";
  }));

  // Auth
  loginBtn.onclick = async () => {
    loginMsg.textContent = "Logowanie…";
    try { await signInWithEmailAndPassword(auth, $("email").value, $("password").value); loginMsg.textContent=""; }
    catch(e){ loginMsg.textContent = "Błąd logowania: " + (e.message || e.code); }
  };
  logoutBtn.onclick = () => signOut(auth);

  onAuthStateChanged(auth, (u) => {
    if (u) { loginCard.style.display="none"; appWrap.style.display=""; userEmail.textContent=u.email||""; logoutBtn.style.display=""; initAppAfterLogin(); }
    else { loginCard.style.display=""; appWrap.style.display="none"; userEmail.textContent=""; logoutBtn.style.display="none"; }
  });

  // State for ADD
  let selectedDesignId = null;
  let selectedDesignName = "";
  let selectedDesignPreview = "";
  const designMap = new Map();

  // After login – initial load
  async function initAppAfterLogin() {
    const now = new Date();
    $("monthPicker").value = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,"0")}`;

    $("addDay").value = now.getDate();
    $("addMonth").innerHTML = monthsPL.map((m,i)=>`<option value="${i}">${m}</option>`).join("");
    $("addMonth").value = String(now.getMonth());
    $("addYear").value = now.getFullYear();

    await loadDesignsList();       // karta "Wzory"
    await loadDesignsGridForAdd(); // kafelki do wyboru

    subscribeMonth();

    $("monthPicker").addEventListener("change", subscribeMonth);
    $("filterStatus").addEventListener("change", subscribeMonth);

    $("saveItemBtn").addEventListener("click", saveItem);
    $("clearBtn").addEventListener("click", clearAddForm);
    $("addDesignBtn").addEventListener("click", addDesign);
    $("designSearch").addEventListener("input", loadDesignsGridForAdd);
  }

  function buildDateFromInputs(){
    const d=Number($("addDay").value||1);
    const m=Number($("addMonth").value||0);
    const y=Number($("addYear").value||new Date().getFullYear());
    return new Date(y,m,d,12,0,0);
  }

  async function loadDesignsGridForAdd(){
    const grid=$("designGridAdd"); grid.innerHTML="";
    const term = $("designSearch").value?.toLowerCase() || "";
    designMap.clear();
    const snap = await getDocs(query(collection(db,"designs"), orderBy("name")));
    const items=[]; snap.forEach(d=>{ const obj={id:d.id, ...d.data()}; items.push(obj); designMap.set(d.id,obj); });
    const filtered = term? items.filter(x=>x.name.toLowerCase().includes(term)): items;
    filtered.forEach(d=>{
      const div=document.createElement("div");
      div.className = "design-card" + (selectedDesignId===d.id?" selected":"");
      div.innerHTML = `
        ${d.previewUrl?`<img class="design-img" src="${d.previewUrl}" alt="">`:`<div class="design-img" style="display:flex;align-items:center;justify-content:center;color:#5a6c81">brak podglądu</div>`}
        <div class="design-name">${esc(d.name)}</div>`;
      div.onclick=()=>{
        selectedDesignId=d.id; selectedDesignName=d.name; selectedDesignPreview=d.previewUrl||"";
        document.querySelectorAll(".design-card").forEach(el=>el.classList.remove("selected"));
        div.classList.add("selected");
        $("customFile").value = ""; // jeśli wybierzesz wzór – czyścimy CUSTOM
      };
      grid.appendChild(div);
    });
  }

  async function loadDesignsList(){
    const box=$("designsList"); box.innerHTML="";
    const snap = await getDocs(query(collection(db,"designs"), orderBy("name")));
    snap.forEach(d=>{
      const data=d.data();
      const card=document.createElement("div");
      card.className="design-card";
      card.style.justifyContent="space-between";
      card.innerHTML=`
        ${data.previewUrl?`<img class="design-img" src="${data.previewUrl}" alt="">`:`<div class="design-img" style="display:flex;align-items:center;justify-content:center;color:#5a6c81">brak podglądu</div>`}
        <div class="design-name">${esc(data.name)}</div>
        <button data-id="${d.id}" class="ghost" style="margin-top:8px">Usuń</button>
      `;
      box.appendChild(card);
      card.querySelector("button").onclick=async()=>{
        if(!confirm("Usunąć wzór?")) return;
        // jeśli mamy ścieżkę pliku – spróbuj usunąć
        if (data.previewPath) {
          try { await deleteObject(sRef(storage, data.previewPath)); } catch(e){ console.warn("Nie udało się usunąć pliku podglądu:", e.message); }
        }
        await deleteDoc(doc(db,"designs", d.id));
        await loadDesignsList();
        await loadDesignsGridForAdd();
      };
    });
  }

  async function addDesign(){
    const name = $("designName").value.trim();
    const file = $("designFile").files[0] || null;
    if (!name) return alert("Podaj nazwę wzoru.");
    const slug = name.toLowerCase().replace(/\s+/g,"-").replace(/[^a-z0-9\-]/g,"");
    let previewUrl=null, previewPath=null;
    if (file){
      const ext = (file.name.split(".").pop()||"bin").toLowerCase();
      previewPath = `designs/${slug}-${Date.now()}.${ext}`;
      const ref = sRef(storage, previewPath);
      await uploadBytes(ref, file);
      previewUrl = await getDownloadURL(ref);
    }
    await setDoc(doc(db,"designs", slug), {
      name, slug, active:true, previewUrl:previewUrl||null, previewPath:previewPath||null,
      createdAt: serverTimestamp(), updatedAt: serverTimestamp()
    }, { merge:true });
    $("designName").value=""; $("designFile").value="";
    await loadDesignsList();
    await loadDesignsGridForAdd();
  }

  function clearAddForm(){
    selectedDesignId=null; selectedDesignName=""; selectedDesignPreview="";
    $("customFile").value=""; $("addCustomer").value=""; $("addNote").value=""; $("addPrice").value="";
    document.querySelectorAll(".design-card").forEach(el=>el.classList.remove("selected"));
    $("saveMsg").textContent="";
  }

  async function saveItem(){
    const date = buildDateFromInputs();
    const price = Number($("addPrice").value || 0);
    if (!price) return alert("Podaj cenę.");
    // CUSTOM file?
    const cFile = $("customFile").files[0] || null;
    let designId = null, designText = "", previewUrl = null, previewPath = null;

    if (cFile){
      const ext = (cFile.name.split(".").pop()||"bin").toLowerCase();
      previewPath = `custom/${Date.now()}-${Math.random().toString(36).slice(2)}.${ext}`;
      const ref = sRef(storage, previewPath);
      await uploadBytes(ref, cFile);
      previewUrl = await getDownloadURL(ref);
      designId = "custom";
      designText = "CUSTOM";
    } else if (selectedDesignId){
      designId = selectedDesignId;
      designText = selectedDesignName;
      previewUrl = selectedDesignPreview || null;
    } else {
      return alert("Wybierz wzór z kafelków lub wgraj plik CUSTOM.");
    }

    const payload = {
      date: Timestamp.fromDate(date),
      monthKey: toMonthKey(date),
      status: "ZAMÓWIENIE PRZYJĘTE", // domyślnie
      size: $("addSize").value,
      color: $("addColor").value,
      designId,
      designText,
      previewUrl: previewUrl || null,
      previewPath: previewPath || null,
      customer: $("addCustomer").value.trim(),
      note: $("addNote").value.trim(),
      priceGross: price,
      orderGroupId: $("addOrderGroup").value.trim() || null,
      createdAt: serverTimestamp(),
      updatedAt: serverTimestamp()
    };

    try{
      $("saveMsg").textContent="Zapisywanie…";
      await addDoc(collection(db,"orderItems"), payload);
      $("saveMsg").textContent="Zapisano ✅";
      clearAddForm();
    }catch(e){
      $("saveMsg").textContent="Błąd: " + (e.message || e.code);
    }
    setTimeout(()=>{$("saveMsg").textContent="";},1500);
  }

  // Subscribe monthly list
  let unsub=null;
  function subscribeMonth(){
    if (unsub){unsub();unsub=null;}
    const mk=$("monthPicker").value;
    const statusFilter=$("filterStatus").value;
    const q1=query(collection(db,"orderItems"), where("monthKey","==",mk), orderBy("date","desc"));
    unsub=onSnapshot(q1,(snap)=>{
      const rows=[]; let sumC=0;
      snap.forEach(docu=>{
        const d=docu.data();
        if (statusFilter!=="ALL" && d.status!==statusFilter) return;
        sumC += (d.priceGross||0);
        rows.push({id:docu.id, ...d});
      });
      renderRows(rows); $("sumCena").textContent=fmt2(sumC);
    },(err)=>{
      console.error(err);
      alert("Błąd odczytu. Jeśli pojawił się link do indeksu – kliknij i utwórz indeks w Firestore.");
    });
  }

  function renderRows(items){
    const tbody=$("ordersTbody"); tbody.innerHTML="";
    for(const it of items){
      const tr=document.createElement("tr");
      const dstr=fmtDatePLLong(it.date);
      tr.innerHTML=`
        <td>${dstr}</td>
        <td><span class="status ${statusClass(it.status)}">${it.status||"ZAMÓWIENIE PRZYJĘTE"}</span></td>
        <td>${it.size||""}</td>
        <td>${it.color||""}</td>
        <td>
          <div class="designCell">
            ${it.previewUrl?`<img class="designThumb" src="${it.previewUrl}" alt="">`:""}
            <span>${esc(it.designText||"")}</span>
          </div>
        </td>
        <td>${esc(it.customer||"")}</td>
        <td>${esc(it.note||"")}</td>
        <td>${fmt2(it.priceGross)} zł</td>
        <td>${it.orderGroupId||""}</td>
        <td>
          <button class="ghost mini" data-act="status" data-id="${it.id}">↻ status</button>
          <button class="ghost mini" data-act="del" data-id="${it.id}" style="color:var(--red)">usuń</button>
        </td>
      `;
      tr.querySelector('[data-act="status"]').onclick=async()=>{
        const nxt=prompt('Nowy status: ZAMÓWIENIE PRZYJĘTE / W PRODUKCJI / WYSŁANE / ZWROT', it.status||"ZAMÓWIENIE PRZYJĘTE");
        if(!nxt) return;
        await updateDoc(doc(db,"orderItems", it.id), { status:nxt, updatedAt: serverTimestamp() });
      };
      tr.querySelector('[data-act="del"]').onclick=async()=>{
        if(!confirm("Usunąć tę pozycję?")) return;
        await deleteDoc(doc(db,"orderItems", it.id));
      };
      tbody.appendChild(tr);
    }
  }
</script>
</body>
</html>