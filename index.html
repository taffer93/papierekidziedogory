<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Koszulki – panel</title>
  <style>
    :root {
      --bg:#0b0f14; --card:#121820; --muted:#8aa0b6; --text:#e8f1ff; --accent:#4cc9f0;
      --green:#2ec27e; --red:#ff6b6b; --amber:#f9a825; --blue:#64b5f6; --ready:#8ecae6;
    }
    *{box-sizing:border-box} body{margin:0;font-family:system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text)}
    header{padding:16px 20px;border-bottom:1px solid #243344;display:flex;justify-content:space-between;align-items:center;gap:10px}
    h1{font-size:18px;margin:0} .muted{color:var(--muted)}
    .wrap{max-width:1200px;margin:0 auto;padding:16px}
    .card{background:var(--card);border:1px solid #1e2a39;border-radius:12px;padding:14px;margin-bottom:14px}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .row.center{align-items:center}
    .col{flex:1 1 220px;min-width:220px}
    input,select,button,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid #2a3a4d;background:#0d131b;color:var(--text)}
    button{cursor:pointer;background:#19344b;border-color:#274d6a}
    button.primary{background:linear-gradient(180deg,#2a87b9,#1b5f86);border-color:#1b5f86;font-weight:600}
    button.ghost{background:#0d131b;border-color:#2a3a4d}
    .mini-btn{padding:6px 10px;border-radius:8px}
    nav.tabs{display:flex;gap:8px;margin:10px 0 14px 0;flex-wrap:wrap}
    nav.tabs button{flex:0 0 auto;padding:8px 12px;border-radius:10px}
    nav.tabs button.active{outline:2px solid var(--accent)}
    table{width:100%;border-collapse:collapse;font-size:14px}
    th,td{border-bottom:1px solid #233244;padding:8px 6px;text-align:left;vertical-align:middle}
    tr:hover{background:#0e1620}
    .status-pill{padding:3px 8px;border-radius:999px;font-weight:600;font-size:12px;display:inline-block}
    .s-new{background:rgba(100,181,246,.15);color:var(--blue)}
    .s-wpr{background:rgba(249,168,37,.15);color:var(--amber)}
    .s-ready{background:rgba(142,202,230,.15);color:var(--ready)}
    .s-wys{background:rgba(46,194,126,.15);color:var(--green)}
    .s-zw{background:rgba(255,107,107,.15);color:var(--red)}
    .toolbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:10px}
    .right{margin-left:auto}
    .hint{font-size:12px;color:var(--muted)}
    .pill{padding:6px 10px;border-radius:99px;background:#0d131b;border:1px solid #2a3a4d}
    .mini{font-size:12px}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:10px}
    .design-card{border:1px solid #2a3a4d;border-radius:12px;padding:10px;cursor:pointer;background:#0d131b;text-align:center}
    .design-card:hover{border-color:#3c5875}
    .design-card.selected{outline:2px solid var(--accent);background:#11202c}
    .design-img{width:100%;height:110px;object-fit:cover;border-radius:10px;border:1px solid #2a3a4d;background:#0b1118}
    .design-name{margin-top:8px;font-weight:600}
    .add-header{display:flex;align-items:center;gap:10px;margin-bottom:10px}
    .add-header .right{display:flex;gap:10px;margin-left:auto}
    .rows-wrap{overflow:auto}
    .rows-table thead th{position:sticky;top:0;background:#16202b;z-index:1}
    .rows-table td .thumb{width:42px;height:42px;object-fit:cover;border-radius:6px;border:1px solid #2a3a4d;background:#0b1118}
    .rows-actions{display:flex;gap:6px}
    /* kompaktowa data */
    .date-compact{display:flex;gap:8px;align-items:center}
    .date-compact .small{max-width:90px;padding:8px}
    .date-compact .month{max-width:140px;padding:8px}
    input[type=number]::-webkit-outer-spin-button,
    input[type=number]::-webkit-inner-spin-button{ -webkit-appearance:none; margin:0;}
    input[type=number]{ -moz-appearance:textfield;}
    /* input file – spójny wygląd */
    input[type="file"]{padding:8px;background:#0d131b;border:1px solid #2a3a4d;color:var(--muted)}
    input[type="file"]::file-selector-button{
      margin-right:10px;border:1px solid #274d6a;background:#19344b;color:var(--text);
      padding:6px 10px;border-radius:8px;cursor:pointer
    }
    /* wzór i kolor w liście zamówień */
    .designCell{display:flex;align-items:center;gap:8px}
    .designThumb{width:40px;height:40px;object-fit:cover;border-radius:6px;border:1px solid #2a3a4d;background:#0b1118}
    .colorTag{display:inline-flex;align-items:center;gap:6px;border:1px solid #2a3a4d;border-radius:999px;padding:2px 8px}
    .dot{width:12px;height:12px;border-radius:50%;border:1px solid #2a3a4d;background:#fff}
    .dot.black{background:#000}
    /* grupowanie zamówień w tabeli */
    tr.grp0 td{background:#0e1620}
    tr.grp1 td{background:#0f1a24}
    /* modal wyboru wzoru */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:1000}
    .modal .panel{background:var(--card);border:1px solid #1e2a39;border-radius:12px;width:min(900px,92vw);max-height:85vh;padding:14px;display:flex;flex-direction:column}
    .modal .panel .head{display:flex;gap:10px;align-items:center;margin-bottom:10px}
    .modal .panel .head .right{margin-left:auto}
    .danger{color:var(--red)}
  </style>
</head>
<body>
<header>
  <h1>Koszulki – panel</h1>
  <div>
    <span id="userEmail" class="muted"></span>
    <button id="logoutBtn" class="ghost" style="display:none">Wyloguj</button>
  </div>
</header>

<div class="wrap">

  <!-- LOGIN -->
  <div id="loginCard" class="card" style="max-width:460px;">
    <h3>Zaloguj się</h3>
    <div class="row center">
      <div class="col"><input id="email" type="email" placeholder="Email" /></div>
      <div class="col"><input id="password" type="password" placeholder="Hasło" /></div>
    </div>
    <div class="row center">
      <div class="col"><button id="loginBtn" class="primary">Zaloguj</button></div>
      <div class="col"><div id="loginMsg" class="hint"></div></div>
    </div>
  </div>

  <!-- APP -->
  <div id="app" style="display:none">
    <nav class="tabs">
      <button data-tab="orders" class="active">Zamówienia (miesiąc)</button>
      <button data-tab="add">Dodaj zamówienie</button>
      <button data-tab="designs">Wzory</button>
    </nav>

    <!-- ORDERS TAB -->
    <div id="tab-orders" class="card">
      <div class="toolbar">
        <div>
          <label class="mini">Miesiąc</label>
          <input id="monthPicker" type="month" />
        </div>
        <div>
          <label class="mini">Status</label>
          <select id="filterStatus">
            <option value="ALL">Wszystkie</option>
            <option value="ZAMÓWIENIE PRZYJĘTE">ZAMÓWIENIE PRZYJĘTE</option>
            <option value="W TRAKCIE REALIZACJI">W TRAKCIE REALIZACJI</option>
            <option value="GOTOWE DO WYSYŁKI">GOTOWE DO WYSYŁKI</option>
            <option value="WYSŁANE">WYSŁANE</option>
            <option value="ZWROT">ZWROT</option>
          </select>
        </div>
        <div class="right pill">Suma (m‑c): <b id="sumCena">0.00</b> zł</div>
      </div>

      <div style="overflow:auto">
        <table>
          <thead>
            <tr>
              <th>Data</th>
              <th>Status</th>
              <th>Rozmiar</th>
              <th>Kolor</th>
              <th>Wzór</th>
              <th>Zamawiający</th>
              <th>Uwagi</th>
              <th>Cena (łącznie)</th>
              <th>ID zamówienia</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="ordersTbody"></tbody>
        </table>
      </div>
      <div class="hint">Po zmianie statusu w rozwijanym menu – aktualizowane są wszystkie pozycje w danym zamówieniu.</div>
    </div>

    <!-- ADD ORDER TAB -->
    <div id="tab-add" class="card" style="display:none">
      <div class="add-header">
        <h3 style="margin:0">Dodaj zamówienie</h3>
        <div class="right">
          <button id="addRowBtn" class="ghost">+ Dodaj pozycję</button>
          <button id="clearOrderBtn" class="ghost">Wyczyść</button>
          <button id="saveOrderBtn" class="primary">Zapisz wszystkie pozycje</button>
        </div>
      </div>

      <!-- Dane wspólne zamówienia -->
      <div class="card" style="margin:0 0 10px 0">
        <h4 style="margin:0 0 8px 0">Dane zamówienia</h4>
        <div class="row center">
          <div class="date-compact">
            <div class="col" style="min-width:auto;flex:0 0 auto">
              <label class="mini">Dzień</label>
              <input id="addDay" class="small" type="number" min="1" max="31" />
            </div>
            <div class="col" style="min-width:auto;flex:0 0 auto">
              <label class="mini">Miesiąc</label>
              <select id="addMonth" class="month"></select>
            </div>
            <div class="col" style="min-width:auto;flex:0 0 auto">
              <label class="mini">Rok</label>
              <input id="addYear" class="small" type="number" min="2020" max="2100" />
            </div>
          </div>

          <div class="col">
            <label class="mini">Zamawiający (login/imię)</label>
            <input id="orderCustomer" type="text" />
          </div>
          <div class="col">
            <label class="mini">Cena łączna zamówienia (PLN)</label>
            <input id="orderTotalPrice" type="number" step="0.01" placeholder="np. 210" />
          </div>
          <div class="col">
            <label class="mini">ID zamówienia (opcjonalnie)</label>
            <input id="orderGroupId" type="text" placeholder="np. 2025-10-03-iva766 (puste = automatycznie)" />
          </div>
        </div>
      </div>

      <!-- Pozycje -->
      <div class="card" style="margin:0">
        <h4 style="margin:0 0 8px 0">Pozycje</h4>
        <div class="rows-wrap">
          <table class="rows-table" style="width:100%">
            <thead>
              <tr>
                <th style="width:35%">Wzór</th>
                <th style="width:10%">Rozmiar</th>
                <th style="width:12%">Kolor</th>
                <th>Uwagi</th>
                <th style="width:120px"></th>
              </tr>
            </thead>
            <tbody id="rowsTbody"></tbody>
          </table>
        </div>
      </div>

      <div id="saveMsg" class="hint" style="margin-top:8px"></div>
    </div>

    <!-- DESIGNS TAB -->
    <div id="tab-designs" class="card" style="display:none">
      <h3>Wzory (z podglądem)</h3>

      <div class="row center">
        <div class="col"><input id="designName" placeholder="Nazwa wzoru, np. kitty red bull blue" /></div>
        <div class="col"><input id="designFile" type="file" accept="image/*" /></div>
        <div class="col" style="max-width:220px"><button id="addDesignBtn" class="primary">Dodaj wzór</button></div>
      </div>
      <div id="designMsg" class="hint" style="margin:6px 0 10px 0"></div>

      <div id="designsList" class="grid" style="margin-top:10px"></div>
      <div class="hint">“Edytuj” pozwala zmienić nazwę i/lub podmienić miniaturę.</div>
    </div>
  </div>
</div>

<!-- MODAL – wybór wzoru do pozycji -->
<div id="designPicker" class="modal">
  <div class="panel">
    <div class="head">
      <strong>Wybierz wzór</strong>
      <div class="right">
        <button id="pickerClose" class="ghost mini-btn">Zamknij</button>
      </div>
    </div>
    <div class="row center">
      <div class="col"><input id="pickerSearch" placeholder="Szukaj wzoru po nazwie..." /></div>
      <div class="col">
        <label class="mini">Albo wgraj CUSTOM dla tej pozycji</label>
        <input id="pickerCustomFile" type="file" accept="image/*" />
      </div>
    </div>
    <div id="pickerGrid" class="grid" style="margin-top:10px"></div>
    <div class="hint">Kliknij kafelek, aby przypisać wzór do tej pozycji. Wgranie pliku ustawi tę pozycję jako CUSTOM.</div>
  </div>
</div>

<script type="module">
  // Stabilne SDK (10.12.2)
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import {
    getFirestore, collection, addDoc, doc, setDoc, updateDoc, deleteDoc,
    getDocs, query, where, onSnapshot, serverTimestamp, Timestamp, writeBatch
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  // Detektor błędów JS (ułatwia diagnozę)
  window.addEventListener('error', e => alert('Błąd skryptu: ' + (e.message || e.error?.message || 'unknown')));
  window.addEventListener('unhandledrejection', e => alert('Błąd (promise): ' + (e.reason?.message || e.reason || 'unknown')));

  // KONFIG – Twój projekt
  const firebaseConfig = {
    apiKey: "AIzaSyCGNcCqcQdLoOnWFEI1a7XhAsQtj6ECvfg",
    authDomain: "papierek-idzie-do-gory.firebaseapp.com",
    projectId: "papierek-idzie-do-gory",
    storageBucket: "papierek-idzie-do-gory.firebasestorage.app",
    messagingSenderId: "1063966015801",
    appId: "1:1063966015801:web:72f412aa200a705276a8e8"
  };
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // Helpers
  const $ = (id) => document.getElementById(id);
  const esc = (s)=> (s||"").replace(/</g,"&lt;");
  const fmt2 = (n) => (Number(n || 0)).toFixed(2);
  const monthsPL = ["styczeń","luty","marzec","kwiecień","maj","czerwiec","lipiec","sierpień","wrzesień","październik","listopad","grudzień"];
  const monthsPLGen = ["stycznia","lutego","marca","kwietnia","maja","czerwca","lipca","sierpnia","września","października","listopada","grudnia"];
  const fmtDatePLLong = (d)=>{ const dt=d instanceof Date?d:(d?.toDate?d.toDate():new Date(d)); return `${dt.getDate()} ${monthsPLGen[dt.getMonth()]} ${dt.getFullYear()}`;};
  const toMonthKey = (d)=>{ const dt=d instanceof Date?d:(d?.toDate?d.toDate():new Date(d)); return `${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,"0")}`;};
  const STATUSES = ["ZAMÓWIENIE PRZYJĘTE","W TRAKCIE REALIZACJI","GOTOWE DO WYSYŁKI","WYSŁANE","ZWROT"];
  const statusClass = (s)=> s==="WYSŁANE"?"s-wys":s==="ZWROT"?"s-zw":s==="W TRAKCIE REALIZACJI"?"s-wpr":s==="GOTOWE DO WYSYŁKI"?"s-ready":"s-new";

  // Kompresja obrazu → dataURL (miniatura w Firestore)
  async function fileToDataUrl(file, maxW=900, maxH=900, quality=0.82){
    return new Promise((resolve, reject)=>{
      const img = new Image();
      const reader = new FileReader();
      reader.onload = e => { img.src = e.target.result; };
      reader.onerror = reject;
      img.onload = () => {
        let w = img.width, h = img.height;
        const scale = Math.min(maxW / w, maxH / h, 1);
        const cw = Math.round(w * scale), ch = Math.round(h * scale);
        const canvas = document.createElement('canvas');
        canvas.width = cw; canvas.height = ch;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, cw, ch);
        let dataUrl = canvas.toDataURL('image/jpeg', quality);
        if (dataUrl.length > 950000) dataUrl = canvas.toDataURL('image/jpeg', 0.7);
        resolve(dataUrl);
      };
      img.onerror = reject;
      reader.readAsDataURL(file);
    });
  }

  // Auth UI
  const loginCard=$("loginCard"), appWrap=$("app"), userEmail=$("userEmail"), loginBtn=$("loginBtn"), logoutBtn=$("logoutBtn"), loginMsg=$("loginMsg");
  loginBtn.onclick = async () => { loginMsg.textContent = "Logowanie…"; try{ await signInWithEmailAndPassword(auth, $("email").value, $("password").value); loginMsg.textContent=""; }catch(e){ loginMsg.textContent="Błąd: "+(e.message||e.code); } };
  logoutBtn.onclick = () => signOut(auth);
  onAuthStateChanged(auth, (u) => {
    if (u) { loginCard.style.display="none"; appWrap.style.display=""; userEmail.textContent=u.email||""; logoutBtn.style.display=""; initAppAfterLogin(); }
    else { loginCard.style.display=""; appWrap.style.display="none"; userEmail.textContent=""; logoutBtn.style.display="none"; }
  });

  // Designs cache + order state
  const designMap = new Map();
  let orderRows = [];
  let pickerRowIndex = null;

  async function initAppAfterLogin(){
    // miesiąc w tabeli
    const now = new Date();
    $("monthPicker").value = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,"0")}`;
    // data w formularzu
    $("addDay").value = now.getDate();
    $("addMonth").innerHTML = monthsPL.map((m,i)=>`<option value="${i}">${m}</option>`).join("");
    $("addMonth").value = String(now.getMonth());
    $("addYear").value = now.getFullYear();

    await reloadDesigns();
    subscribeMonth();

    // Listeners
    $("monthPicker").addEventListener("change", subscribeMonth);
    $("filterStatus").addEventListener("change", subscribeMonth);
    $("addDesignBtn").addEventListener("click", onAddDesign);
    $("addRowBtn").addEventListener("click", ()=>addRow());
    $("clearOrderBtn").addEventListener("click", clearOrderForm);
    $("saveOrderBtn").addEventListener("click", saveOrder);
    $("pickerClose").addEventListener("click", closePicker);
    $("pickerSearch").addEventListener("input", renderPickerGrid);

    addRow(); // jedna pozycja startowo
  }

  // ----- Designs (CRUD) -----
  async function reloadDesigns(){
    designMap.clear();
    const snap = await getDocs(query(collection(db,"designs")));
    snap.forEach(d => designMap.set(d.id, { id:d.id, ...d.data() }));
    renderDesignsList();
    renderPickerGrid();
  }

  function renderDesignsList(){
    const box = $("designsList");
    box.innerHTML = "";
    for (const d of Array.from(designMap.values()).sort((a,b)=>a.name.localeCompare(b.name,"pl"))){
      const card = document.createElement("div");
      card.className = "design-card";
      card.innerHTML = `
        ${d.previewUrl?`<img class="design-img" src="${d.previewUrl}" alt="">`:`<div class="design-img" style="display:flex;align-items:center;justify-content:center;color:#5a6c81">brak podglądu</div>`}
        <div class="design-name">${esc(d.name)}</div>
        <div class="row center" style="margin-top:8px">
          <button class="ghost mini-btn" data-act="edit">Edytuj</button>
          <button class="ghost mini-btn danger" data-act="del">Usuń</button>
        </div>
      `;
      box.appendChild(card);

      // Edycja
      card.querySelector('[data-act="edit"]').onclick = () => openEdit(card, d);
      // Usuwanie
      card.querySelector('[data-act="del"]').onclick = async () => {
        if (!confirm("Usunąć wzór?")) return;
        await deleteDoc(doc(db,"designs", d.id));
        $("designMsg").textContent = "Usunięto wzór.";
        await reloadDesigns();
        setTimeout(()=> $("designMsg").textContent="", 1200);
      };
    }
  }

  function openEdit(card, d){
    card.innerHTML = `
      <div class="row center">
        <div class="col"><input value="${esc(d.name)}" data-role="name"/></div>
        <div class="col"><input type="file" accept="image/*" data-role="file"/></div>
      </div>
      <div class="row center" style="margin-top:8px">
        <button class="primary mini-btn" data-act="save">Zapisz</button>
        <button class="ghost mini-btn" data-act="cancel">Anuluj</button>
      </div>
      <div class="hint mini" data-role="msg"></div>
    `;
    card.querySelector('[data-act="cancel"]').onclick = renderDesignsList;
    card.querySelector('[data-act="save"]').onclick = async () => {
      const name = card.querySelector('[data-role="name"]').value.trim();
      const file = card.querySelector('[data-role="file"]').files[0] || null;
      const msg = card.querySelector('[data-role="msg"]');
      if (!name) { msg.textContent="Podaj nazwę."; return; }
      try{
        let previewUrl = d.previewUrl || null;
        if (file){ previewUrl = await fileToDataUrl(file); }
        await setDoc(doc(db,"designs", d.id), { name, previewUrl, updatedAt: serverTimestamp() }, { merge:true });
        await reloadDesigns();
      }catch(e){ msg.textContent = "Błąd: " + (e.message||e.code); }
    };
  }

  async function onAddDesign(){
    const name = $("designName").value.trim();
    const file = $("designFile").files[0] || null;
    const out = $("designMsg");
    if (!name){ out.textContent="Podaj nazwę wzoru."; return; }
    const id = name.toLowerCase().replace(/\s+/g,"-").replace(/[^a-z0-9\-]/g,"");
    try{
      let previewUrl=null;
      if (file){ previewUrl = await fileToDataUrl(file); }
      await setDoc(doc(db,"designs", id), {
        name, active:true, previewUrl, createdAt: serverTimestamp(), updatedAt: serverTimestamp()
      }, { merge:true });
      $("designName").value=""; $("designFile").value="";
      out.textContent="Dodano wzór ✅";
      await reloadDesigns();
      setTimeout(()=>out.textContent="",1200);
    }catch(e){ out.textContent="Błąd: " + (e.message||e.code); }
  }

  // ----- Picker (modal) -----
  function openPicker(forRowIndex){
    pickerRowIndex = forRowIndex;
    $("pickerCustomFile").value="";
    $("pickerSearch").value="";
    renderPickerGrid();
    $("designPicker").style.display="flex";
  }
  function closePicker(){ $("designPicker").style.display="none"; pickerRowIndex=null; }

  function renderPickerGrid(){
    const grid = $("pickerGrid");
    const term = $("pickerSearch").value?.toLowerCase() || "";
    grid.innerHTML = "";
    const list = Array.from(designMap.values())
      .filter(d=> d.active!==false)
      .filter(d=> term ? d.name.toLowerCase().includes(term) : true)
      .sort((a,b)=>a.name.localeCompare(b.name,"pl"));
    for (const d of list){
      const card = document.createElement("div");
      card.className = "design-card";
      card.innerHTML = `
        ${d.previewUrl?`<img class="design-img" src="${d.previewUrl}" alt="">`:`<div class="design-img" style="display:flex;align-items:center;justify-content:center;color:#5a6c81">brak podglądu</div>`}
        <div class="design-name">${esc(d.name)}</div>
      `;
      card.onclick = () => {
        const r = orderRows[pickerRowIndex];
        r.designId = d.id; r.designName = d.name; r.previewUrl = d.previewUrl || null;
        r.customFile = null; r.customLocalUrl = null;
        renderOrderRows();
        closePicker();
      };
      grid.appendChild(card);
    }
  }

  $("pickerCustomFile").addEventListener("change", async (e)=>{
    const file = e.target.files[0];
    if (!file || pickerRowIndex==null) return;
    const r = orderRows[pickerRowIndex];
    r.designId = "custom"; r.designName = "CUSTOM";
    r.customFile = file;
    r.customLocalUrl = URL.createObjectURL(file);
    r.previewUrl = r.customLocalUrl;
    renderOrderRows();
    closePicker();
  });

  // ----- Order builder (rows) -----
  function defaultRow(){
    return { size:"M", color:"BIAŁA", note:"", designId:null, designName:"", previewUrl:null, customFile:null, customLocalUrl:null };
  }
  function addRow(){ orderRows.push(defaultRow()); renderOrderRows(); }
  function removeRow(i){ orderRows.splice(i,1); renderOrderRows(); if(orderRows.length===0) addRow(); }

  function renderOrderRows(){
    const tb = $("rowsTbody"); tb.innerHTML="";
    orderRows.forEach((r,i)=>{
      const tr = document.createElement("tr"); tr.dataset.idx = i;
      tr.innerHTML = `
        <td>
          <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
            ${r.previewUrl?`<img class="thumb" src="${r.previewUrl}" alt="">`:`<div class="thumb" style="display:flex;align-items:center;justify-content:center;color:#5a6c81">?</div>`}
            <div style="min-width:180px"><b>${esc(r.designName||"Nie wybrano")}</b></div>
            <div class="rows-actions">
              <button class="ghost mini-btn" data-act="pick">Wybierz wzór</button>
              <label class="ghost mini-btn" style="display:inline-flex;align-items:center;gap:6px;cursor:pointer">
                <input data-act="custom" type="file" accept="image/*" style="display:none"> Upload CUSTOM
              </label>
            </div>
          </div>
        </td>
        <td>
          <select data-act="size">
            ${["S","M","L","XL","XXL","3XL"].map(s=>`<option ${r.size===s?"selected":""}>${s}</option>`).join("")}
          </select>
        </td>
        <td>
          <select data-act="color">
            ${["BIAŁA","CZARNA"].map(c=>`<option ${r.color===c?"selected":""}>${c}</option>`).join("")}
          </select>
        </td>
        <td><input data-act="note" type="text" value="${esc(r.note)}" placeholder="Uwagi do tej pozycji"></td>
        <td class="rows-actions">
          <button class="ghost mini-btn danger" data-act="remove">Usuń</button>
        </td>
      `;
      tr.querySelector('[data-act="pick"]').onclick = () => openPicker(i);
      tr.querySelector('[data-act="remove"]').onclick = () => removeRow(i);
      tr.querySelector('[data-act="size"]').onchange = (e)=> r.size = e.target.value;
      tr.querySelector('[data-act="color"]').onchange = (e)=> r.color = e.target.value;
      tr.querySelector('[data-act="note"]').oninput = (e)=> r.note = e.target.value;
      tr.querySelector('[data-act="custom"]').onchange = (e)=>{
        const file = e.target.files[0];
        if (!file) return;
        r.designId = "custom"; r.designName = "CUSTOM";
        r.customFile = file;
        r.customLocalUrl = URL.createObjectURL(file);
        r.previewUrl = r.customLocalUrl;
        renderOrderRows();
      };
      tb.appendChild(tr);
    });
  }

  function clearOrderForm(){
    orderRows = [];
    addRow();
    $("orderCustomer").value = "";
    $("orderGroupId").value = "";
    $("orderTotalPrice").value = "";
    $("saveMsg").textContent = "";
  }

  function buildDateFromInputs(){
    const d=Number($("addDay").value||1);
    const m=Number($("addMonth").value||0);
    const y=Number($("addYear").value||new Date().getFullYear());
    return new Date(y,m,d,12,0,0);
  }

  function genGroupId(date, customer){
    const dt = date instanceof Date ? date : new Date(date);
    const y=dt.getFullYear(), m=String(dt.getMonth()+1).padStart(2,"0"), d=String(dt.getDate()).padStart(2,"0");
    const rnd = Math.random().toString(36).slice(2,6);
    const cust = (customer||"order").toLowerCase().replace(/[^a-z0-9]/g,"").slice(0,8);
    return `${y}-${m}-${d}-${cust||"order"}-${rnd}`;
  }

  async function saveOrder(){
    const msg = $("saveMsg");
    if (orderRows.length===0){ msg.textContent="Dodaj przynajmniej jedną pozycję."; return; }
    if (orderRows.some(r=>!r.designId && !r.customFile)){ msg.textContent="Każda pozycja musi mieć wybrany wzór lub CUSTOM."; return; }
    const total = Number($("orderTotalPrice").value || 0);
    if (!total){ msg.textContent="Podaj cenę łączną zamówienia."; return; }

    const date = buildDateFromInputs();
    const groupId = $("orderGroupId").value.trim() || genGroupId(date, $("orderCustomer").value.trim());
    const customer = $("orderCustomer").value.trim();

    msg.textContent = "Zapisywanie…";

    try{
      // Kompresja CUSTOM -> dataURL (miniatury)
      const processed = await Promise.all(orderRows.map(async (r)=>{
        let previewUrl = r.previewUrl || null;
        if (r.customFile) previewUrl = await fileToDataUrl(r.customFile);
        else if (r.designId) previewUrl = designMap.get(r.designId)?.previewUrl || null;
        return { ...r, previewUrl };
      }));

      // zapis wszystkich pozycji; cena łączna zapisywana w polu orderTotalGross w każdej pozycji
      for (const r of processed){
        const payload = {
          date: Timestamp.fromDate(date),
          monthKey: toMonthKey(date),
          status: "ZAMÓWIENIE PRZYJĘTE",
          size: r.size, color: r.color,
          designId: r.designId || (r.customFile ? "custom" : null),
          designText: r.designName || (r.designId ? designMap.get(r.designId)?.name : "") || "CUSTOM",
          previewUrl: r.previewUrl || null,
          customer,
          note: r.note || "",
          orderTotalGross: total,      // cena łączna zamówienia
          priceGross: 0,               // dla kompatybilności – nie używamy
          orderGroupId: groupId,
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        };
        await addDoc(collection(db,"orderItems"), payload);
      }
      msg.textContent = `Zapisano ${processed.length} pozycji ✅`;
      clearOrderForm();
    }catch(e){
      console.error(e);
      msg.textContent = "Błąd: " + (e.message || e.code);
    }
    setTimeout(()=> msg.textContent="", 2000);
  }

  // ----- Lista miesięczna (grupowanie po orderGroupId) -----
  let unsub=null;
  function subscribeMonth(){
    if (unsub){unsub();unsub=null;}
    const mk=$("monthPicker").value;
    const q1=query(collection(db,"orderItems"), where("monthKey","==",mk));
    unsub=onSnapshot(q1,(snap)=>{
      const docs=[]; snap.forEach(docu=> docs.push({id:docu.id, ...docu.data()}));
      // sortuj malejąco po dacie
      docs.sort((a,b)=>{
        const ta = (a.date?.toDate ? a.date.toDate().getTime() : new Date(a.date).getTime());
        const tb = (b.date?.toDate ? b.date.toDate().getTime() : new Date(b.date).getTime());
        return tb - ta;
      });
      // grupuj
      const groups = new Map();
      for (const d of docs){
        const gid = d.orderGroupId || d.id;
        if (!groups.has(gid)) groups.set(gid, { id:gid, items:[], date:d.date, customer:d.customer||"", status:d.status||"ZAMÓWIENIE PRZYJĘTE", total: Number(d.orderTotalGross||0) });
        const g = groups.get(gid);
        g.items.push(d);
        // jeśli któryś dokument ma inną cenę/ status – bierzemy pierwszą/ostatnią (spójność)
        if (d.orderTotalGross!=null) g.total = Number(d.orderTotalGross);
        if (d.status) g.status = d.status;
        if (d.customer) g.customer = d.customer;
        if (d.date) g.date = d.date;
      }
      renderOrdersGrouped(Array.from(groups.values()));
    },(err)=>{
      console.error(err);
      alert("Błąd odczytu: " + (err.message || err.code));
    });
  }

  async function updateGroupStatus(groupId, newStatus){
    const qSnap = await getDocs(query(collection(db,"orderItems"), where("orderGroupId","==",groupId)));
    const batch = writeBatch(db);
    qSnap.forEach(d => batch.update(doc(db,"orderItems", d.id), { status:newStatus, updatedAt: serverTimestamp() }));
    await batch.commit();
  }

  async function deleteGroup(groupId){
    if (!confirm("Usunąć CAŁE zamówienie (wszystkie pozycje)?")) return;
    const qSnap = await getDocs(query(collection(db,"orderItems"), where("orderGroupId","==",groupId)));
    const batch = writeBatch(db);
    qSnap.forEach(d => batch.delete(doc(db,"orderItems", d.id)));
    await batch.commit();
  }

  function renderOrdersGrouped(groups){
    const statusFilter = $("filterStatus").value;
    // filtr po statusie na poziomie grupy
    const filtered = statusFilter==="ALL" ? groups : groups.filter(g => (g.status||"ZAMÓWIENIE PRZYJĘTE")===statusFilter);

    // suma miesięczna = suma łącznych cen grup
    const sum = filtered.reduce((acc,g)=> acc + (Number(g.total)||0), 0);
    $("sumCena").textContent = fmt2(sum);

    const tbody = $("ordersTbody"); tbody.innerHTML="";
    let alt = 0;

    for (const g of filtered){
      // posortuj pozycje w grupie stabilnie (np. po rozmiarze)
      g.items.sort((a,b)=> (a.size||"").localeCompare(b.size||"") );

      g.items.forEach((it, idx)=>{
        const tr = document.createElement("tr");
        tr.className = "grp" + (alt % 2);
        const dstr=fmtDatePLLong(g.date);
        // status select (zmienia cały group)
        const sel = document.createElement("select");
        sel.innerHTML = STATUSES.map(s=>`<option ${s===(g.status||"ZAMÓWIENIE PRZYJĘTE")?"selected":""}>${s}</option>`).join("");
        sel.onchange = async (e)=>{
          const val = e.target.value;
          // podmień w UI wszystkie selecty tej grupy
          document.querySelectorAll(`select[data-gid="${g.id}"]`).forEach(x=> x.value = val);
          await updateGroupStatus(g.id, val);
        };
        sel.setAttribute("data-gid", g.id);

        tr.innerHTML = `
          <td>${idx===0?dstr:""}</td>
          <td data-status></td>
          <td>${it.size||""}</td>
          <td>
            <span class="colorTag">
              <span class="dot ${it.color==="CZARNA"?"black":""}"></span>
              ${it.color||""}
            </span>
          </td>
          <td>
            <div class="designCell">
              ${it.previewUrl?`<img class="designThumb" src="${it.previewUrl}" alt="">`:""}
              <span>${esc(it.designText||"")}</span>
            </div>
          </td>
          <td>${esc(g.customer||"")}</td>
          <td>${esc(it.note||"")}</td>
          <td>${idx===0?fmt2(g.total)+" zł":"—"}</td>
          <td>${idx===0?g.id:""}</td>
          <td>
            ${idx===0?`<button class="ghost mini danger" data-del="${g.id}">usuń</button>`:""}
          </td>
        `;
        tr.querySelector('[data-status]').appendChild(sel);
        if (idx===0){
          const delBtn = tr.querySelector(`[data-del="${g.id}"]`);
          delBtn.onclick = async ()=> { await deleteGroup(g.id); };
        }
        tbody.appendChild(tr);
      });

      alt++;
    }
  }

  // Tabs
  const tabsBtns = document.querySelectorAll("nav.tabs button");
  const tabs = { orders: $("tab-orders"), add: $("tab-add"), designs: $("tab-designs") };
  tabsBtns.forEach(btn => btn.addEventListener("click", () => {
    tabsBtns.forEach(b => b.classList.remove("active"));
    btn.classList.add("active");
    Object.values(tabs).forEach(el => el.style.display="none");
    tabs[btn.dataset.tab].style.display = "";
  }));
</script>
</body>
</html>