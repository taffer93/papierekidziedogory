<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Koszulki – panel (finanse + zaawansowane statystyki)</title>

  <style>
    :root{
      --bg:#0f1620; --card:#111827; --muted:#98a8bd; --text:#e6f2ff;
      --accent:#4cc9f0; --line:#213142;
      --st-new:rgba(90,245,140,.08); --st-prog:rgba(255,210,90,.06);
      --st-ready:rgba(120,235,255,.04); --st-sent:rgba(130,170,255,.04);
      --st-return:rgba(255,110,110,.06);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text)}
    header{padding:14px 20px;border-bottom:1px solid #17212b;display:flex;align-items:center;gap:12px}
    h1{font-size:18px;margin:0}
    .wrap{max-width:1280px;margin:18px auto;padding:12px}
    .card{background:var(--card);border:1px solid #16202a;border-radius:12px;padding:12px;margin-bottom:14px}
    nav.tabs{display:flex;gap:8px;margin:10px 0 14px 0;flex-wrap:wrap}
    nav.tabs button{background:#0b1720;color:var(--text);border:1px solid #20313f;padding:8px 12px;border-radius:8px;cursor:pointer}
    nav.tabs button.active{outline:2px solid var(--accent)}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .col{flex:1 1 260px;min-width:260px}
    input,select,button,textarea{width:100%;padding:8px;border-radius:8px;border:1px solid #253645;background:#081018;color:var(--text)}
    button.primary{background:linear-gradient(180deg,#2a87b9,#1b5f86);border-color:#1b5f86;color:#fff}
    table{width:100%;border-collapse:collapse;font-size:14px}
    th,td{padding:8px;border-bottom:1px solid #172a37;text-align:left}
    th{background:#0d2230}
    .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:10px}
    .right{margin-left:auto}
    .pill{padding:6px 10px;border-radius:999px;background:#07121a;border:1px solid #223243}
    .hint{color:var(--muted);font-size:13px}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:10px}
    .design-card{padding:8px;border-radius:10px;border:1px solid #203243;background:#08151f;text-align:center}
    .design-img{width:100%;height:100px;object-fit:cover;border-radius:8px;border:1px solid #1d2d3a;background:#071018}
    .thumb{width:48px;height:48px;border-radius:6px;object-fit:cover}
    .rows-actions{display:flex;gap:6px;align-items:center}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:2000}
    .modal .panel{background:var(--card);border-radius:10px;padding:12px;width:min(980px,96vw);max-height:88vh;overflow:auto;border:1px solid #162a36}
    /* charts: ensure boxes don't overlap */
    .chart-box{height:360px;display:flex;flex-direction:column;gap:8px}
    .chart-box canvas{flex:1;max-height:100%;width:100% !important}
    .chart-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    @media (max-width:900px){ .chart-grid{grid-template-columns:1fr} .col{min-width:unset} .chart-box{height:320px} }
  </style>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
<header>
  <h1>Koszulki – panel (finanse)</h1>
  <div style="margin-left:auto" id="userInfo"></div>
</header>

<div class="wrap">
  <!-- LOGIN CARD -->
  <div id="loginCard" class="card" style="max-width:520px">
    <h3>Logowanie</h3>
    <div class="row">
      <div class="col"><input id="email" type="email" placeholder="Email" /></div>
      <div class="col"><input id="password" type="password" placeholder="Hasło" /></div>
    </div>
    <div style="display:flex;gap:8px;margin-top:8px">
      <button id="loginBtn" class="primary">Zaloguj</button>
      <div class="hint" id="loginMsg"></div>
    </div>
  </div>

  <!-- APP -->
  <div id="app" style="display:none">
    <nav class="tabs">
      <button data-tab="orders" class="active">Zamówienia</button>
      <button data-tab="add">Dodaj</button>
      <button data-tab="designs">Wzory</button>
      <button data-tab="expenses">Koszty</button>
      <button data-tab="stats">Statystyki</button>
      <button data-tab="advstats">Zaawansowane statystyki</button>
    </nav>

    <!-- ORDERS (kept) -->
    <div id="tab-orders" class="card">
      <div class="toolbar">
        <div>
          <label>Miesiąc</label>
          <select id="ordersMonth"></select>
          <select id="ordersYear"></select>
        </div>
        <div>
          <label>Status</label>
          <select id="filterStatus">
            <option value="ALL">Wszystkie</option>
            <option>ZAMÓWIENIE PRZYJĘTE</option>
            <option>W TRAKCIE REALIZACJI</option>
            <option>GOTOWE DO WYSYŁKI</option>
            <option>WYSŁANE</option>
            <option>ZWROT</option>
          </select>
        </div>
        <div class="right pill">
          Zamówienia: <b id="ordersCount">0</b> • Przychody: <b id="sumRevenue">0.00</b> zł
        </div>
      </div>
      <div style="overflow:auto">
        <table><thead><tr><th>Data</th><th>Status</th><th>Rozmiar</th><th>Wzór</th><th>Klient</th><th>Cena</th><th></th></tr></thead>
          <tbody id="ordersTbody"></tbody></table>
      </div>
    </div>

    <!-- ADD ORDER -->
    <div id="tab-add" class="card" style="display:none">
      <h3>Dodaj zamówienie</h3>
      <!-- simplified add form -->
      <div class="row">
        <div class="col"><input id="addDesignText" placeholder="Nazwa wzoru"></div>
        <div class="col"><select id="addSize"><option>S</option><option>M</option><option>L</option><option>XL</option></select></div>
        <div class="col"><input id="addCustomer" placeholder="Klient"></div>
        <div class="col"><input id="addTotal" type="number" placeholder="Łączna cena"></div>
      </div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button id="addOrderBtn" class="primary">Dodaj</button>
        <div id="addMsg" class="hint"></div>
      </div>
    </div>

    <!-- DESIGNS -->
    <div id="tab-designs" class="card" style="display:none">
      <h3>Wzory</h3>
      <div class="row">
        <div class="col"><input id="designName" placeholder="Nazwa wzoru"></div>
        <div class="col"><input id="designFile" type="file" accept="image/*"></div>
        <div class="col" style="max-width:220px"><button id="addDesignBtn" class="primary">Dodaj wzór</button></div>
      </div>
      <div id="designsList" class="grid" style="margin-top:12px"></div>
    </div>

    <!-- EXPENSES -->
    <div id="tab-expenses" class="card" style="display:none">
      <h3>Koszty</h3>
      <div class="row">
        <div class="col"><input id="expName" placeholder="Nazwa kosztu"></div>
        <div class="col"><input id="expAmount" type="number" placeholder="Kwota"></div>
        <div class="col"><input id="expDate" type="date"></div>
        <div class="col" style="max-width:220px"><button id="addExpenseBtn" class="primary">Dodaj koszt</button></div>
      </div>
      <div style="margin-top:8px" id="expMsg" class="hint"></div>
      <div style="overflow:auto;margin-top:8px">
        <table><thead><tr><th>Data</th><th>Nazwa</th><th>Kwota</th><th></th></tr></thead>
          <tbody id="expTbody"></tbody></table>
      </div>
    </div>

    <!-- SIMPLE STATS -->
    <div id="tab-stats" class="card" style="display:none">
      <h3>Ranking wzorów (miesiąc)</h3>
      <div style="overflow:auto"><table><thead><tr><th>#</th><th>Wzór</th><th>Ilość</th></tr></thead><tbody id="statsTbody"></tbody></table></div>
    </div>

    <!-- ADVANCED STATS -->
    <div id="tab-advstats" class="card" style="display:none">
      <div class="toolbar">
        <div>
          <label>Zakres</label>
          <select id="advPeriod"><option value="month">Miesiąc</option><option value="week">Tydzień</option><option value="year">Rok</option><option value="all">Całość</option></select>
        </div>
        <div>
          <label>Miesiąc</label>
          <select id="advMonth"></select>
          <select id="advYear"></select>
        </div>
        <div style="display:flex;align-items:center;gap:8px">
          <label>Uwzględniaj zwroty</label><input id="advIncludeReturns" type="checkbox" />
        </div>
        <div class="right pill">
          Przychody: <b id="advRevenue">0.00</b> zł • Koszty: <b id="advCosts">0.00</b> zł • Zysk: <b id="advNet">0.00</b> zł
        </div>
      </div>

      <!-- financial overview -->
      <div class="card" style="padding:10px;margin-bottom:12px">
        <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap">
          <div class="pill">AOV: <b id="advAOV">0.00</b> zł</div>
          <div class="pill">Zwroty (%): <b id="advReturnsPct">0%</b></div>
          <div class="pill">Marża (śr): <b id="advAvgMargin">0%</b></div>
        </div>
      </div>

      <!-- charts grid -->
      <div class="chart-grid">
        <div class="card chart-box">
          <h4>Przychody / Koszty / Zysk (czas)</h4>
          <canvas id="chartFinances"></canvas>
        </div>
        <div class="card chart-box">
          <h4>Struktura kosztów (%)</h4>
          <canvas id="chartCostBreakdown"></canvas>
        </div>

        <div class="card chart-box">
          <h4>Marża netto (%)</h4>
          <canvas id="chartMargin"></canvas>
        </div>
        <div class="card chart-box">
          <h4>Zysk netto skumulowany</h4>
          <canvas id="chartCumNet"></canvas>
        </div>

        <div class="card chart-box">
          <h4>Udział zwrotów (%)</h4>
          <canvas id="chartReturnsPct"></canvas>
        </div>
        <div class="card chart-box">
          <h4>Top wzorów (sprzedaż)</h4>
          <canvas id="chartTopDesigns"></canvas>
        </div>
      </div>

      <div style="margin-top:12px">
        <h4>Tablica (szczegóły finansowe)</h4>
        <div style="overflow:auto;max-height:280px">
          <table><thead><tr><th>Typ</th><th>Klucz</th><th>Wartość</th></tr></thead><tbody id="advDetailTbody"></tbody></table>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- picker modal (kept minimal) -->
<div id="designPicker" class="modal"><div class="panel"><h3>Wybierz wzór</h3><div id="pickerGrid" class="grid" style="margin-top:10px"></div><div style="margin-top:10px"><button onclick="document.getElementById('designPicker').style.display='none'">Zamknij</button></div></div></div>

<script type="module">
  // Firebase imports
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import {
    getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut,
    setPersistence, browserLocalPersistence
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import {
    getFirestore, collection, addDoc, doc, setDoc, updateDoc, deleteDoc,
    getDocs, query, where, onSnapshot, serverTimestamp, Timestamp, writeBatch
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  // ----------------------------
  // Firebase config (użyj tych kluczy)
  // ----------------------------
  const firebaseConfig = {
    apiKey: "AIzaSyCGNcCqcQdLoOnWFEI1a7XhAsQtj6ECvfg",
    authDomain: "papierek-idzie-do-gory.firebaseapp.com",
    projectId: "papierek-idzie-do-gory",
    storageBucket: "papierek-idzie-do-gory.firebasestorage.app",
    messagingSenderId: "1063966015801",
    appId: "1:1063966015801:web:72f412aa200a705276a8e8"
  };
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // short helpers
  const $ = id => document.getElementById(id);
  const fmt2 = n => (Number(n||0)).toFixed(2);
  const numPL = n => fmt2(n).replace('.', ',');
  const monthsPL = ["styczeń","luty","marzec","kwiecień","maj","czerwiec","lipiec","sierpień","wrzesień","październik","listopad","grudzień"];

  // state
  let designs = new Map();
  let orders = []; // all order items
  let expenses = []; // all expenses
  let groups = []; // grouped orders (by groupId)

  // charts
  let chFinances, chCostBreakdown, chMargin, chCumNet, chReturns, chTopDesigns;

  // UI init
  async function initUI(){
    const now = new Date();
    // fill months/years selects
    const years = Array.from({length:10},(_,i)=>now.getFullYear()-5+i);
    const monthsHTML = monthsPL.map((m,i)=>`<option value="${i}">${m}</option>`).join('');
    $('ordersMonth').innerHTML = monthsHTML; $('advMonth').innerHTML = monthsHTML; $('advYear').innerHTML = years.map(y=>`<option ${y===now.getFullYear()?'selected':''}>${y}</option>`).join('');
    $('ordersYear').innerHTML = $('advYear').innerHTML;

    // auth handlers
    $('loginBtn').onclick = async ()=>{
      $('loginMsg').textContent = 'Logowanie...';
      try {
        await setPersistence(auth, browserLocalPersistence);
        await signInWithEmailAndPassword(auth, $('email').value, $('password').value);
      } catch(e){ $('loginMsg').textContent = 'Błąd logowania'; console.error(e); }
    };

    onAuthStateChanged(auth, u => {
      if(u){ $('loginCard').style.display='none'; $('app').style.display=''; $('userInfo').textContent = u.email || ''; startListeners(); createCharts(); }
      else { $('loginCard').style.display=''; $('app').style.display='none'; }
    });

    // tabs
    document.querySelectorAll('nav.tabs button').forEach(btn=>{
      btn.onclick = ()=>{
        document.querySelectorAll('nav.tabs button').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        document.querySelectorAll('[id^="tab-"]').forEach(t=>t.style.display='none');
        const id = 'tab-' + btn.dataset.tab;
        $(id).style.display='';
        if(btn.dataset.tab === 'advstats') renderAdvancedStats();
      };
    });

    // add handlers
    $('addDesignBtn').onclick = onAddDesign;
    $('addOrderBtn').onclick = onAddOrder;
    $('addExpenseBtn').onclick = onAddExpense;

    // advanced controls
    $('advPeriod').addEventListener('change', renderAdvancedStats);
    $('advMonth').addEventListener('change', renderAdvancedStats);
    $('advYear').addEventListener('change', renderAdvancedStats);
    $('advIncludeReturns').addEventListener('change', renderAdvancedStats);

    // setup default selects
    $('advMonth').value = String(now.getMonth());
    $('ordersMonth').value = String(now.getMonth());
    $('ordersYear').value = String(now.getFullYear());
  }

  // -------------------------
  // Data listeners / fetchers
  // -------------------------
  let unsubOrders=null, unsubExpenses=null, unsubDesigns=null;

  function startListeners(){
    // orders (all items)
    if(unsubOrders) unsubOrders();
    unsubOrders = onSnapshot(collection(db,'orderItems'), snap=>{
      orders = []; snap.forEach(d=>orders.push({id:d.id, ...d.data()}));
      // compute groups (by orderGroupId)
      const map = new Map();
      for(const it of orders){
        const gid = it.orderGroupId || it.id;
        if(!map.has(gid)) map.set(gid, {id:gid, items:[], total:0, status:it.status||'ZAMÓWIENIE PRZYJĘTE', date:it.date});
        const g = map.get(gid);
        g.items.push(it);
        if(it.orderTotalGross != null) g.total = Number(it.orderTotalGross);
        if(it.status) g.status = it.status;
      }
      groups = Array.from(map.values()).sort((a,b)=> (b.date?.toDate?b.date.toDate().getTime():0) - (a.date?.toDate?a.date.toDate().getTime():0));
      renderOrdersTable();
      renderSimpleStats();
    });

    // expenses
    if(unsubExpenses) unsubExpenses();
    unsubExpenses = onSnapshot(collection(db,'expenses'), snap=>{
      expenses = []; snap.forEach(d=>expenses.push({id:d.id, ...d.data()}));
      expenses.sort((a,b)=> (b.date?.toDate?b.date.toDate().getTime():0) - (a.date?.toDate?a.date.toDate().getTime():0));
      renderExpensesTable();
    });

    // designs
    if(unsubDesigns) unsubDesigns();
    unsubDesigns = onSnapshot(collection(db,'designs'), snap=>{
      designs = new Map();
      snap.forEach(d=>designs.set(d.id, {id:d.id, ...d.data()}));
      renderDesigns();
    });
  }

  // -------------------------
  // Render small tables
  // -------------------------
  function renderOrdersTable(){
    const tbody = $('ordersTbody'); tbody.innerHTML='';
    // default filter by selected month
    const selY = Number($('ordersYear').value), selM = Number($('ordersMonth').value);
    const monthKey = (y,m) => `${y}-${String(m+1).padStart(2,'0')}`;
    const mk = monthKey(selY, selM);
    const groupsFiltered = groups.filter(g=>{
      const d = g.date?.toDate?g.date.toDate():new Date(g.date);
      return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}` === mk;
    });
    $('ordersCount').textContent = String(groupsFiltered.length);
    let revenue = 0;
    for(const g of groupsFiltered){
      if(g.status !== 'ZWROT') revenue += Number(g.total||0);
      const tr = document.createElement('tr');
      const d = g.date?.toDate?g.date.toDate():new Date(g.date);
      tr.innerHTML = `<td>${String(d.getDate()).padStart(2,'0')}.${String(d.getMonth()+1).padStart(2,'0')}.${d.getFullYear()}</td>
        <td>${g.status}</td><td>${g.items.length}</td><td>${g.items[0]?.designText||''}</td><td>${g.items[0]?.customer||''}</td><td>${fmt2(g.total)} zł</td>
        <td><button class="ghost" onclick="openEdit('${g.id}')">Edytuj</button></td>`;
      tbody.appendChild(tr);
    }
    $('sumRevenue').textContent = fmt2(revenue);
  }

  function renderDesigns(){
    const wrap = $('designsList'); wrap.innerHTML='';
    for(const d of Array.from(designs.values()).sort((a,b)=> (a.name||'').localeCompare(b.name||'', 'pl'))){
      const el = document.createElement('div'); el.className='design-card';
      el.innerHTML = `${d.previewUrl?`<img class="design-img" src="${d.previewUrl}">`:`<div class="design-img"></div>`}<div style="margin-top:8px">${(d.name||'').replace(/</g,'&lt;')}</div>`;
      wrap.appendChild(el);
    }
  }

  function renderExpensesTable(){
    const tb = $('expTbody'); tb.innerHTML='';
    for(const e of expenses){
      const d = e.date?.toDate?e.date.toDate():new Date(e.date);
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${String(d.getDate()).padStart(2,'0')}.${String(d.getMonth()+1).padStart(2,'0')}.${d.getFullYear()}</td>
        <td>${(e.name||'').replace(/</g,'&lt;')}</td><td>${fmt2(e.amount)} zł</td>
        <td><button onclick="editExpense('${e.id}')">Edytuj</button> <button onclick="delExpense('${e.id}')">Usuń</button></td>`;
      tb.appendChild(tr);
    }
  }

  // -------------------------
  // Actions: add design/order/expense
  // -------------------------
  async function onAddDesign(){
    const name = $('designName').value.trim();
    if(!name){ alert('Podaj nazwę wzoru'); return; }
    const id = name.toLowerCase().replace(/\s+/g,'-').replace(/[^a-z0-9\-]/g,'');
    try{
      await setDoc(doc(db,'designs',id), { name, active:true, createdAt:serverTimestamp(), updatedAt:serverTimestamp() }, { merge:true });
      $('designName').value='';
      alert('Dodano wzór');
    }catch(e){ console.error(e); alert('Błąd'); }
  }

  async function onAddOrder(){
    const design = $('addDesignText').value.trim() || 'CUSTOM';
    const size = $('addSize').value;
    const customer = $('addCustomer').value.trim();
    const total = Number($('addTotal').value || 0);
    if(!total){ alert('Podaj cenę'); return; }
    const date = new Date();
    const gid = `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}-${Math.random().toString(36).slice(2,7)}`;
    try{
      await addDoc(collection(db,'orderItems'), {
        date: Timestamp.fromDate(date), monthKey: `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}`,
        createdAt: serverTimestamp(), updatedAt: serverTimestamp(),
        status: "ZAMÓWIENIE PRZYJĘTE", size, color: "BIAŁA",
        designId: 'custom', designText: design, previewUrl: null,
        customer, note: '', orderTotalGross: total, priceGross:0, orderGroupId: gid
      });
      $('addMsg').textContent = 'Dodano ✅';
      setTimeout(()=>$('addMsg').textContent='',1200);
    }catch(e){ console.error(e); alert('Błąd'); }
  }

  async function onAddExpense(){
    const name = $('expName').value.trim();
    const amount = Number($('expAmount').value || 0);
    const dateStr = $('expDate').value;
    if(!name || !amount || !dateStr){ alert('Uzupełnij pola'); return; }
    const date = new Date(dateStr + 'T12:00:00');
    try{
      await addDoc(collection(db,'expenses'), { name, amount, date: Timestamp.fromDate(date), monthKey: `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}`, createdAt: serverTimestamp() });
      $('expMsg').textContent = 'Dodano koszt ✅'; setTimeout(()=>$('expMsg').textContent='',1200);
    }catch(e){ console.error(e); alert('Błąd'); }
  }

  window.editExpense = async (id)=>{
    const eDoc = (await getDocs(query(collection(db,'expenses'), where('__name__','==',id)))).docs[0];
    if(!eDoc) return alert('Nie znaleziono');
    const data = eDoc.data();
    const newName = prompt('Nazwa', data.name) || data.name;
    const newAmount = Number(prompt('Kwota', data.amount) || data.amount);
    if(!newName || !newAmount) return;
    await updateDoc(doc(db,'expenses',id), { name:newName, amount:newAmount, updatedAt: serverTimestamp() });
  };

  window.delExpense = async (id)=>{
    if(!confirm('Usunąć koszt?')) return;
    await deleteDoc(doc(db,'expenses',id));
  };

  window.openEdit = (groupId)=>{
    // open edit modal for group - for brevity we'll alert
    alert('Edytuj zamówienie: ' + groupId + ' (użyj zakładki Zamówienia)');
  };

  // -------------------------
  // Charts setup
  // -------------------------
  function createCharts(){
    const common = { responsive:true, maintainAspectRatio:false, plugins:{legend:{position:'bottom'}}, scales:{y:{beginAtZero:true}} };

    const ctxF = $('chartFinances').getContext('2d');
    chFinances = new Chart(ctxF, { type:'line', data:{labels:[], datasets:[
      { label:'Przychód', data:[], borderColor:'#4cc9f0', backgroundColor:'rgba(76,201,240,.08)', fill:true, tension:0.2 },
      { label:'Koszty', data:[], borderColor:'#ff8a65', backgroundColor:'rgba(255,138,101,.06)', fill:true, tension:0.2 },
      { label:'Zysk', data:[], borderColor:'#a3e635', backgroundColor:'rgba(163,230,53,.06)', fill:true, tension:0.2 }
    ] }, options:{...common, aspectRatio:2} });

    const ctxCB = $('chartCostBreakdown').getContext('2d');
    chCostBreakdown = new Chart(ctxCB, { type:'pie', data:{labels:[], datasets:[{data:[], backgroundColor:['#4cc9f0','#ff8a65','#ffd166','#a3e635','#a78bfa']}]}, options:{...common, aspectRatio:1.2} });

    const ctxM = $('chartMargin').getContext('2d');
    chMargin = new Chart(ctxM, { type:'line', data:{labels:[], datasets:[{label:'Marża %', data:[], borderColor:'#ffd166', backgroundColor:'rgba(255,209,102,.06)', fill:true, tension:0.3}]}, options:{...common, aspectRatio:2, scales:{y:{beginAtZero:true, max:100}}} });

    const ctxC = $('chartCumNet').getContext('2d');
    chCumNet = new Chart(ctxC, { type:'line', data:{labels:[], datasets:[{label:'Zysk skumulowany', data:[], borderColor:'#a3e635', backgroundColor:'rgba(163,230,53,.06)', fill:true, tension:0.2}]}, options:{...common, aspectRatio:2} });

    const ctxR = $('chartReturnsPct').getContext('2d');
    chReturns = new Chart(ctxR, { type:'doughnut', data:{labels:['Zwroty','Pozostałe'], datasets:[{data:[0,100], backgroundColor:['#ff6b6b','#4cc9f0']}]}, options:{...common, aspectRatio:1.2} });

    const ctxTD = $('chartTopDesigns').getContext('2d');
    chTopDesigns = new Chart(ctxTD, { type:'bar', data:{labels:[], datasets:[{label:'Sprzedaż', data:[], backgroundColor:'#4cc9f0'}]}, options:{...common, aspectRatio:2} });
  }

  // -------------------------
  // Render advanced stats (finance)
  // -------------------------
  async function renderAdvancedStats(){
    // determine date range
    const period = $('advPeriod').value;
    const y = Number($('advYear').value);
    const m = Number($('advMonth').value);
    let startDate = new Date(1970,0,1), endDate = new Date(2099,11,31,23,59,59);
    if(period === 'month'){ startDate = new Date(y,m,1,0,0,0); endDate = new Date(y,m+1,0,23,59,59); }
    if(period === 'week'){ const today = new Date(y,m,new Date().getDate()); const day = today.getDay()||7; startDate = new Date(today.getFullYear(), today.getMonth(), today.getDate()-(day-1),0,0,0); endDate = new Date(startDate.getFullYear(), startDate.getMonth(), startDate.getDate()+6,23,59,59); }
    if(period === 'year'){ startDate = new Date(y,0,1,0,0,0); endDate = new Date(y,11,31,23,59,59); }
    const includeReturns = $('advIncludeReturns').checked;

    // filter orders and groups into range
    const itemsInRange = orders.filter(it=>{
      const dt = it.date?.toDate?it.date.toDate():new Date(it.date);
      return dt>=startDate && dt<=endDate && (includeReturns ? true : it.status !== 'ZWROT');
    });

    // compute revenue by day/month depending on granularity
    const byLabel = new Map(); // label -> {revenue, costs, net}
    const labelFor = dt=>{
      if(period==='week' || period==='month') return `${String(dt.getDate()).padStart(2,'0')}.${String(dt.getMonth()+1).padStart(2,'0')}`;
      if(period==='year') return `${String(dt.getMonth()+1).padStart(2,'0')}`;
      return `${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,'0')}`;
    };

    // revenue computed by group total (avoid double counting)
    const groupMap = new Map();
    for(const g of groups){
      const d = g.date?.toDate?g.date.toDate():new Date(g.date);
      if(d < startDate || d > endDate) continue;
      groupMap.set(g.id, g);
    }

    // revenue per label
    for(const [gid,g] of groupMap){
      const d = g.date?.toDate?g.date.toDate():new Date(g.date);
      if(!includeReturns && g.status === 'ZWROT') continue;
      const label = labelFor(d);
      if(!byLabel.has(label)) byLabel.set(label,{revenue:0,costs:0,net:0});
      byLabel.get(label).revenue += Number(g.total || 0);
    }

    // costs: sum expenses in range; also categorize by "name" simple bucket
    const expensesInRange = expenses.filter(e=>{
      const dt = e.date?.toDate?e.date.toDate():new Date(e.date);
      return dt>=startDate && dt<=endDate;
    });

    // distribute costs to labels by date
    for(const e of expensesInRange){
      const d = e.date?.toDate?e.date.toDate():new Date(e.date);
      const label = labelFor(d);
      if(!byLabel.has(label)) byLabel.set(label,{revenue:0,costs:0,net:0});
      byLabel.get(label).costs += Number(e.amount || 0);
    }

    // prepare arrays sorted by label (sort keys)
    const labels = Array.from(byLabel.keys()).sort((a,b)=>{
      // try numeric compare
      const na = a.replace(/\D/g,''), nb = b.replace(/\D/g,'');
      return (na - nb) || a.localeCompare(b, 'pl');
    });
    const revArr = labels.map(l=>byLabel.get(l).revenue || 0);
    const costArr = labels.map(l=>byLabel.get(l).costs || 0);
    const netArr = labels.map((l,i)=> revArr[i] - costArr[i]);

    // update overview KPI
    const totalRevenue = revArr.reduce((s,v)=>s+v,0);
    const totalCosts = costArr.reduce((s,v)=>s+v,0);
    const totalNet = totalRevenue - totalCosts;
    $('advRevenue').textContent = fmt2(totalRevenue);
    $('advCosts').textContent = fmt2(totalCosts);
    $('advNet').textContent = fmt2(totalNet);

    // AOV
    const ordersCount = Array.from(groupMap.values()).filter(g=> includeReturns ? true : g.status !== 'ZWROT' ).length || 1;
    const AOV = totalRevenue / ordersCount;
    $('advAOV').textContent = fmt2(AOV);

    // returns %
    const totalOrdersAll = groups.filter(g=>{
      const d = g.date?.toDate?g.date.toDate():new Date(g.date);
      return d>=startDate && d<=endDate;
    }).length || 1;
    const returnsCount = groups.filter(g=>{
      const d = g.date?.toDate?g.date.toDate():new Date(g.date);
      return d>=startDate && d<=endDate && g.status==='ZWROT';
    }).length;
    const returnsPct = Math.round((returnsCount / totalOrdersAll) * 100);
    $('advReturnsPct').textContent = returnsPct + '%';

    // marża %
    const marginPctArr = labels.map((l,i)=> {
      const rev = revArr[i] || 0; const c = costArr[i] || 0;
      return rev === 0 ? 0 : Math.max(0, ( (rev - c) / rev ) * 100 );
    });
    const avgMargin = marginPctArr.length ? (marginPctArr.reduce((s,v)=>s+v,0)/marginPctArr.length) : 0;
    $('advAvgMargin').textContent = Math.round(avgMargin) + '%';

    // zysk skumulowany
    const cumNet = netArr.reduce((acc,v,i)=> (acc.push((acc.length?acc[acc.length-1]:0) + v), acc), []).slice(1); // hacky
    // simpler:
    const cumArr = []; let acc=0; for(const v of netArr){ acc += v; cumArr.push(acc); }

    // cost breakdown by coarse categories (simple heuristic based on name)
    const buckets = {};
    for(const e of expensesInRange){
      const name = (e.name||'').toLowerCase();
      let cat = 'Inne';
      if(/koszulk|t-shirt|shirt|materi/.test(name)) cat = 'Materiały';
      else if(/druk|sitodruk|drukarnia|drukowanie/.test(name)) cat = 'Druk';
      else if(/wysył|paczka|kurier/.test(name)) cat = 'Wysyłka';
      else if(/reklam|ads|facebook|google/.test(name)) cat = 'Marketing';
      buckets[cat] = (buckets[cat]||0) + Number(e.amount||0);
    }
    // ensure some colors for pie
    const bucketLabels = Object.keys(buckets);
    const bucketVals = bucketLabels.map(l=>buckets[l]);

    // top designs
    const designCounts = {};
    for(const it of itemsInRange){
      const id = it.designId || 'custom';
      designCounts[id] = (designCounts[id]||0) + 1;
    }
    const topDesignArr = Object.entries(designCounts).map(([id,c])=>({id,name: designs.get(id)?.name || (id==='custom'?'CUSTOM':id), count:c})).sort((a,b)=>b.count-a.count).slice(0,10);

    // update charts
    // finances
    chFinances.data.labels = labels;
    chFinances.data.datasets[0].data = revArr;
    chFinances.data.datasets[1].data = costArr;
    chFinances.data.datasets[2].data = netArr;
    chFinances.update();

    // cost breakdown pie
    chCostBreakdown.data.labels = bucketLabels;
    chCostBreakdown.data.datasets[0].data = bucketVals;
    chCostBreakdown.update();

    // margin
    chMargin.data.labels = labels;
    chMargin.data.datasets[0].data = marginPctArr;
    chMargin.update();

    // cumulative net
    chCumNet.data.labels = labels;
    chCumNet.data.datasets[0].data = cumArr;
    chCumNet.update();

    // returns
    chReturns.data.datasets[0].data = [returnsCount, Math.max(0, totalOrdersAll - returnsCount)];
    chReturns.update();

    // top designs
    chTopDesigns.data.labels = topDesignArr.map(t=>t.name);
    chTopDesigns.data.datasets[0].data = topDesignArr.map(t=>t.count);
    chTopDesigns.update();

    // detail table
    const tbody = $('advDetailTbody'); tbody.innerHTML = '';
    tbody.appendChild(trRow('Przychód (sumarycznie)', fmt2(totalRevenue)+' zł'));
    tbody.appendChild(trRow('Koszty (sumarycznie)', fmt2(totalCosts)+' zł'));
    tbody.appendChild(trRow('Zysk netto', fmt2(totalNet)+' zł'));
    tbody.appendChild(trRow('AOV (średni przychód na zamówienie)', fmt2(AOV)+' zł'));
    tbody.appendChild(trRow('Udział zwrotów', returnsPct+' %'));
    for(const l of bucketLabels) tbody.appendChild(trRow('Koszt: '+l, fmt2(buckets[l])+' zł'));

    // utility
    function trRow(k,v){ const tr = document.createElement('tr'); tr.innerHTML = `<td>Finanse</td><td>${k}</td><td>${v}</td>`; return tr; }
  }

  // -------------------------
  // bootstrap
  // -------------------------
  await initUI();
  // create charts only after UI and auth; createCharts called after auth in initUI

  // expose renderAdvancedStats to global (used when tab opened)
  window.renderAdvancedStats = renderAdvancedStats;

  // ensure charts created even if user navigates immediately
  window.createCharts = createCharts;

</script>
</body>
</html>
