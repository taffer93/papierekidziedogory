<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Koszulki — Panel (pełny, poprawiony)</title>
  <style>
    :root{
      --bg:#0f1720; --card:#111820; --muted:#9fb2c7; --text:#eaf4ff; --accent:#4cc9f0; --line:#223042;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text);font-size:14px}
    header{padding:14px 18px;border-bottom:1px solid #12202b;display:flex;align-items:center;gap:12px}
    h1{font-size:18px;margin:0}
    .wrap{max-width:1200px;margin:18px auto;padding:14px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:10px;padding:12px;margin-bottom:12px}
    nav.tabs{display:flex;gap:8px;margin:10px 0 14px 0;flex-wrap:wrap}
    nav.tabs button{background:transparent;color:var(--text);border:1px solid #172630;padding:8px 12px;border-radius:8px;cursor:pointer}
    nav.tabs button.active{outline:2px solid var(--accent)}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .col{flex:1 1 240px;min-width:220px}
    input,select,button,textarea{width:100%;padding:8px;border-radius:8px;border:1px solid #213244;background:#0b1420;color:var(--text)}
    button.primary{background:linear-gradient(180deg,#177ea6,#0e5f80);border-color:#0e5f80;color:#fff}
    table{width:100%;border-collapse:collapse;font-size:13px}
    th,td{padding:8px;border-bottom:1px solid #172a36;text-align:left}
    th{background:#0e1b27;position:sticky;top:0}
    .toolbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:10px}
    .right{margin-left:auto}
    .pill{padding:6px 10px;border-radius:999px;background:#0b1220;border:1px solid #193040}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:10px}
    .design-card{padding:8px;border-radius:8px;border:1px solid #203145;background:#081118;text-align:center}
    .thumb{width:48px;height:48px;border-radius:6px;object-fit:cover;background:#07121a}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:2000}
    .modal .panel{background:var(--card);border-radius:10px;padding:12px;width:min(980px,96vw);max-height:88vh;overflow:auto;border:1px solid #162a36}
    /* charts */
    .chart-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    .chart-card{background:var(--card);border:1px solid #203145;border-radius:10px;padding:10px;display:flex;flex-direction:column}
    .chart-canvas{flex:1;min-height:240px;max-height:360px;width:100%}
    @media (max-width:900px){ .chart-grid{grid-template-columns:1fr} .chart-canvas{min-height:220px} }
    .danger{color:#ff8a8a}
    .small{font-size:12px;color:var(--muted)}
  </style>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
<header>
  <h1>Koszulki — Panel</h1>
  <div id="userInfo" style="margin-left:auto" class="small"></div>
</header>

<div class="wrap">
  <!-- LOGIN -->
  <div id="loginCard" class="card" style="max-width:620px">
    <h3>Logowanie</h3>
    <div class="row">
      <div class="col"><input id="email" type="email" placeholder="email@example.com"></div>
      <div class="col"><input id="password" type="password" placeholder="Hasło"></div>
    </div>
    <div style="display:flex;gap:8px;margin-top:8px;align-items:center">
      <button id="loginBtn" class="primary">Zaloguj</button>
      <div id="loginMsg" class="small"></div>
    </div>
  </div>

  <!-- APP -->
  <div id="app" style="display:none">
    <nav class="tabs">
      <button data-tab="orders" class="active">Zamówienia</button>
      <button data-tab="add">Dodaj</button>
      <button data-tab="designs">Wzory</button>
      <button data-tab="expenses">Koszty</button>
      <button data-tab="stats">Statystyki</button>
      <button data-tab="advstats">Zaawansowane statystyki</button>
    </nav>

    <!-- ORDERS -->
    <div id="tab-orders" class="card">
      <div class="toolbar">
        <div>
          <label class="small">Miesiąc</label>
          <div style="display:flex;gap:6px">
            <select id="ordersMonth"></select>
            <select id="ordersYear" style="max-width:110px"></select>
          </div>
        </div>
        <div>
          <label class="small">Status</label>
          <select id="filterStatus">
            <option value="ALL">Wszystkie</option>
            <option value="ZAMÓWIENIE PRZYJĘTE">ZAMÓWIENIE PRZYJĘTE</option>
            <option value="W TRAKCIE REALIZACJI">W TRAKCIE REALIZACJI</option>
            <option value="GOTOWE DO WYSYŁKI">GOTOWE DO WYSYŁKI</option>
            <option value="WYSŁANE">WYSŁANE</option>
            <option value="ZWROT">ZWROT</option>
          </select>
        </div>
        <div class="right pill">
          Zamówienia: <b id="ordersCount">0</b> • Przychód: <b id="sumRevenue">0.00</b> zł
        </div>
      </div>

      <div style="overflow:auto">
        <table>
          <thead>
            <tr><th>Data</th><th>Status</th><th>Rozmiar</th><th>Wzór</th><th>Klient</th><th>Cena</th><th></th></tr>
          </thead>
          <tbody id="ordersTbody"></tbody>
        </table>
      </div>
    </div>

    <!-- ADD -->
    <div id="tab-add" class="card" style="display:none">
      <h3>Dodaj zamówienie</h3>
      <div class="row">
        <div class="col"><input id="addDesignText" placeholder="Nazwa wzoru"></div>
        <div class="col"><select id="addSize"><option>S</option><option>M</option><option>L</option><option>XL</option></select></div>
        <div class="col"><input id="addCustomer" placeholder="Klient"></div>
        <div class="col"><input id="addTotal" type="number" placeholder="Łączna cena"></div>
      </div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button id="addOrderBtn" class="primary">Dodaj</button>
        <div id="addMsg" class="small"></div>
      </div>
    </div>

    <!-- DESIGNS -->
    <div id="tab-designs" class="card" style="display:none">
      <h3>Wzory</h3>
      <div class="row">
        <div class="col"><input id="designName" placeholder="Nazwa wzoru"></div>
        <div class="col"><input id="designFile" type="file" accept="image/*"></div>
        <div style="max-width:220px"><button id="addDesignBtn" class="primary">Dodaj wzór</button></div>
      </div>
      <div id="designsList" class="grid" style="margin-top:12px"></div>
    </div>

    <!-- EXPENSES -->
    <div id="tab-expenses" class="card" style="display:none">
      <h3>Koszty</h3>
      <div class="row">
        <div class="col"><input id="expName" placeholder="Nazwa kosztu"></div>
        <div class="col"><input id="expAmount" type="number" placeholder="Kwota"></div>
        <div class="col"><input id="expDate" type="date"></div>
        <div style="max-width:220px"><button id="addExpenseBtn" class="primary">Dodaj koszt</button></div>
      </div>
      <div id="expMsg" class="small" style="margin-top:8px"></div>
      <div style="overflow:auto;margin-top:8px">
        <table><thead><tr><th>Data</th><th>Nazwa</th><th>Kwota</th><th></th></tr></thead><tbody id="expTbody"></tbody></table>
      </div>
    </div>

    <!-- STATS -->
    <div id="tab-stats" class="card" style="display:none">
      <h3>Ranking wzorów (miesiąc)</h3>
      <div style="overflow:auto"><table><thead><tr><th>#</th><th>Wzór</th><th>Ilość</th></tr></thead><tbody id="statsTbody"></tbody></table></div>
    </div>

    <!-- ADV STATS -->
    <div id="tab-advstats" class="card" style="display:none">
      <div class="toolbar">
        <div>
          <label class="small">Zakres</label>
          <select id="advPeriod"><option value="month">Miesiąc</option><option value="week">Tydzień</option><option value="year">Rok</option><option value="all">Całość</option></select>
          <select id="advMonth"></select>
          <select id="advYear"></select>
        </div>
        <div style="display:flex;align-items:center;gap:8px">
          <label class="small">Uwzględniaj zwroty</label><input id="advIncludeReturns" type="checkbox" />
        </div>
        <div class="right pill">
          Przychody: <b id="advRevenue">0.00</b> zł • Koszty: <b id="advCosts">0.00</b> zł • Zysk: <b id="advNet">0.00</b> zł
        </div>
      </div>

      <div class="card" style="padding:10px;margin-bottom:12px">
        <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap">
          <div class="pill">AOV: <b id="advAOV">0.00</b> zł</div>
          <div class="pill">Zwroty (%): <b id="advReturnsPct">0%</b></div>
          <div class="pill">Marża (śr): <b id="advAvgMargin">0%</b></div>
        </div>
      </div>

      <div class="chart-grid">
        <div class="chart-card"><h4>Przychody / Koszty / Zysk</h4><canvas id="chartFinances" class="chart-canvas"></canvas></div>
        <div class="chart-card"><h4>Ilość zamówień</h4><canvas id="chartOrders" class="chart-canvas"></canvas></div>
        <div class="chart-card"><h4>Struktura kosztów (%)</h4><canvas id="chartCostBreakdown" class="chart-canvas"></canvas></div>
        <div class="chart-card"><h4>Top 10 wzorów</h4><canvas id="chartTopDesigns" class="chart-canvas"></canvas></div>
        <div class="chart-card"><h4>Marża netto (%)</h4><canvas id="chartMargin" class="chart-canvas"></canvas></div>
        <div class="chart-card"><h4>Zysk skumulowany</h4><canvas id="chartCumNet" class="chart-canvas"></canvas></div>
      </div>

      <div style="margin-top:12px" class="card">
        <div style="display:flex;align-items:center;gap:8px">
          <h4 style="margin:0">Rozmiary — spis</h4>
          <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
            <label class="small">Zakres</label>
            <select id="sizePeriod"><option value="day">Dzień</option><option value="week" selected>Tydzień</option><option value="month">Miesiąc</option><option value="year">Rok</option><option value="all">Całość</option></select>
            <label class="small">Uwzględniaj zwroty</label><input id="sizeIncludeReturns" type="checkbox" />
          </div>
        </div>

        <div class="chart-grid" style="margin-top:10px">
          <div class="chart-card"><h4>Wykres rozmiarów</h4><canvas id="chartSizes" class="chart-canvas"></canvas></div>
          <div class="chart-card"><h4>Top wzorów (tabela)</h4><div style="overflow:auto;max-height:340px"><table><thead><tr><th>Wzór</th><th>Ilość</th></tr></thead><tbody id="advTopDesignsTbody"></tbody></table></div></div>
        </div>

        <div style="margin-top:12px">
          <h4>Spis rozmiarów (tabela)</h4>
          <div style="overflow:auto;max-height:260px"><table><thead><tr><th>Okres</th><th>Rozmiar</th><th>Ilość</th></tr></thead><tbody id="advSizeTbody"></tbody></table></div>
        </div>
      </div>

      <div id="advDetailWrap" class="card" style="margin-top:12px">
        <h4>Tablica (szczegóły finansowe)</h4>
        <div style="overflow:auto;max-height:240px"><table><thead><tr><th>Typ</th><th>Klucz</th><th>Wartość</th></tr></thead><tbody id="advDetailTbody"></tbody></table></div>
      </div>

    </div>

  </div>
</div>

<!-- design picker modal -->
<div id="designPicker" class="modal"><div class="panel"><h3>Wybierz wzór</h3><div id="pickerGrid" class="grid" style="margin-top:10px"></div><div style="margin-top:10px"><button onclick="document.getElementById('designPicker').style.display='none'">Zamknij</button></div></div></div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import {
    getAuth, onAuthStateChanged, signInWithEmailAndPassword, setPersistence, browserLocalPersistence, signOut
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import {
    getFirestore, collection, addDoc, doc, setDoc, updateDoc, deleteDoc,
    getDocs, query, where, onSnapshot, serverTimestamp, Timestamp, writeBatch
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  // --- Firebase config (twój projekt) ---
  const firebaseConfig = {
    apiKey: "AIzaSyCGNcCqcQdLoOnWFEI1a7XhAsQtj6ECvfg",
    authDomain: "papierek-idzie-do-gory.firebaseapp.com",
    projectId: "papierek-idzie-do-gory",
    storageBucket: "papierek-idzie-do-gory.firebasestorage.app",
    messagingSenderId: "1063966015801",
    appId: "1:1063966015801:web:72f412aa200a705276a8e8"
  };
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // helpers
  const $ = id => document.getElementById(id);
  const fmt2 = n => (Number(n||0)).toFixed(2);
  const monthsPL = ["styczeń","luty","marzec","kwiecień","maj","czerwiec","lipiec","sierpień","wrzesień","październik","listopad","grudzień"];
  const monthKey = (y,m)=> `${y}-${String(m+1).padStart(2,'0')}`;

  // state
  let designMap = new Map();
  let ordersGroupsAll = [];
  let expensesList = [];
  let charts = {};

  // single declaration for picker context (no duplicates)
  let pickerContext = { openForRow: null };

  // UI init
  (function initUI(){
    const now = new Date();
    const yearsArr = Array.from({length:9},(_,k)=>now.getFullYear()-4+k);
    $('ordersMonth').innerHTML = monthsPL.map((m,i)=>`<option value="${i}">${m}</option>`).join('');
    $('advMonth').innerHTML = $('ordersMonth').innerHTML;
    $('advYear').innerHTML = yearsArr.map(y=>`<option ${y===now.getFullYear()?'selected':''}>${y}</option>`).join('');
    $('ordersYear').innerHTML = $('advYear').innerHTML;
    $('expDate').value = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}`;

    // tabs
    document.querySelectorAll('nav.tabs button').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        document.querySelectorAll('nav.tabs button').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        document.querySelectorAll('[id^="tab-"]').forEach(t=>t.style.display='none');
        const id = 'tab-' + btn.dataset.tab;
        if($(id)) $(id).style.display = '';
        if(btn.dataset.tab === 'advstats') renderAdvancedStats();
      });
    });

    // listeners
    $('loginBtn').onclick = async () => {
      const email = $('email').value.trim();
      const pass = $('password').value.trim();
      if(!email || !pass){ $('loginMsg').textContent = 'Podaj e-mail i hasło'; return; }
      $('loginMsg').textContent = 'Trwa logowanie...';
      try{
        await setPersistence(auth, browserLocalPersistence);
        const userCred = await signInWithEmailAndPassword(auth, email, pass);
        if(userCred?.user){
          $('loginMsg').textContent = 'Zalogowano';
          $('loginCard').style.display = 'none';
          $('app').style.display = '';
          $('userInfo').textContent = userCred.user.email || '';
        } else {
          $('loginMsg').textContent = 'Nie udało się zalogować';
        }
      } catch(err){
        console.error('Błąd logowania', err);
        let msg = 'Błąd logowania.';
        if(err.code === 'auth/wrong-password') msg = 'Niepoprawne hasło.';
        else if(err.code === 'auth/user-not-found') msg = 'Nie znaleziono konta.';
        else if(err.code === 'auth/invalid-email') msg = 'Niepoprawny e-mail.';
        else if(err.code === 'auth/network-request-failed') msg = 'Brak sieci.';
        $('loginMsg').textContent = msg;
      }
    };

    $('addDesignBtn').addEventListener('click', onAddDesign);
    $('addOrderBtn').addEventListener('click', onAddOrder);
    $('addExpenseBtn').addEventListener('click', onAddExpense);

    $('advPeriod').addEventListener('change', renderAdvancedStats);
    $('advMonth').addEventListener('change', renderAdvancedStats);
    $('advYear').addEventListener('change', renderAdvancedStats);
    $('advIncludeReturns').addEventListener('change', renderAdvancedStats);
    $('sizePeriod').addEventListener('change', renderAdvancedStats);
    $('sizeIncludeReturns').addEventListener('change', renderAdvancedStats);

    createCharts();
  })();

  // auth state handler
  onAuthStateChanged(auth, user => {
    if(user){
      console.log('Zalogowano jako', user.email);
      $('loginCard').style.display = 'none';
      $('app').style.display = '';
      $('userInfo').textContent = user.email || '';
      startListeners();
    } else {
      console.log('Wylogowano');
      $('loginCard').style.display = '';
      $('app').style.display = 'none';
      $('userInfo').textContent = '';
      stopListeners();
    }
  });

  // listeners unsub
  let unsubDesigns=null, unsubOrders=null, unsubExpenses=null;
  function startListeners(){
    subscribeDesigns();
    subscribeOrders();
    subscribeExpenses();
  }
  function stopListeners(){
    if(unsubDesigns) unsubDesigns();
    if(unsubOrders) unsubOrders();
    if(unsubExpenses) unsubExpenses();
  }

  // --- Designs ---
  function subscribeDesigns(){
    if(unsubDesigns) unsubDesigns();
    unsubDesigns = onSnapshot(collection(db,'designs'), snap=>{
      designMap.clear();
      snap.forEach(d=> designMap.set(d.id, { id:d.id, ...d.data() }));
      renderDesigns();
      renderPicker();
    }, err=>console.error(err));
  }
  function renderDesigns(){
    const wrap = $('designsList'); wrap.innerHTML = '';
    Array.from(designMap.values()).sort((a,b)=> (a.name||'').localeCompare(b.name||'')).forEach(d=>{
      const e = document.createElement('div'); e.className='design-card';
      e.innerHTML = `${d.previewUrl?`<img class="thumb" src="${d.previewUrl}">`:`<div class="thumb"></div>`}<div style="margin-top:8px">${(d.name||'').replace(/</g,'&lt;')}</div>`;
      wrap.appendChild(e);
    });
  }
  function renderPicker(){
    const grid = $('pickerGrid'); if(!grid) return; grid.innerHTML='';
    Array.from(designMap.values()).forEach(d=>{
      const el = document.createElement('div'); el.className='design-card';
      el.innerHTML = `${d.previewUrl?`<img class="thumb" src="${d.previewUrl}">`:`<div class="thumb"></div>`}<div style="margin-top:8px">${(d.name||'').replace(/</g,'&lt;')}</div>`;
      el.onclick = ()=>{ pickerContext.openForRow = null; document.getElementById('designPicker').style.display='none'; /* optional assignment usage */ };
      grid.appendChild(el);
    });
  }
  async function onAddDesign(){
    const name = $('designName').value.trim();
    const file = $('designFile').files[0] || null;
    if(!name) return alert('Podaj nazwę wzoru');
    const id = name.toLowerCase().replace(/\s+/g,'-').replace(/[^a-z0-9\-]/g,'');
    let previewUrl = null;
    if(file) previewUrl = await fileToDataUrl(file);
    await setDoc(doc(db,'designs',id), { name, previewUrl, createdAt: serverTimestamp(), updatedAt: serverTimestamp() }, { merge:true });
    $('designName').value=''; $('designFile').value='';
  }

  // --- Orders subscription and rendering (single stable impl) ---
  function subscribeOrders(){
    if(unsubOrders) unsubOrders();
    unsubOrders = onSnapshot(collection(db,'orderItems'), snap=>{
      const docs = [];
      snap.forEach(d=>docs.push({ id:d.id, ...d.data() }));
      const groups = new Map();
      for(const it of docs){
        const gid = it.orderGroupId || it.id;
        if(!groups.has(gid)) groups.set(gid, { id:gid, items:[], total:0, status: it.status || 'ZAMÓWIENIE PRZYJĘTE', date: it.date, createdMax: it.createdAt?.toDate?it.createdAt.toDate().getTime():0, customer: it.customer || '' });
        const g = groups.get(gid);
        g.items.push(it);
        if(it.orderTotalGross != null) g.total = Number(it.orderTotalGross);
        if(it.status) g.status = it.status;
        if(it.date) g.date = it.date;
        if(it.createdAt && (!g.createdMax || g.createdMax < it.createdAt.toDate().getTime())) g.createdMax = it.createdAt.toDate().getTime();
      }
      ordersGroupsAll = Array.from(groups.values()).sort((a,b)=> (b.createdMax||0) - (a.createdMax||0));
      const revenue = ordersGroupsAll.reduce((s,g)=> s + (g.status === 'ZWROT' ? 0 : Number(g.total||0)), 0);
      $('ordersCount').textContent = String(ordersGroupsAll.length);
      $('sumRevenue').textContent = fmt2(revenue);
      renderOrdersTable();
    }, err=>console.error(err));
  }

  function renderOrdersTable(){
    const tbody = $('ordersTbody'); tbody.innerHTML = '';
    const selY = Number($('ordersYear').value || new Date().getFullYear());
    const selM = Number($('ordersMonth').value || new Date().getMonth());
    const mk = monthKey(selY, selM);
    const statusFilter = $('filterStatus').value;
    const groupsFiltered = ordersGroupsAll.filter(g=>{
      const d = g.date?.toDate?g.date.toDate(): new Date(g.date);
      const key = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
      if(key !== mk) return false;
      if(statusFilter !== 'ALL' && (g.status || '') !== statusFilter) return false;
      return true;
    });
    for(const g of groupsFiltered){
      const d = g.date?.toDate?g.date.toDate(): new Date(g.date || Date.now());
      const tr = document.createElement('tr');
      const it = g.items[0] || {};
      tr.innerHTML = `<td>${String(d.getDate()).padStart(2,'0')}.${String(d.getMonth()+1).padStart(2,'0')}.${d.getFullYear()}</td>
        <td>${g.status}</td><td>${it.size||''}</td><td>${it.designText||''}</td><td>${g.customer||''}</td><td>${fmt2(g.total)} zł</td>
        <td><button class="ghost" data-edit="${g.id}">Edytuj</button> <button class="ghost danger" data-del="${g.id}">Usuń</button></td>`;
      tbody.appendChild(tr);
      tr.querySelector('[data-edit]')?.addEventListener('click', ()=> openEdit(g.id));
      tr.querySelector('[data-del]')?.addEventListener('click', ()=> deleteGroupConfirm(g.id));
    }
  }

  async function deleteGroupConfirm(groupId){
    if(!confirm('Usunąć całe zamówienie?')) return;
    const snap = await getDocs(query(collection(db,'orderItems'), where('orderGroupId','==',groupId)));
    const batch = writeBatch(db);
    snap.forEach(d=> batch.delete(doc(db,'orderItems',d.id)));
    await batch.commit();
  }

  function openEdit(groupId){
    alert('Edytuj: ' + groupId + ' — modal edycji nieotwarty w tej wersji. Jeśli chcesz, rozwinę edycję.');
  }

  // --- Expenses ---
  function subscribeExpenses(){
    if(unsubExpenses) unsubExpenses();
    unsubExpenses = onSnapshot(collection(db,'expenses'), snap=>{
      expensesList = [];
      snap.forEach(d=> expensesList.push({ id:d.id, ...d.data() }));
      expensesList.sort((a,b)=> (b.date?.toDate?b.date.toDate().getTime():0) - (a.date?.toDate?a.date.toDate().getTime():0));
      renderExpenses();
    }, err=>console.error(err));
  }
  function renderExpenses(){
    const tb = $('expTbody'); tb.innerHTML = '';
    for(const e of expensesList){
      const d = e.date?.toDate?e.date.toDate():new Date(e.date);
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${String(d.getDate()).padStart(2,'0')}.${String(d.getMonth()+1).padStart(2,'0')}.${d.getFullYear()}</td>
        <td>${(e.name||'').replace(/</g,'&lt;')}</td><td>${fmt2(e.amount)} zł</td>
        <td><button class="ghost" data-del="${e.id}">Usuń</button></td>`;
      tb.appendChild(tr);
      tr.querySelector('[data-del]')?.addEventListener('click', async ()=>{ if(!confirm('Usuń koszt?')) return; await deleteDoc(doc(db,'expenses',e.id)); });
    }
  }

  // --- Add functions ---
  function fileToDataUrl(file){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); }); }

  async function onAddOrder(){
    const design = $('addDesignText').value.trim() || 'CUSTOM';
    const size = $('addSize').value;
    const customer = $('addCustomer').value.trim();
    const total = Number($('addTotal').value || 0);
    if(!total) return alert('Podaj cenę');
    const date = new Date();
    const gid = `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}-${Math.random().toString(36).slice(2,7)}`;
    await addDoc(collection(db,'orderItems'), {
      date: Timestamp.fromDate(date),
      monthKey: monthKey(date.getFullYear(), date.getMonth()),
      createdAt: serverTimestamp(), updatedAt: serverTimestamp(),
      status: "ZAMÓWIENIE PRZYJĘTE", size, color: "BIAŁA",
      designId: 'custom', designText: design, previewUrl: null,
      customer, note: '', orderTotalGross: total, priceGross:0, orderGroupId: gid
    });
    $('addMsg').textContent = 'Dodano';
    setTimeout(()=>$('addMsg').textContent='',1200);
  }

  async function onAddExpense(){
    const name = $('expName').value.trim();
    const amount = Number($('expAmount').value || 0);
    const dateStr = $('expDate').value;
    if(!name || !amount || !dateStr) return alert('Uzupełnij pola');
    const date = new Date(dateStr + 'T12:00:00');
    await addDoc(collection(db,'expenses'), { name, amount, date: Timestamp.fromDate(date), monthKey: monthKey(date.getFullYear(), date.getMonth()), createdAt: serverTimestamp() });
    $('expMsg').textContent = 'Dodano';
    setTimeout(()=>$('expMsg').textContent='',1200);
  }

  // --- Charts ---
  function createCharts(){
    const common = { responsive:true, maintainAspectRatio:false, scales:{ y:{ beginAtZero:true } } };
    if($('chartFinances')) charts.finances = new Chart($('chartFinances').getContext('2d'), { type:'line', data:{ labels:[], datasets:[
      { label:'Przychód', data:[], borderColor:'#4cc9f0', backgroundColor:'rgba(76,201,240,0.06)', fill:true },
      { label:'Koszty', data:[], borderColor:'#ff8a65', backgroundColor:'rgba(255,138,101,0.06)', fill:true },
      { label:'Zysk', data:[], borderColor:'#a3e635', backgroundColor:'rgba(163,230,53,0.06)', fill:true }
    ] }, options:{...common, plugins:{legend:{position:'bottom'}}} });

    if($('chartOrders')) charts.orders = new Chart($('chartOrders').getContext('2d'), { type:'bar', data:{ labels:[], datasets:[{ label:'Liczba zamówień', data:[] }] }, options:{...common, plugins:{legend:{display:false}}} });

    if($('chartCostBreakdown')) charts.costBreakdown = new Chart($('chartCostBreakdown').getContext('2d'), { type:'pie', data:{ labels:[], datasets:[{ data:[] }] }, options:{ responsive:true } });

    if($('chartTopDesigns')) charts.topDesigns = new Chart($('chartTopDesigns').getContext('2d'), { type:'bar', data:{ labels:[], datasets:[{ label:'Sprzedaż', data:[] }] }, options:{...common} });

    if($('chartMargin')) charts.margin = new Chart($('chartMargin').getContext('2d'), { type:'line', data:{ labels:[], datasets:[{ label:'Marża %', data:[] }] }, options:{...common, scales:{ y:{ beginAtZero:true, max:100 } } } });

    if($('chartCumNet')) charts.cumNet = new Chart($('chartCumNet').getContext('2d'), { type:'line', data:{ labels:[], datasets:[{ label:'Zysk skumulowany', data:[] }] }, options:{...common} });

    if($('chartSizes')) charts.sizes = new Chart($('chartSizes').getContext('2d'), { type:'bar', data:{ labels:[], datasets:[{ label:'Ilość', data:[] }] }, options:{...common, plugins:{legend:{display:false}}} });
  }

  // --- Advanced stats rendering ---
  async function renderAdvancedStats(){
    const period = $('advPeriod').value;
    const y = Number($('advYear').value || new Date().getFullYear());
    const m = Number($('advMonth').value || new Date().getMonth());
    let startDate = new Date(1970,0,1), endDate = new Date(2099,11,31,23,59,59);
    if(period==='month'){ startDate = new Date(y,m,1,0,0,0); endDate = new Date(y,m+1,0,23,59,59); }
    if(period==='week'){ const today = new Date(); const day = today.getDay()||7; startDate = new Date(today.getFullYear(), today.getMonth(), today.getDate()-(day-1),0,0,0); endDate = new Date(startDate.getFullYear(), startDate.getMonth(), startDate.getDate()+6,23,59,59); }
    if(period==='year'){ startDate = new Date(y,0,1,0,0,0); endDate = new Date(y,11,31,23,59,59); }
    const includeReturns = $('advIncludeReturns').checked;

    // collect groups in range
    const groupsInRange = ordersGroupsAll.filter(g=>{
      const d = g.date?.toDate?g.date.toDate(): new Date(g.date || Date.now());
      return d >= startDate && d <= endDate;
    });

    // revenue / costs by label
    const labelsMap = new Map();
    const labelFor = dt=>{
      if(period==='week' || period==='month') return `${String(dt.getDate()).padStart(2,'0')}.${String(dt.getMonth()+1).padStart(2,'0')}`;
      if(period==='year') return `${String(dt.getMonth()+1).padStart(2,'0')}`;
      return `${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,'0')}`;
    };

    // init
    for(const g of groupsInRange){
      const d = g.date?.toDate?g.date.toDate(): new Date(g.date || Date.now());
      const lb = labelFor(d);
      if(!labelsMap.has(lb)) labelsMap.set(lb,{revenue:0,costs:0,count:0});
      if(g.status !== 'ZWROT' || includeReturns) labelsMap.get(lb).revenue += Number(g.total||0);
      labelsMap.get(lb).count += 1;
    }

    // include expenses by label
    const expensesInRange = expensesList.filter(e=>{
      const d = e.date?.toDate?e.date.toDate(): new Date(e.date);
      return d >= startDate && d <= endDate;
    });
    for(const e of expensesInRange){
      const d = e.date?.toDate?e.date.toDate(): new Date(e.date);
      const lb = labelFor(d);
      if(!labelsMap.has(lb)) labelsMap.set(lb,{revenue:0,costs:0,count:0});
      labelsMap.get(lb).costs += Number(e.amount || 0);
    }

    const labels = Array.from(labelsMap.keys()).sort((a,b)=>{
      const na = Number(a.replace(/\D/g,''))||0, nb = Number(b.replace(/\D/g,''))||0;
      return na - nb;
    });
    const revArr = labels.map(l=>labelsMap.get(l).revenue || 0);
    const costArr = labels.map(l=>labelsMap.get(l).costs || 0);
    const netArr = revArr.map((v,i)=> v - (costArr[i]||0));
    const ordersCountArr = labels.map(l=>labelsMap.get(l).count || 0);

    // update kpis
    const totalRevenue = revArr.reduce((s,v)=>s+v,0);
    const totalCosts = costArr.reduce((s,v)=>s+v,0);
    const totalNet = totalRevenue - totalCosts;
    $('advRevenue').textContent = fmt2(totalRevenue);
    $('advCosts').textContent = fmt2(totalCosts);
    $('advNet').textContent = fmt2(totalNet);

    const ordersCount = groupsInRange.filter(g=> includeReturns ? true : g.status !== 'ZWROT').length || 1;
    $('advAOV').textContent = fmt2(totalRevenue / ordersCount);

    const returnsCount = ordersGroupsAll.filter(g=>{
      const d = g.date?.toDate?g.date.toDate(): new Date(g.date || Date.now());
      return d >= startDate && d <= endDate && g.status === 'ZWROT';
    }).length;
    const returnsPct = Math.round((returnsCount / (groupsInRange.length || 1)) * 100);
    $('advReturnsPct').textContent = returnsPct + '%';

    // margin
    const marginArr = labels.map((l,i)=>{
      const rev = revArr[i] || 0; const c = costArr[i] || 0;
      return rev === 0 ? 0 : Math.max(0, ((rev - c) / rev) * 100);
    });
    $('advAvgMargin').textContent = (marginArr.length ? Math.round(marginArr.reduce((s,v)=>s+v,0)/marginArr.length) : 0) + '%';

    // update charts
    if(charts.finances){ charts.finances.data.labels = labels; charts.finances.data.datasets[0].data = revArr; charts.finances.data.datasets[1].data = costArr; charts.finances.data.datasets[2].data = netArr; charts.finances.update(); }
    if(charts.orders){ charts.orders.data.labels = labels; charts.orders.data.datasets[0].data = ordersCountArr; charts.orders.update(); }
    if(charts.costBreakdown){
      const buckets = {};
      for(const e of expensesInRange){
        const name = (e.name||'').toLowerCase();
        let cat='Inne';
        if(/koszulk|materi|t-shirt|shirt/.test(name)) cat='Materiały';
        else if(/druk|sitodruk/.test(name)) cat='Druk';
        else if(/wysył|paczka|kurier/.test(name)) cat='Wysyłka';
        else if(/reklam|facebook|google|ads|marketing/.test(name)) cat='Marketing';
        buckets[cat] = (buckets[cat]||0) + Number(e.amount||0);
      }
      charts.costBreakdown.data.labels = Object.keys(buckets);
      charts.costBreakdown.data.datasets[0].data = Object.values(buckets);
      charts.costBreakdown.update();
    }
    if(charts.topDesigns){
      const designCounts = {};
      for(const g of ordersGroupsAll){
        const d = g.date?.toDate?g.date.toDate(): new Date(g.date || Date.now());
        if(d < startDate || d > endDate) continue;
        if(!includeReturns && g.status === 'ZWROT') continue;
        for(const it of g.items){ const id = it.designId || 'custom'; designCounts[id] = (designCounts[id]||0) + 1; }
      }
      const arr = Object.entries(designCounts).map(([id,c])=>({ id, name: designMap.get(id)?.name || (id==='custom'?'CUSTOM':id), count:c })).sort((a,b)=>b.count-a.count).slice(0,10);
      charts.topDesigns.data.labels = arr.map(x=>x.name); charts.topDesigns.data.datasets[0].data = arr.map(x=>x.count); charts.topDesigns.update();
      // fill top designs table
      const tb = $('advTopDesignsTbody'); tb.innerHTML=''; arr.forEach(a=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${(a.name||'').replace(/</g,'&lt;')}</td><td>${a.count}</td>`; tb.appendChild(tr); });
    }

    if(charts.margin){ charts.margin.data.labels = labels; charts.margin.data.datasets[0].data = marginArr; charts.margin.update(); }
    if(charts.cumNet){ let acc=0; const cum = netArr.map(v=> acc += v); charts.cumNet.data.labels = labels; charts.cumNet.data.datasets[0].data = cum; charts.cumNet.update(); }

    // sizes
    const sizeMap = {};
    for(const g of ordersGroupsAll){
      const gd = g.date?.toDate?g.date.toDate(): new Date(g.date || Date.now());
      if(gd < startDate || gd > endDate) continue;
      if(!($('sizeIncludeReturns').checked) && g.status === 'ZWROT') continue;
      for(const it of g.items){
        const sz = it.size || 'UNKNOWN';
        sizeMap[sz] = (sizeMap[sz]||0) + 1;
      }
    }
    const sizeLabels = Object.keys(sizeMap).sort(); const sizeData = sizeLabels.map(l=>sizeMap[l]);
    if(charts.sizes){ charts.sizes.data.labels = sizeLabels; charts.sizes.data.datasets[0].data = sizeData; charts.sizes.update(); }

    // size table
    const tsz = $('advSizeTbody'); tsz.innerHTML = '';
    for(const s of sizeLabels){ const tr=document.createElement('tr'); tr.innerHTML = `<td>-</td><td>${s}</td><td>${sizeMap[s]}</td>`; tsz.appendChild(tr); }

    // adv detail
    const tbody = $('advDetailTbody'); tbody.innerHTML = '';
    tbody.appendChild(trRow('Przychód (sumarycznie)', fmt2(totalRevenue)+' zł'));
    tbody.appendChild(trRow('Koszty (sumarycznie)', fmt2(totalCosts)+' zł'));
    tbody.appendChild(trRow('Zysk netto', fmt2(totalNet)+' zł'));
    tbody.appendChild(trRow('AOV', fmt2(totalRevenue / ordersCount)+' zł'));
    tbody.appendChild(trRow('Udział zwrotów', returnsPct + ' %'));
  }

  function trRow(k,v){ const tr=document.createElement('tr'); tr.innerHTML = `<td>Finanse</td><td>${k}</td><td>${v}</td>`; return tr; }

  // --- utility and bootstrap ---
  (function defaults(){
    const now = new Date();
    if($('advMonth')) $('advMonth').value = String(now.getMonth());
    if($('advYear')) $('advYear').value = String(now.getFullYear());
    if($('ordersMonth')) $('ordersMonth').value = String(now.getMonth());
    if($('ordersYear')) $('ordersYear').value = String(now.getFullYear());
  })();

  // start listeners when user logged in (onAuthStateChanged does this)
  // note: startListeners() called after onAuthStateChanged when logged

  // expose helper for debug
  window.renderAdvancedStats = renderAdvancedStats;

</script>
</body>
</html>
